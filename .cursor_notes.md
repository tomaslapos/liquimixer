# LiquiMixer - Pozn√°mky pro AI asistenta

## ‚ö†Ô∏è KRITICK√Å PRAVIDLA - P≈òEƒåTI P≈òED KA≈ΩDOU PRAC√ç!

### 1. NIKDY NEPOU≈†TƒöT POWERSHELL PRO EDITACI SOUBOR≈Æ!

**Proƒç:**
- PowerShell na Windows m√° fat√°ln√≠ probl√©my s UTF-8 k√≥dov√°n√≠m
- Cesta `C:\Users\Tom√°≈°Lapos` se rozpadne na `C:\Users\TomÔøΩÔøΩÔøΩLapos`
- ƒåesk√© znaky se zniƒç√≠: `≈Ω√°dn√°` ‚Üí `‚îº≈ª‚îú√≠dn‚îú√≠`, `p≈ô√≠chu≈•` ‚Üí `p‚îº√ñ‚îú≈üchu‚îºƒÖ`
- Emoji se rozpadnou: `üë§` ‚Üí `¬≠ƒçƒπƒÑ`, `‚òÖ` ‚Üí `√î≈õ≈Ø`, `üóëÔ∏è` ‚Üí `√î≈•ƒΩ`

**Co se stalo v minulosti:**
- Dne 7.1.2026 byl cel√Ω `app.js` po≈°kozen PowerShell p≈ô√≠kazy
- Muselo se ruƒçnƒõ opravovat stovky ≈ô√°dk≈Ø s po≈°kozen√Ωmi znaky
- U≈æivatel explicitnƒõ zak√°zal pou≈æ√≠vat PowerShell

**Jak spr√°vnƒõ:**
- Pro editaci soubor≈Ø: V√ùHRADNƒö n√°stroje Cursor (`search_replace`, `write`, `read_file`)
- Pro Git operace: `cmd /c "git add -A && git commit -m 'message' && git push"`
- Pro kop√≠rov√°n√≠ soubor≈Ø: `cmd /c "robocopy source dest /E"` s kr√°tkou cestou `TOMLAP~1`
- Kr√°tk√° cesta u≈æivatele: `C:\Users\TOMLAP~1\Liquimixer`

**ZAK√ÅZAN√â p≈ô√≠kazy:**
```
‚ùå Set-Content, Add-Content, Out-File
‚ùå [System.IO.File]::WriteAllText()
‚ùå (Get-Content file) -replace
‚ùå jak√Ωkoliv PowerShell p≈ô√≠kaz co zapisuje do souboru
```

### 2. P≈òEKLADY NEDƒöLAT SKRIPTEM!

**Proƒç:**
- Automatick√© skripty (generate-locales.js, complete-translations.js) NEFUNGUJ√ç
- Generuj√≠ neplatn√Ω JSON nebo chybn√© p≈ôeklady
- U≈æivatel to explicitnƒõ zak√°zal po opakovan√Ωch selh√°n√≠ch

**Jak spr√°vnƒõ p≈ôid√°vat p≈ôeklady:**

1. **Referenƒçn√≠ soubor:** `locales/cs.json` - V≈ΩDY porovn√°vat s t√≠mto
2. **Postup pro nov√Ω kl√≠ƒç:**
   - Naj√≠t v `cs.json` kde kl√≠ƒç pat≈ô√≠ (nap≈ô. sekce `save_recipe`, `reminder`, `recipe_detail`)
   - Otev≈ô√≠t JEDEN jazykov√Ω soubor (nap≈ô. `de.json`)
   - P≈ôidat kl√≠ƒç s p≈ôelo≈æen√Ωm textem
   - Opakovat pro dal≈°√≠ jazyky POSTUPNƒö
3. **Kontrola JSON syntaxe:** Po ka≈æd√© √∫pravƒõ ovƒõ≈ôit validitu JSON

**Struktura kl√≠ƒç≈Ø:**
```json
{
  "meta": { "code": "cs", "name": "ƒåe≈°tina" },
  "nav": { "home": "Dom≈Ø", "menu": "Menu" },
  "auth": { "login": "P≈ôihl√°sit", "logout": "Odhl√°sit" },
  "form": { "amount": "Mno≈æstv√≠", "ratio": "Pomƒõr" },
  "results": { "title": "V√Ωsledky", "total": "Celkem" },
  "save_recipe": { "title": "Ulo≈æit recept", "save_button": "Ulo≈æit" },
  "reminder": { "add_title": "P≈ôidat p≈ôipom√≠nku", "mixed_on": "Nam√≠ch√°no" },
  "recipe_detail": { "reminders_title": "P≈ôipom√≠nky zr√°n√≠" },
  "common": { "save": "Ulo≈æit", "cancel": "Zru≈°it", "delete": "Smazat" }
}
```

**31 podporovan√Ωch jazyk≈Ø:**
cs, en, de, fr, es, it, pl, ru, pt, nl, ja, ko, zh-CN, zh-TW, ar-SA, 
sv, da, fi, no, hr, sr, bg, ro, lt, lv, et, hu, el, uk, sk, tr

### 3. NAHR√ÅV√ÅN√ç NA GITHUB

**PRAVIDLO:** Nahr√°vat POUZE po testov√°n√≠ a schv√°len√≠ u≈æivatelem!

**Postup:**
1. Udƒõlat zmƒõny pomoc√≠ n√°stroj≈Ø Cursor
2. Informovat u≈æivatele co bylo zmƒõnƒõno
3. POƒåKAT na testov√°n√≠ u≈æivatelem
4. POƒåKAT na schv√°len√≠ ("nahraj na GitHub")
5. Teprve pak: `git add -A`, `git commit`, `git push`

**Git p≈ô√≠kazy (p≈ôes cmd):**
```bash
cmd /c "cd C:\Users\TOMLAP~1\Liquimixer && git status"
cmd /c "cd C:\Users\TOMLAP~1\Liquimixer && git add -A"
cmd /c "cd C:\Users\TOMLAP~1\Liquimixer && git commit -m popis-zmeny"
cmd /c "cd C:\Users\TOMLAP~1\Liquimixer && git push origin main"
```

**POZOR - Escapov√°n√≠ v commit message:**
- PowerShell m√° probl√©my s uvozovkami a speci√°ln√≠mi znaky
- Nejbezpeƒçnƒõj≈°√≠ je commit message BEZ mezer a speci√°ln√≠ch znak≈Ø
- P≈ô√≠klad: `git commit -m fix-idoklad-jwt-verification`
- NEFUNGUJE: `git commit -m "Fix: Add verify_jwt=false"` (rozpadne se na v√≠ce argument≈Ø)

**POZOR:** Branch je `main`, NE `master`!

### 4. P≈òED KA≈ΩDOU ZMƒöNOU

**Pravidla:**
1. **Nastudovat k√≥d** p≈ôed editac√≠ - pochopit jak funguje
2. **Mal√© zmƒõny** - nedƒõlat velk√© refaktoringy bez vy≈æ√°d√°n√≠
3. **Testovat lok√°lnƒõ** - u≈æivatel m√° Live Server na `http://127.0.0.1:5500`
4. **Konzistence** - pou≈æ√≠vat stejn√© vzory jako existuj√≠c√≠ k√≥d

### 5. Z√ÅLOHOV√ÅN√ç

**P≈ôed velk√Ωmi zmƒõnami vytvo≈ôit z√°lohu:**
```bash
cmd /c "robocopy C:\Users\TOMLAP~1\Liquimixer C:\Users\TOMLAP~1\Liquimixer_backup_DATUM /E /XD node_modules .git"
```

**Z√°lohy jsou v:** `C:\Users\Tom√°≈°Lapos\Liquimixer_backup_*`

---

## üìÅ STRUKTURA PROJEKTU

### Hlavn√≠ soubory

| Soubor | Velikost | Popis |
|--------|----------|-------|
| `index.html` | ~123KB | Hlavn√≠ HTML, v≈°echny mod√°ly, struktura UI |
| `app.js` | ~230KB, ~6000 ≈ô√°dk≈Ø | Ve≈°ker√° aplikaƒçn√≠ logika |
| `styles.css` | ~107KB | Ve≈°ker√© CSS styly, animace |
| `i18n.js` | ~19KB | Internacionalizace, spr√°va jazyk≈Ø |
| `database.js` | ~36KB | Supabase operace (CRUD) |
| `subscription.js` | ~21KB | P≈ôedplatn√©, platby, billing |
| `fcm.js` | ~8KB | Firebase Cloud Messaging |

### Jak je app.js organizov√°n (~6000 ≈ô√°dk≈Ø):

```
≈ò√°dky 1-50:      Bezpeƒçnostn√≠ funkce (escapeHtml, sanitizeUrl)
≈ò√°dky 50-200:    flavorDatabase - typy p≈ô√≠chut√≠ a steeping ƒçasy
≈ò√°dky 200-500:   Inicializace, autentizace (Clerk)
≈ò√°dky 500-1000:  UI funkce (showPage, navigace, mod√°ly)
≈ò√°dky 1000-1500: Ukl√°d√°n√≠ recept≈Ø, produkty
≈ò√°dky 1500-2000: Editace recept≈Ø, zobrazen√≠ detailu
≈ò√°dky 2000-3000: V√Ωpoƒçetn√≠ funkce (calculateMix, calculateProMix)
≈ò√°dky 3000-4000: Liquid PRO multi-flavor logika
≈ò√°dky 4000-5000: V√Ωsledky, tabulky, zobrazen√≠
≈ò√°dky 5000-5500: P≈ôipom√≠nky zr√°n√≠ (reminders)
≈ò√°dky 5500-6000: Kontakt, menu, pomocn√© funkce
≈ò√°dky 6000+:     window.* exporty pro glob√°ln√≠ p≈ô√≠stup
```

### P≈ôeklady - D≈ÆLE≈ΩIT√â

**Um√≠stƒõn√≠:** `locales/` slo≈æka

**Referenƒçn√≠ soubor:** `locales/cs.json` - V≈ΩDY porovn√°vat s t√≠mto!

**Pou≈æit√≠ v HTML:**
```html
<span data-i18n="section.key">Fallback text</span>
<input data-i18n-placeholder="section.key" placeholder="Fallback">
<button data-i18n-title="section.key" title="Fallback">
```

**Pou≈æit√≠ v JS:**
```javascript
const text = t('section.key', 'Fallback text');
// Po dynamick√©m renderov√°n√≠:
window.i18n.applyTranslations();
```

**Hlavn√≠ sekce v JSON:**
- `meta` - k√≥d jazyka, n√°zev
- `nav` - navigace (home, menu, account)
- `auth` - p≈ôihl√°≈°en√≠, profil
- `form` - formul√°≈ôov√© popisky
- `results` - v√Ωsledky v√Ωpoƒçtu
- `save_recipe` - ukl√°d√°n√≠ receptu
- `reminder` - p≈ôipom√≠nky zr√°n√≠
- `recipe_detail` - detail receptu
- `common` - obecn√© (save, cancel, delete, day/days)

### Grafika a ikony
```
icons/
‚îú‚îÄ‚îÄ icon-192.png      # PWA ikona mal√°
‚îú‚îÄ‚îÄ icon-512.png      # PWA ikona velk√°  
‚îú‚îÄ‚îÄ icon.svg          # Zdrojov√© SVG
‚îú‚îÄ‚îÄ og-image.png      # Open Graph (1200x630px) - POVINN√ù FORM√ÅT!
‚îî‚îÄ‚îÄ og-image.svg      # Zdrojov√© SVG pro OG
```

### Supabase Backend

**Edge funkce:** `supabase/functions/`

| Funkce | √öƒçel | Vol√° se z | verify_jwt |
|--------|------|-----------|------------|
| `billing/` | Fakturace | Frontend | true |
| `contact/` | Kontaktn√≠ formul√°≈ô | Frontend | true |
| `geolocation/` | Geolokace u≈æivatele | Frontend | true |
| `gpwebpay/` | Platebn√≠ br√°na callback | GP WebPay (extern√≠) | **false** |
| `idoklad/` | iDoklad integrace | gpwebpay (intern√≠) | **false** |
| `invoice/` | Generov√°n√≠ faktur | Frontend + gpwebpay | true |
| `refund/` | Refundace | Frontend | true |
| `reminder-notify/` | Notifikace (CRON) | pg_cron | true |
| `subscription/` | P≈ôedplatn√© | Frontend | true |
| `user-cleanup/` | Maz√°n√≠ √∫ƒçt≈Ø (CRON) | pg_cron | true |

**D≈ÆLE≈ΩIT√â - verify_jwt konfigurace v `supabase/config.toml`:**
```toml
[functions.gpwebpay]
verify_jwt = false  # GP WebPay pos√≠l√° callback bez Authorization headeru

[functions.idoklad]
verify_jwt = false  # Vol√°no z gpwebpay pomoc√≠ service_role_key
```

**Architektura vol√°n√≠ p≈ôi platbƒõ:**
```
U≈æivatel ‚Üí Frontend ‚Üí subscription (vytvo≈ô√≠ subscription)
         ‚Üí Frontend ‚Üí gpwebpay (z√≠sk√° payment URL)
         ‚Üí U≈æivatel p≈ôesmƒõrov√°n na GP WebPay
         ‚Üí GP WebPay callback ‚Üí gpwebpay funkce
                              ‚Üí gpwebpay vol√° idoklad (intern√≠ HTTP fetch)
                              ‚Üí idoklad vytvo≈ô√≠ fakturu v iDoklad API
                              ‚Üí idoklad ulo≈æ√≠ do DB
                              ‚Üí gpwebpay vol√° invoice (email)
```

**Datab√°zov√© tabulky:**
| Tabulka | √öƒçel | Kl√≠ƒçov√© sloupce |
|---------|------|-----------------|
| `recipes` | Ulo≈æen√© recepty | id, clerk_id, name, recipe_data |
| `products` | Obl√≠ben√© produkty | id, clerk_id, name, url |
| `reminders` | P≈ôipom√≠nky zr√°n√≠ | id, recipe_id, remind_at, mixed_at |
| `subscriptions` | P≈ôedplatn√© | id, clerk_id, status, expires_at, user_country |
| `invoices` | Faktury | id, clerk_id, idoklad_id, amount, currency |
| `payments` | Platby | id, clerk_id, order_number, status |
| `users` | U≈æivatel√© | clerk_id, email, locale, subscription_status |
| `user_settings` | Nastaven√≠ | clerk_id, language, theme |

---

## üé® GRAFIKA A STYLING

### Barevn√© sch√©ma (CSS promƒõnn√© v styles.css)
```css
--neon-cyan: #00ffff;      /* Prim√°rn√≠ - tlaƒç√≠tka, odkazy */
--neon-pink: #ff00ff;      /* Sekund√°rn√≠ - akcenty, login */
--neon-green: #00ff00;     /* Sekce "P≈ôed m√≠ch√°n√≠m" */
--neon-purple: #bb86fc;    /* √övodn√≠ text, info boxy */
--bg-dark: #0a0a0a;        /* Tmav√© pozad√≠ */
--bg-card: #1a1a2e;        /* Karty, mod√°ly */
```

### Tlaƒç√≠tka - typy a pou≈æit√≠

| T≈ô√≠da | Pou≈æit√≠ | Barva |
|-------|---------|-------|
| `.neon-button` | Hlavn√≠ akce (Vypoƒç√≠tat, Ulo≈æit) | Cyan |
| `.neon-button.secondary` | Sekund√°rn√≠ akce | Pink |
| `.neon-button.btn-green` | Potvrzen√≠ | Zelen√° |
| `.neon-button.btn-red` | Smazat, Zru≈°it | ƒåerven√° |
| `.mode-button.cyan` | eLiquid kalkul√°tor | Cyan s pulzuj√≠c√≠m textem |
| `.mode-button.pink` | ≈òedƒõn√≠ nikotinu | Pink s pulzuj√≠c√≠m textem |
| `.nav-btn` | Navigace (Dom≈Ø, Menu) | Cyan border |
| `.nav-btn.login-btn` | M≈Øj √∫ƒçet | Pink border a pulz |

### Animace

**Pulzuj√≠c√≠ text (mode-button):**
```css
@keyframes textGlowWave { /* v styles.css */ }
/* Aplikuje se na .mode-button .mode-title .char */
/* Ka≈æd√Ω znak m√° animation-delay pro vlnov√Ω efekt */
```

**Pulzuj√≠c√≠ border (ostatn√≠ tlaƒç√≠tka):**
```css
@keyframes border-pulse-sweep { /* v styles.css */ }
/* Aplikuje se p≈ôes ::after pseudo-element */
/* Gradient bƒõ≈æ√≠ zleva doprava */
```

**D≈ÆLE≈ΩIT√â:** Po zmƒõnƒõ jazyka se mus√≠ znovu inicializovat animace textu:
```javascript
// V index.html je window.animateModeButtons()
// Vol√° se p≈ôi DOMContentLoaded a localeChanged
```

### Sekce s or√°mov√°n√≠m

| T≈ô√≠da | Obsah | Barva or√°mov√°n√≠ |
|-------|-------|-----------------|
| `.app-description-box` | √övodn√≠ popis aplikace | Fialov√° (#bb86fc) |
| `.prep-box` | "P≈ôed m√≠ch√°n√≠m si p≈ôipravte" | Neon zelen√° |
| `.disclaimer-box` | Upozornƒõn√≠ | ≈Ωlut√°/oran≈æov√° |
| `.results-container` | V√Ωsledky v√Ωpoƒçtu | Cyan gradient |

### Mod√°ly (v index.html)

| ID | √öƒçel | Otev√≠r√° funkce |
|----|------|----------------|
| `#saveRecipeModal` | Nov√Ω recept | `showSaveRecipeModal()` |
| `#editRecipeModal` | √öprava receptu | `showEditRecipeForm()` |
| `#addReminderModal` | Nov√° p≈ôipom√≠nka | `showAddReminderModal(recipeId)` |
| `#editReminderModal` | √öprava p≈ôipom√≠nky | `showEditReminderModal(id, recipeId)` |
| `#userProfileModal` | U≈æivatelsk√Ω profil | `showUserProfileModal()` |
| `#menuModal` | Hlavn√≠ menu | `showMenuModal()` |
| `#loginRequiredModal` | V√Ωzva k p≈ôihl√°≈°en√≠ | `showLoginRequiredModal()` |

### Tabulka v√Ωsledk≈Ø (konzistentn√≠ styling)

**D≈ÆLE≈ΩIT√â:** P≈ôi zobrazen√≠ receptu pou≈æ√≠t stejn√© t≈ô√≠dy jako p≈ôi v√Ωpoƒçtu!

```html
<div class="results-table-container">
  <table class="results-table">
    <tr>
      <td class="ingredient-name">N√°zev</td>
      <td class="ingredient-value">10.5 ml</td>
      <td class="ingredient-percent">21%</td>
      <td class="ingredient-drops">105</td>
    </tr>
  </table>
</div>
```

T≈ô√≠dy definov√°ny v `styles.css` sekce `/* Results table */`

---

## üîß KL√çƒåOV√â FUNKCE

### Kalkulace e-liquidu

```javascript
// Z√°kladn√≠ kalkul√°tor (jedna p≈ô√≠chu≈•)
calculateMix() 
// - ƒåte hodnoty z formul√°≈ôe #mixerForm
// - Vol√° displayResults(data, {formType: 'eliquid', flavorType: selectedFlavor})

// Shake & Vape (bez nikotinu, rychl√©)
calculateShakeVape()
// - Formul√°≈ô #shakevapeForm
// - Vol√° displayResults(data, {formType: 'shakevape', flavorType: 'fruit'})

// Liquid PRO (v√≠ce p≈ô√≠chut√≠)
calculateProMix()
// - Formul√°≈ô #proMixerForm
// - Podporuje a≈æ 5 p≈ô√≠chut√≠ s vlastn√≠mi %
// - Vol√° displayResults(data, {formType: 'liquidpro', flavors: flavorsData})
```

**D≈ÆLE≈ΩIT√â pro p≈ôipom√≠nky:** `displayResults` ukl√°d√° `flavorType` do `currentRecipeData` pro v√Ωpoƒçet steeping ƒçasu!

### Zobrazen√≠ v√Ωsledk≈Ø

```javascript
displayResults(data, extraData)
// - data: { vg, pg, nic, flavor, total, drops, ... }
// - extraData: { formType, flavorType, flavors }
// - Ukl√°d√° do window.currentRecipeData pro pozdƒõj≈°√≠ ulo≈æen√≠
// - Renderuje HTML do #resultsContent

refreshResultsTable()
// - Vol√° se p≈ôi zmƒõnƒõ jazyka (event localeChanged)
// - P≈ôerenderuje v√Ωsledky se spr√°vn√Ωmi p≈ôeklady
```

### Recepty - ukl√°d√°n√≠ a zobrazen√≠

```javascript
// Otev≈ô√≠t modal pro NOV√ù recept
showSaveRecipeModal()
// - Resetuje formul√°≈ô
// - Nastav√≠ tlaƒç√≠tko na t('save_recipe.save_button')
// - Inicializuje p≈ôipom√≠nku (za≈°krtnutou)

// Otev≈ô√≠t modal pro √öPRAVU
showEditRecipeForm()
// - Vypln√≠ formul√°≈ô daty z currentViewingRecipe
// - Zmƒõn√≠ tlaƒç√≠tko na t('save_recipe.save_changes')
// - Zmƒõn√≠ nadpis na t('save_recipe.edit_title')

// Ulo≈æit recept do Supabase
saveRecipe()
// - Validuje formul√°≈ô
// - Ukl√°d√° recipe_data vƒçetnƒõ flavorType!
// - Volitelnƒõ vytvo≈ô√≠ p≈ôipom√≠nku

// Zobrazit detail receptu
viewRecipeDetail(recipeId)
// - Naƒçte recept z DB
// - Nastav√≠ window.currentViewingRecipe (D≈ÆLE≈ΩIT√â!)
// - Vol√° displayRecipeDetail()
// - Po renderov√°n√≠ vol√° loadRecipeReminders()

// Renderovat HTML detailu
displayRecipeDetail(recipe, contentId)
// - contentId: 'recipeDetailContent' nebo 'favoriteRecipeDetailContent'
// - MUS√ç pou≈æ√≠t stejn√© CSS t≈ô√≠dy jako displayResults()!
```

### P≈ôipom√≠nky zr√°n√≠ (reminders)

```javascript
// Otev≈ô√≠t modal pro novou p≈ôipom√≠nku
showAddReminderModal(recipeId)
// - Hled√° flavorType v recipe.recipe_data.flavorType
// - Fallback: hled√° v recipe.recipe_data.ingredients
// - Nastav√≠ currentReminderSteepingDays podle flavorDatabase

// Automaticky vypoƒç√≠tat datum p≈ôipom√≠nky
updateReminderDate()
// - Bere datum m√≠ch√°n√≠ z #reminderMixDate
// - P≈ôiƒçte currentReminderSteepingDays
// - Nastav√≠ #reminderRemindDate

// Naƒç√≠st p≈ôipom√≠nky pro recept
loadRecipeReminders(recipeId, showAll = false)
// - ≈òad√≠ od NEJNOVƒöJ≈†√çCH (nejvy≈°≈°√≠ remind_at naho≈ôe)
// - Zobrazuje max 3, pak "Zobrazit v≈°echny"

// Renderovat jednu p≈ôipom√≠nku
renderReminderItem(reminder, recipeId)
// - Pou≈æ√≠v√° t() pro p≈ôeklady
// - Form√°tuje datum podle aktu√°ln√≠ho locale
```

### P≈ôeklady - i18n syst√©m

```javascript
// Z√≠skat p≈ôeklad
t(key, fallback)
// P≈ô√≠klad: t('save_recipe.title', 'Ulo≈æit recept')

// Aplikovat p≈ôeklady na DOM elementy
window.i18n.applyTranslations()
// - Hled√° [data-i18n], [data-i18n-placeholder], [data-i18n-title]
// - VOLAT PO KA≈ΩD√âM DYNAMICK√âM RENDEROV√ÅN√ç!

// Zmƒõnit jazyk
window.i18n.setLocale(localeCode)
// - Naƒçte JSON soubor
// - Ulo≈æ√≠ preference do DB (pokud p≈ôihl√°≈°en)
// - Dispatchne event 'localeChanged'

// Event p≈ôi zmƒõnƒõ jazyka
window.addEventListener('localeChanged', () => {
    refreshResultsTable();      // P≈ôerenderovat v√Ωsledky
    refreshRecipeDetail();      // P≈ôerenderovat detail receptu
    window.animateModeButtons(); // Znovu animovat tlaƒç√≠tka
});
```

### Datab√°ze p≈ô√≠chut√≠ (flavorDatabase)

```javascript
// Definov√°no na zaƒç√°tku app.js (~≈ô√°dky 50-170)
const flavorDatabase = [
    { value: 'none', name: '≈Ω√°dn√°', steepingDays: 0 },
    { value: 'fruit', name: 'Ovocn√°', steepingDays: 3 },
    { value: 'citrus', name: 'Citrusov√°', steepingDays: 3 },
    { value: 'menthol', name: 'Mentolov√°', steepingDays: 1 },
    { value: 'mint', name: 'M√°tov√°', steepingDays: 2 },
    { value: 'cream', name: 'Kr√©mov√°', steepingDays: 7 },
    { value: 'custard', name: 'Pudink', steepingDays: 14 },
    { value: 'dessert', name: 'Dezertn√≠', steepingDays: 7 },
    { value: 'bakery', name: 'Peƒçivo', steepingDays: 10 },
    { value: 'tobacco', name: 'Tab√°kov√°', steepingDays: 21 },
    { value: 'beverage', name: 'N√°pojov√°', steepingDays: 5 },
    { value: 'candy', name: 'Bonb√≥nov√°', steepingDays: 4 },
    { value: 'nut', name: 'O≈ô√≠≈°kov√°', steepingDays: 10 },
    { value: 'spice', name: 'Ko≈ôenƒõn√°', steepingDays: 14 },
    { value: 'floral', name: 'Kvƒõtinov√°', steepingDays: 7 }
];

// P≈ôi v√≠ce p≈ô√≠chut√≠ch (Liquid PRO): pou≈æ√≠t NEJDEL≈†√ç steeping ƒças!
```

### Glob√°ln√≠ promƒõnn√© (window.*)

```javascript
window.currentRecipeData     // Aktu√°ln√≠ vypoƒç√≠tan√Ω recept
window.currentViewingRecipe  // Aktu√°lnƒõ zobrazen√Ω ulo≈æen√Ω recept
window.i18n                  // i18n objekt
window.LiquiMixerDB          // Datab√°zov√© operace
window.Clerk                 // Autentizace

// Exportovan√© funkce (na konci app.js)
window.calculateMixture = calculateMix;
window.showSaveRecipeModal = showSaveRecipeModal;
window.viewRecipeDetail = viewRecipeDetail;
window.showAddReminderModal = showAddReminderModal;
// ... a dal≈°√≠
```

---

## üì± PWA & NOTIFIKACE

- `manifest.json` - PWA manifest
- `sw.js` - Service Worker pro offline
- `firebase-messaging-sw.js` - Firebase Cloud Messaging
- `fcm.js` - FCM client-side logika

---

## üöÄ DEPLOYMENT

### Frontend (Zeabur)
- Hosting: Zeabur (automatick√Ω deploy z GitHub)
- Branch: `main`
- Konfigurace: `zeabur.json`
- URL: https://liquimixer.zeabur.app a https://www.liquimixer.com

### Supabase Edge Functions

**Nasazen√≠ jedn√© funkce:**
```bash
npx supabase functions deploy idoklad --project-ref krwdfxnvhnxtkhtkbadi
```

**Nasazen√≠ v≈°ech funkc√≠:**
```bash
npx supabase functions deploy --project-ref krwdfxnvhnxtkhtkbadi
```

**D≈ÆLE≈ΩIT√â:**
- `config.toml` se aplikuje p≈ôi nasazen√≠ funkc√≠
- Po zmƒõnƒõ `verify_jwt` v config.toml je nutn√© znovu nasadit dotƒçen√© funkce
- Project ref: `krwdfxnvhnxtkhtkbadi`

**Logy funkc√≠:**
- Dashboard: https://supabase.com/dashboard/project/krwdfxnvhnxtkhtkbadi/functions
- Kliknout na funkci ‚Üí Logs

**Testov√°n√≠ lok√°lnƒõ (nedoporuƒçeno pro tento projekt):**
- Edge funkce nelze plnƒõ testovat lok√°lnƒõ kv≈Øli secrets a extern√≠m API
- Pro testov√°n√≠ pou≈æ√≠t produkƒçn√≠ deploy a sledovat logy

### SQL Migrace

**Spu≈°tƒõn√≠ migrace:**
```bash
npx supabase db push --project-ref krwdfxnvhnxtkhtkbadi
```

**Nebo manu√°lnƒõ v SQL Editoru:**
- Dashboard ‚Üí SQL Editor ‚Üí New Query ‚Üí vlo≈æit SQL ‚Üí Run

---

## üìù ƒåAST√â PROBL√âMY A ≈òE≈†EN√ç

### P≈ôeklady se nenaƒç√≠taj√≠
1. Zkontrolovat JSON syntax v jazykov√©m souboru
2. Zkontrolovat zda kl√≠ƒç existuje v dan√©m souboru
3. Zkontrolovat zda se vol√° `applyTranslations()` po zmƒõnƒõ obsahu

### Tlaƒç√≠tka/texty se nep≈ôekl√°daj√≠
1. Hardcoded text v JS ‚Üí zmƒõnit na `t('key', 'fallback')`
2. Chybƒõj√≠c√≠ `data-i18n` atribut v HTML
3. Dynamicky generovan√Ω obsah ‚Üí volat `applyTranslations()` po renderov√°n√≠

### Grafika receptu se nezobrazuje
1. Zkontrolovat CSS t≈ô√≠dy (`results-table-container`, `ingredient-name`, atd.)
2. Zkontrolovat zda se pou≈æ√≠v√° stejn√° struktura jako v `displayResults()`

### P≈ôipom√≠nky nefunguj√≠
1. `window.currentViewingRecipe` mus√≠ b√Ωt nastaveno
2. `flavorType` mus√≠ b√Ωt ulo≈æeno v `recipe_data`
3. Pro star≈°√≠ recepty fallback hled√° `flavorType` v `ingredients`

---

## üìÖ HISTORIE ZMƒöN A PROBL√âM≈Æ

### 13.1.2026 (odpoledne v2) - iDoklad VatRateType chyba

**Symptom:**
- `iDoklad create invoice error: {"ErrorCode":127,"Message":"VatRate 21 and VatRateType Reduced1 for dates 1/13/2026 has not been found."}`

**P≈ô√≠ƒçina:**
- Pos√≠lali jsme SOUƒåASNƒö `VatRate: 21` i `VatRateType: 0`
- iDoklad to interpretoval jako konflikt a pou≈æil v√Ωchoz√≠ VatRateType z nastaven√≠ (1 = Reduced1 = 12%)
- Kombinace VatRate: 21 + VatRateType: 1 (Reduced1 = 12%) je neplatn√°

**≈òe≈°en√≠:**
- Odstranit `VatRate` z polo≈æky faktury
- Pou≈æ√≠t POUZE `VatRateType` - iDoklad s√°m pou≈æije spr√°vnou sazbu

```typescript
Items: [{
  VatRateType: vatRate.type, // 0 = Basic (21%), 3 = Zero (0%)
  // VatRate: vatRate.rate,  // ODSTRANIT! Zp≈Øsobuje konflikt
  PriceType: 0,
}]
```

**Pouƒçen√≠:**
- V iDoklad API pou≈æ√≠vat VatRateType NEBO VatRate, NIKDY oboje souƒçasnƒõ
- VatRateType: 0 = Basic (21%), 1 = Reduced1 (12%), 3 = Zero (0%)

---

### 13.1.2026 (odpoledne) - iDoklad Edge Function nefungovala

**Symptom:**
- Po platbƒõ se v logu gpwebpay zobrazovalo: `iDoklad invoice creation failed: undefined`
- iDoklad result: `{"code":401,"message":"Inva..."}` (401 Unauthorized)
- V logu idoklad funkce NEBYLY ≈Ω√ÅDN√â z√°znamy - funkce nebyla v≈Øbec vol√°na

**P≈ô√≠ƒçina:**
- Supabase Edge Functions vy≈æaduj√≠ buƒè validn√≠ JWT token NEBO `verify_jwt = false` v `config.toml`
- V `config.toml` bylo `verify_jwt = false` nastaveno pouze pro `gpwebpay`, ale NE pro `idoklad`
- Kdy≈æ `gpwebpay` volala `idoklad` internƒõ p≈ôes HTTP fetch, Supabase odm√≠tal po≈æadavek s 401 **je≈°tƒõ p≈ôed t√≠m, ne≈æ se k√≥d funkce spustil**

**≈òe≈°en√≠ v `supabase/config.toml`:**
```toml
[functions.gpwebpay]
# Disable JWT verification for GP WebPay callback
# GP WebPay sends callbacks without Authorization header
verify_jwt = false

[functions.idoklad]
# Disable JWT verification for internal calls from gpwebpay
# gpwebpay calls idoklad using service_role_key
verify_jwt = false
```

**Debug logy p≈ôid√°ny v `supabase/functions/idoklad/index.ts`:**
```typescript
serve(async (req) => {
  console.log('=== iDoklad function called ===')
  console.log('Method:', req.method)
  console.log('URL:', req.url)
  // ...
```

**Nasazen√≠:**
1. Git push: `cmd /c "git add -A && git commit -m fix-idoklad-jwt-verification && git push origin main"`
2. Supabase deploy: `npx supabase functions deploy --project-ref krwdfxnvhnxtkhtkbadi`

**Pouƒçen√≠:**
- Kdy≈æ Edge funkce A vol√° Edge funkci B p≈ôes HTTP, funkce B tak√© pot≈ôebuje `verify_jwt = false` pokud A pou≈æ√≠v√° service_role_key
- Pokud funkce neloguje V≈ÆBEC NIC, probl√©m je na √∫rovni Supabase routingu (JWT verifikace), ne v k√≥du funkce
- V≈ædy p≈ôidat debug logy na √∫pln√Ω zaƒç√°tek `serve()` handleru pro diagnostiku

---

### 13.1.2026 (pozdƒõ veƒçer) - Opravy VAT, krajiny a jazyka v3

**Principy implementace:**
- **M√≠sto plnƒõn√≠** = krajina z√°kazn√≠ka z IP geolokace ‚Üí urƒçuje DPH a krajinu v iDoklad
- **Jazyk** = nez√°visl√Ω na m√≠stu plnƒõn√≠, vol√≠ u≈æivatel nebo se detekuje z prohl√≠≈æeƒçe

**DPH logika:**
- EU krajiny: fin√°ln√≠ cena (59 CZK/2.40 EUR/2.90 USD) JE S DPH 21%
- Mimo EU: fin√°ln√≠ cena JE BEZ DPH (0%)

**Vy≈ôe≈°en√© probl√©my:**

#### 1. Apple Pay ikona - nov√° SVG
**Probl√©m:** P≈Øvodn√≠ ikona byla neƒçiteln√°, zobrazovala "ired".

**≈òe≈°en√≠ v `index.html`:**
- Nahrazena jednoduch√° b√≠l√° Apple Pay SVG ikona s ƒçiteln√Ωm logem

#### 2. IP geolokace ‚Üí krajina fallback
**Probl√©m:** P≈ôi selh√°n√≠ geolokace se pou≈æ√≠val jazyk jako krajina (nap≈ô. 'ar-SA' ‚Üí 'AR').

**≈òe≈°en√≠ v `app.js`:**
```javascript
const localeToCountry = {
  'cs': 'CZ', 'sk': 'SK', 'de': 'DE', 'ar-SA': 'SA', ...
}
userLocation.countryCode = localeToCountry[currentLocale] || 'CZ'
```

#### 3. iDoklad VatRateType logika
**Probl√©m:** Pou≈æ√≠val se statick√Ω seznam non-EU zem√≠, kter√Ω nebyl kompletn√≠.

**≈òe≈°en√≠ v `supabase/functions/idoklad/index.ts`:**
- Zmƒõnƒõna logika: m√≠sto seznamu non-EU zem√≠ ‚Üí seznam EU zem√≠
- Pokud krajina je v EU seznamu ‚Üí 21% (type: 0 = Basic)
- Pokud krajina NEN√ç v EU ‚Üí 0% (type: 3 = Zero/osvobozeno)

#### 4. iDoklad getCountryId roz≈°√≠≈ôen
**Probl√©m:** Mapov√°n√≠ krajin na iDoklad ID bylo ne√∫pln√©.

**≈òe≈°en√≠ v `supabase/functions/idoklad/index.ts`:**
- P≈ôid√°no 30+ krajin vƒçetnƒõ v≈°ech EU + mimo EU
- Bl√≠zk√Ω v√Ωchod: SA, AE, IL, QA, KW
- Asie: JP, KR, CN, TW, SG, HK

#### 5. Invoice ID lookup vylep≈°en
**Probl√©m:** P≈ôi neplatn√©m UUID form√°tu Supabase vracel chybu.

**≈òe≈°en√≠ v `supabase/functions/invoice/index.ts`:**
- Detekce form√°tu ID (UUID vs. ƒç√≠slo vs. ostatn√≠)
- UUID: hled√°n√≠ pouze v `id` sloupci
- ƒå√≠slo: hled√°n√≠ pouze v `idoklad_id` sloupci
- Nezn√°m√Ω form√°t: zkusit oboje s `maybeSingle()`

#### 6. Jazyk pro email p≈ôeklady
**Probl√©m:** `getEmailTranslations('ar-SA')` normalizovalo na 'ar-sa' (lowercase), ale kl√≠ƒç byl 'ar-SA'.

**≈òe≈°en√≠ v `supabase/functions/_shared/email-translations.ts`:**
```typescript
// Zachovat case pro region k√≥dy (ar-SA, zh-CN)
const normalizedLocale = locale.replace('_', '-') // bez toLowerCase
// Speci√°ln√≠ mapov√°n√≠
const specialMappings = { 'ar': 'ar-SA', 'zh': 'zh-CN' }
```

#### 7. Subscription pricing lookup
**Probl√©m:** Pricing se hledal podle jazyka (`locale`), ale pro nƒõkter√© jazyky neexistoval cenn√≠k.

**≈òe≈°en√≠ v `supabase/functions/subscription/index.ts`:**
- Mapov√°n√≠ krajiny na pricing locale
- Fallback na 'en' (EUR) pokud cenn√≠k pro danou krajinu neexistuje

**Nasazeno:**
- Edge funkce: idoklad, invoice, subscription, gpwebpay
- Frontend: index.html, app.js
- Git commit: "Fix: Apple Pay icon, VAT calculation, country handling, invoice lookup, and language fallback"

---

### 13.1.2026 (veƒçer) - Opravy faktur v2

**Vy≈ôe≈°en√© probl√©my:**

#### 1. Chybƒõj√≠c√≠ p≈ôeklady invoice_email_* (22 jazyk≈Ø)
**Probl√©m:** Pouze 9 jazyk≈Ø mƒõlo p≈ôeklady pro fakturn√≠ email, ostatn√≠ zobrazovaly "undefined".

**≈òe≈°en√≠ v `supabase/functions/_shared/email-translations.ts`:**
- Doplnƒõny v≈°echny `invoice_email_*` kl√≠ƒçe pro 22 chybƒõj√≠c√≠ch jazyk≈Ø
- Jazyky: pt, nl, da, sv, no, fi, et, lv, lt, hu, ro, bg, hr, sr, el, tr, ru, uk, ar-SA, ja, ko, zh-CN, zh-TW

#### 2. iDoklad p≈ôeklady v ƒçe≈°tinƒõ
**Probl√©m:** Polo≈æky na faktu≈ôe v iDoklad byly v jazyce z√°kazn√≠ka m√≠sto ƒçe≈°tiny.

**≈òe≈°en√≠ v `supabase/functions/idoklad/index.ts`:**
```typescript
// D≈ÆLE≈ΩIT√â: P≈ôeklady pro iDoklad V≈ΩDY v ƒçe≈°tinƒõ (po≈æadavek √∫ƒçetnictv√≠)
const t = getEmailTranslations('cs') // V≈ædy ƒçe≈°tina pro iDoklad
```

#### 3. iDoklad VatRateType chyba
**Probl√©m:** Chyba "VatRate 21 and VatRateType Reduced1 for dates 1/13/2026 has not been found."

**P≈ô√≠ƒçina:** `VatRateType: 1` znamen√° `Reduced1` (sn√≠≈æen√° sazba 12%), ne `Basic` (21%).

**≈òe≈°en√≠ v `supabase/functions/idoklad/index.ts`:**
```typescript
// iDoklad VatRateType hodnoty:
// 0 = Basic (z√°kladn√≠ sazba - 21%)
// 1 = Reduced1 (sn√≠≈æen√° 1 - 12%)
// 3 = Zero (nulov√°/osvobozeno - 0%)
return { rate: 21, type: 0 } // type: 0 = Basic (21%)
```

#### 4. Debug odkazu na fakturu
**Probl√©m:** URL `invoice.html?id=59851040` zobrazoval "Faktura nenalezena".

**≈òe≈°en√≠ v `supabase/functions/invoice/index.ts`:**
- P≈ôid√°ny debug logy pro sledov√°n√≠ lookup procesu
- Fallback lookup podle `idoklad_id` konvertuje na string

#### 5. Apple Pay ikona
**Probl√©m:** Ikona nebyla rozpoznateln√° na tmav√©m pozad√≠.

**≈òe≈°en√≠ v `index.html`:**
- Nahrazena SVG ikonou ve stylu FontAwesome s b√≠lou v√Ωpln√≠ a or√°mov√°n√≠m

**Nasazen√© edge funkce:**
- `idoklad` - opraven√Ω VatRateType a ƒçesk√© p≈ôeklady
- `invoice` - debug logy pro lookup

---

### 13.1.2026 - Opravy faktur a UX

**Vy≈ôe≈°en√© probl√©my:**

#### 1. iDoklad DPH sazba 12% ‚Üí 21%
**Probl√©m:** iDoklad pou≈æ√≠val DPH sazbu zemƒõ kontaktu (SK = 12%) m√≠sto explicitn√≠ sazby.

**≈òe≈°en√≠ v `supabase/functions/idoklad/index.ts`:**
```typescript
Items: [{
  VatRateType: vatRate.type,
  VatRate: vatRate.rate, // EXPLICITNƒö 21 nebo 0 - iDoklad jinak pou≈æije sazbu zemƒõ kontaktu
}]
```

#### 2. Nefunkƒçn√≠ odkaz na fakturu z emailu
**Probl√©m:** URL `invoice.html?id=59847319` zobrazoval "Faktura nenalezena" - ƒç√≠slo bylo iDoklad ID, ale lookup hledal na≈°e DB ID.

**≈òe≈°en√≠ v `supabase/functions/invoice/index.ts`:**
```typescript
// Zkusit naj√≠t podle na≈°eho ID, pak fallback na iDoklad ID
const { data: invoiceById } = await supabaseAdmin.from('invoices').select('*').eq('id', invoiceId).single()
if (!invoiceById) {
  const { data: invoiceByIdoklad } = await supabaseAdmin.from('invoices').select('*').eq('idoklad_id', invoiceId).single()
}
```

#### 3. Dvojjazyƒçn√° faktura (jazyk u≈æivatele + angliƒçtina)
**Po≈æadavek:** Faktura v emailu i na webu mus√≠ obsahovat dvƒõ verze - naho≈ôe v jazyku u≈æivatele, dole v angliƒçtinƒõ.

**≈òe≈°en√≠:**
- `supabase/functions/invoice/index.ts`: Nov√© funkce `generateSingleInvoiceHtml()` a `generateSingleIdokladInvoiceHtml()` pro generov√°n√≠ jedn√© verze
- `getEmailBody()` a `getEmailBodyFromIdoklad()` upraveny pro dvojjazyƒçnou verzi
- `invoice.html`: P≈ôid√°n druh√Ω kontejner pro anglickou verzi s oddƒõlovaƒçem

#### 4. Zobrazen√≠ DPH na faktu≈ôe
**Po≈æadavek:** Faktura mus√≠ zobrazovat: cena bez DPH, DPH ƒç√°stka a sazba, celkem s DPH.

**≈òe≈°en√≠:** Ji≈æ implementov√°no v p≈ôedchoz√≠ch √∫prav√°ch, ovƒõ≈ôeno ≈æe funguje spr√°vnƒõ.

#### 5. Odhl√°≈°en√≠ po platbƒõ
**Probl√©m:** U≈æivatel byl po redirectu z GP WebPay odhl√°≈°en (Clerk session vypr≈°ela).

**≈òe≈°en√≠ v `app.js`:**
- P≈ôed redirectem: `localStorage.setItem('liquimixer_pending_payment_clerk_id', window.Clerk.user.id)`
- Po n√°vratu: Pokud nen√≠ p≈ôihl√°≈°en po 10s, zobraz√≠ se info notifikace a login modal
- Nov√Ω p≈ôeklad `subscription.payment_success_login_required`

#### 6. Apple Pay ikona
**Probl√©m:** Komplexn√≠ SVG nebyla rozpoznateln√° na tmav√©m pozad√≠.

**≈òe≈°en√≠ v `index.html`:**
```html
<svg viewBox="0 0 50 21" style="background: #000; border-radius: 3px; padding: 2px 6px;">
  <!-- Apple logo + "Pay" text -->
</svg>
```

**Soubory upraven√©:**
| Soubor | Zmƒõna |
|--------|-------|
| `supabase/functions/idoklad/index.ts` | VatRate explicitnƒõ |
| `supabase/functions/invoice/index.ts` | Fallback lookup + dvojjazyƒçn√° faktura |
| `invoice.html` | Dvojjazyƒçn√© zobrazen√≠ |
| `app.js` | Ulo≈æit clerk_id p≈ôed platbou, login modal po n√°vratu |
| `index.html` | Apple Pay SVG s ƒçern√Ωm pozad√≠m |
| `styles.css` | Apple Pay filtry odebr√°ny |
| `locales/cs.json`, `locales/en.json` | Nov√Ω p≈ôeklad `payment_success_login_required` |

---

### 12.1.2026 - iDoklad integrace + Invoice Language Priority

**Vyrie≈°en√© probl√©my:**

#### 1. iDoklad Invoice Pricing
**Probl√©m:** Fakt√∫ra zobrazovala 59 Kƒç bez DPH + 12% DPH = 66,08 Kƒç namiesto 59 Kƒç S DPH.

**Rie≈°enie v `supabase/functions/idoklad/index.ts`:**
```typescript
Items: [{
  UnitPrice: unitPriceWithoutVat, // Cena BEZ DPH
  PriceType: 0, // 0 = cena BEZ DPH (iDoklad prid√° DPH)
  VatRateType: vatRate.type,
}]
```

**Nefunguj√∫ce rie≈°enie:** `PriceType: 1` s cenou S DPH - iDoklad to interpretoval ako cenu bez DPH.

#### 2. iDoklad Payment Method
**Probl√©m:** Fakt√∫ra zobrazovala "P≈ôevodem" namiesto "Kartou".

**Rie≈°enie:** Funkcia `getCardPaymentOptionId()` hƒæad√° alebo vytv√°ra platbu kartou.

#### 3. Invoice Language Priority
**Probl√©m:** Fakt√∫ra pri≈°la v CZ jazyku aj keƒè mal pou≈æ√≠vateƒæ nastaven√Ω SK jazyk.

**Rie≈°enie v `supabase/functions/gpwebpay/index.ts`:**
```typescript
// Priorita jazyka:
// 1. users.locale - jazyk pou≈æ√≠vateƒæa z profilu
// 2. subscription.user_locale - jazyk z GP WebPay lokaliz√°cie (fallback)
const invoiceLocale = user?.locale || subscription?.user_locale || 'cs'
```

**D√¥le≈æit√©:** Da≈àov√° lokaliz√°cia (`country`) zost√°va nezmenen√°!

#### 4. Subscription Modal Translations
**Probl√©m:** Modal sa zobrazoval v arabƒçine/angliƒçtine.

**Rie≈°enie:** Doplnen√© kƒæ√∫ƒçe do v≈°etk√Ωch 31 jazykov:
- `register_first`, `error_not_logged_in`, `register_and_pay`
- `already_have_account`, `logged_in_as`, `pay_button_simple`
- `redirect_info`, `payment_success`, `payment_failed`, `payment_declined`

#### 5. Invoice.html Display
**Probl√©m:** Str√°nka nezobrazovala fakt√∫ru.

**Rie≈°enie:** 
- Pridan√© `apikey` header do fetch
- Pridan√© zobrazenie DPH (z√°klad, %, celkom)

#### 6. Apple Pay Logo
**Probl√©m:** Logo nebolo viditeƒæn√© na tmavom pozad√≠.

**Rie≈°enie:** Inline SVG s `fill="#ffffff"`.

**S√∫bory upraven√©:**
| S√∫bor | Zmena |
|-------|-------|
| `supabase/functions/idoklad/index.ts` | PriceType=0, PaymentOptionId |
| `supabase/functions/gpwebpay/index.ts` | Invoice language priority |
| `invoice.html` | VAT display |
| `index.html` | Apple Pay SVG |
| `locales/*.json` (25 s√∫borov) | Subscription modal preklady |

**SQL Script pre reset testovac√≠ch √∫ƒçtov:**
```sql
DELETE FROM payments WHERE clerk_id IN (SELECT clerk_id FROM users WHERE email ILIKE '%lapos%');
DELETE FROM invoices WHERE clerk_id IN (SELECT clerk_id FROM users WHERE email ILIKE '%lapos%');
DELETE FROM subscriptions WHERE clerk_id IN (SELECT clerk_id FROM users WHERE email ILIKE '%lapos%');
UPDATE users SET subscription_status = NULL, subscription_tier = NULL, subscription_id = NULL, subscription_expires_at = NULL WHERE email ILIKE '%lapos%';
```

---

### 9.1.2026 (veƒçer) - Autentizaƒçn√≠ flow - VY≈òE≈†ENO ‚úì
**PROBL√âM BYL VY≈òE≈†EN:** Po dokonƒçen√≠ Clerk registrace nedoch√°zelo k p≈ôesmƒõrov√°n√≠ na platebn√≠ br√°nu.

**P≈Øvodn√≠ symptom:**
- U≈æivatel pro≈°el registrac√≠ (vyplnil email, heslo, ovƒõ≈ôil k√≥d)
- Clerk session se vytvo≈ôila, u≈æivatel byl p≈ôihl√°≈°en
- Ale API vol√°n√≠ `/functions/v1/subscription` selh√°valo s 401 "Invalid JWT"

**≈òe≈°en√≠ (verze D autentizaƒçn√≠ho flow):**
- Kompletn√≠ redesign flow s pou≈æit√≠m `fromSubscription` flagu v localStorage
- U≈æivatel se nejprve registruje/p≈ôihl√°s√≠, pak teprve prob√≠h√° platba
- Oddƒõlen√≠ registrace od platby eliminovalo timing probl√©my s JWT tokenem

**Kl√≠ƒçov√© soubory:**
- `app.js` ≈ô√°dky 445-485: Clerk listener s pending payment logikou
- `app.js` ≈ô√°dky 5531-5560: `getClerkToken()` funkce
- `app.js` ≈ô√°dky 5740-5860: `processPayment()` funkce
- `app.js` ≈ô√°dky 5870-5900: `checkPendingPayment()` funkce

**Autentizaƒçn√≠ flow (jak m√° fungovat):**
1. U≈æivatel klikne "P≈ôihl√°≈°en√≠" ‚Üí zobraz√≠ se `loginModal` s Clerk SignIn
2. V Clerk klikne "Sign up" ‚Üí `MutationObserver` to zachyt√≠ ‚Üí zobraz√≠ `subscriptionModal`
3. V subscription modalu za≈°krtne OP, klikne "Zaplatit a aktivovat":
   - Nastav√≠ `localStorage.liquimixer_pending_payment = 'true'`
   - Skryje subscription modal
   - Zobraz√≠ `loginModal` v re≈æimu `signUp` (Clerk registrace)
4. U≈æivatel vypln√≠ registraci v Clerk (jm√©no, email, heslo, k√≥d)
5. Clerk listener detekuje p≈ôihl√°≈°en√≠:
   - Zkontroluje `pending_payment` flag v localStorage
   - Pokud `true`: ƒçek√° 2s ‚Üí vol√° `checkPendingPayment()`
6. `checkPendingPayment()`:
   - Vyma≈æe flags z localStorage
   - Vol√° `processPayment()`
7. `processPayment()`:
   - ƒåek√° 1s na stabilizaci
   - Z√≠sk√° Clerk token (retry a≈æ 20√ó)
   - Vol√° `/functions/v1/subscription` (action: create)
   - Vol√° `/functions/v1/gpwebpay` (action: create)
   - P≈ôesmƒõruje na platebn√≠ br√°nu

**AKTU√ÅLNƒö SELH√ÅV√Å V KROKU 7:** Token je "Invalid JWT"

**Konzolov√© chyby (lok√°ln√≠ i produkce):**
```
Subscription creation failed: 401 {"code":401,"message":"Invalid JWT"}
Payment processing error: Error: Failed to create subscription
```

**Chyba se vyskytuje i na produkci (https://liquimixer.com):**
- Stejn√° chyba 401 "Invalid JWT" p≈ôi vol√°n√≠ subscription API
- Probl√©m nen√≠ specifick√Ω pro localhost - je to Clerk‚ÜîSupabase JWT integrace

**Z√°loha:** `C:\Users\Tom√°≈°Lapos\Documents\Liquimixer_backup_2026-01-09_21-43`

**Zmƒõny implementovan√© dnes (p≈ôed probl√©mem):**
- ‚úÖ Odstranƒõn `authChoiceModal` - zjednodu≈°en√≠ flow
- ‚úÖ `showLoginModal(mode)` - dynamicky mountuje Clerk SignIn/SignUp
- ‚úÖ MutationObserver pro zachycen√≠ "Sign up" linku v Clerk ‚Üí p≈ôesmƒõrov√°n√≠ na subscription modal
- ‚úÖ MutationObserver pro zachycen√≠ "Sign in" linku v Clerk SignUp ‚Üí p≈ôesmƒõrov√°n√≠ zpƒõt na SignIn
- ‚úÖ `routing: 'virtual'` v Clerk options - zamezen√≠ p≈ôesmƒõrov√°n√≠ na Clerk dom√©nu
- ‚úÖ Cleanup incomplete Clerk sessions v `showLoginModal()`
- ‚úÖ P≈ôid√°n close button (‚úï) na subscription modal
- ‚úÖ `handleLoginModalClose()` a `handleSubscriptionModalClose()` - spr√°vn√© ƒçi≈°tƒõn√≠ flags
- ‚úÖ `canCloseLoginModal()` - prevence zav≈ôen√≠ modalu bƒõhem registrace
- ‚úÖ CSS opravy - odstranƒõn√≠ blur z modal content, `align-items: flex-start`
- ‚úÖ P≈ôeklady email≈Ø do v≈°ech 31 jazyk≈Ø (`supabase/functions/_shared/email-translations.ts`)
- ‚úÖ P≈ôeklady nov√Ωch auth text≈Ø do v≈°ech locale soubor≈Ø
- ‚úÖ CORS - p≈ôid√°ny localhost origins pro lok√°ln√≠ v√Ωvoj

**Service Worker verze:** `liquimixer-v97`

---

### 9.1.2026 - GP WebPay integrace + User Cleanup CRON
**Kompletn√≠ implementace platebn√≠ br√°ny GP WebPay + automatick√© maz√°n√≠ neaktivn√≠ch √∫ƒçt≈Ø**

**INCIDENT (opraveno):**
- P≈ôid√°n√≠ slo≈æky GPWebpay/ zp≈Øsobilo deployment failure na Zeabur
- ≈òe≈°en√≠: `git revert`, aktualizace `.gitignore`, nov√° implementace bez bin√°rn√≠ch soubor≈Ø

**Implementov√°no:**
- ‚úÖ RSA-SHA1 podepisov√°n√≠ pomoc√≠ node-forge
- ‚úÖ Testovac√≠ konfigurace (merchant: 123456, test gateway)
- ‚úÖ Ovƒõ≈ôen√≠ podpisu odpovƒõdi od GP WebPay
- ‚úÖ Callback endpoint s p≈ôesmƒõrov√°n√≠m u≈æivatele
- ‚úÖ Automatick√° fakturace a export do iDoklad po platbƒõ
- ‚úÖ Oprava typo `handleCorsPreflght` ‚Üí `handleCorsPreflight`
- ‚úÖ Dokumentace GPWEBPAY_SETUP.md
- ‚úÖ Oprava Clerk UI (ƒçitelnost "Continue" tlaƒç√≠tka, ƒçesk√© p≈ôeklady)

**User Cleanup CRON Job (`user-cleanup/`):**
- ‚úÖ Automatick√© maz√°n√≠ neaktivn√≠ch √∫ƒçt≈Ø
- **Pravidla maz√°n√≠:**
  - U≈æivatel BEZ historie p≈ôedplatn√©ho ‚Üí smaz√°n po **48 hodin√°ch** od registrace
  - U≈æivatel S histori√≠ p≈ôedplatn√©ho ‚Üí smaz√°n **3 mƒõs√≠ce** po vypr≈°en√≠
- **Email upozornƒõn√≠ (pro u≈æivatele s histori√≠):**
  - 1 mƒõs√≠c p≈ôed smaz√°n√≠m
  - 1 t√Ωden p≈ôed smaz√°n√≠m
  - 1 den p≈ôed smaz√°n√≠m
- **Datab√°zov√© sloupce:** `deletion_warning_sent`, `deletion_scheduled_at`, `locale`
- **CRON nastaven√≠:** Dennƒõ ve 3:00 p≈ôes pg_cron

**Testovac√≠ karty:**
| Karta | V√Ωsledek |
|-------|----------|
| `4056070000000008` | ‚úÖ √öspƒõ≈°n√° |
| `4056070000000016` | ‚ùå Zam√≠tnut√° |

**Supabase secrets (nastaveny):**
- `GPWEBPAY_TEST_MODE=true`
- `GPWEBPAY_PRIVATE_KEY` (Base64 testovac√≠ kl√≠ƒç)
- `GPWEBPAY_PRIVATE_KEY_PASSWORD=111111`
- `GPWEBPAY_GPE_PUBLIC_KEY` (Base64 ve≈ôejn√Ω kl√≠ƒç GPE)
- `APP_BASE_URL=https://www.liquimixer.com`
- SMTP konfigurace pro faktury
- `CRON_SECRET` - tajn√Ω kl√≠ƒç pro CRON job autorizaci
- `RESEND_API_KEY` - pro odes√≠l√°n√≠ email≈Ø (volitelnƒõ)

**Pro p≈ôechod do produkce:**
1. Nastavit `GPWEBPAY_TEST_MODE=false`
2. Vymƒõnit testovac√≠ kl√≠ƒçe za produkƒçn√≠ od banky
3. Aktualizovat `GPWEBPAY_MERCHANT_NUMBER`
4. Deploy: `supabase functions deploy gpwebpay`
5. Deploy: `supabase functions deploy user-cleanup`
6. Povolit pg_cron v Supabase Dashboard a nastavit CRON job

### 8.1.2026 - P≈ôeklady a tlaƒç√≠tka
- ‚úÖ Opraveny p≈ôeklady tlaƒç√≠tek "Ulo≈æit zmƒõny" a "Ulo≈æit recept" (hardcoded ‚Üí t())
- ‚úÖ P≈ôid√°ny chybƒõj√≠c√≠ kl√≠ƒçe do v≈°ech 31 jazyk≈Ø (reminder, recipe_detail, save_recipe)
- ‚úÖ Opraveno ≈ôazen√≠ p≈ôipom√≠nek (nejnovƒõj≈°√≠ naho≈ôe)
- ‚úÖ Opravena grafika slo≈æek v ulo≈æen√Ωch receptech (results-table-container)

### 7.1.2026 - KRITICK√ù INCIDENT: Korupce app.js
**Co se stalo:**
- PowerShell p≈ô√≠kazy po≈°kodily UTF-8 k√≥dov√°n√≠ v app.js
- V≈°echny ƒçesk√© znaky se zmƒõnily na neƒçiteln√© symboly
- Emoji ikony se rozpadly

**Jak se opravilo:**
- Ruƒçn√≠ oprava stovek ≈ô√°dk≈Ø pomoc√≠ search_replace
- Porovn√°v√°n√≠ s cs.json pro spr√°vn√© ƒçesk√© texty

**Pouƒçen√≠:**
- NIKDY nepou≈°tƒõt PowerShell pro editaci soubor≈Ø!
- V≈ædy dƒõlat z√°lohu p≈ôed velk√Ωmi zmƒõnami

### 6-7.1.2026 - P≈ôipom√≠nky zr√°n√≠
- ‚úÖ Implementace syst√©mu p≈ôipom√≠nek (reminders)
- ‚úÖ Automatick√Ω v√Ωpoƒçet steeping ƒçasu podle typu p≈ô√≠chutƒõ
- ‚úÖ Edge funkce reminder-notify pro notifikace
- ‚úÖ Oprava v√Ωpoƒçtu pro star≈°√≠ recepty (fallback hled√°n√≠ flavorType)

### 5.1.2026 - Pulzuj√≠c√≠ animace
- ‚úÖ Pulzuj√≠c√≠ text pro mode-button (eLiquid, ≈òedƒõn√≠ nikotinu)
- ‚úÖ Pulzuj√≠c√≠ border pro ostatn√≠ tlaƒç√≠tka
- ‚úÖ Oprava barvy pulzov√°n√≠ pro r≈Ø≈æov√© tlaƒç√≠tko "M≈Øj √∫ƒçet"

---

## üåê JAZYK vs. GEOLOKACE - DVƒö NEZ√ÅVISL√â FUNKCE!

### KRITICK√â POCHOPEN√ç

| Funkce | √öƒçel | Jak se urƒçuje | Kde se pou≈æ√≠v√° |
|--------|------|---------------|----------------|
| **Jazyk (locale)** | Komunikace s u≈æivatelem | Prohl√≠≈æeƒç nebo volba u≈æivatele | UI, emaily, horn√≠ ƒç√°st faktury |
| **Geolokace (country)** | M√≠sto plnƒõn√≠ pro DPH | IP adresa u≈æivatele | Cena, mƒõna, DPH, iDoklad |

### JAZYK (locale)

**Urƒçen√≠:**
1. Preference u≈æivatele (ulo≈æeno v `user_settings.language`)
2. Jazyk prohl√≠≈æeƒçe (`navigator.language`)
3. Fallback: `cs`

**Kde se pou≈æ√≠v√°:**
- Cel√© UI aplikace
- Emaily (vƒçetnƒõ horn√≠ ƒç√°sti faktury v emailu)
- P≈ôeklady v `locales/*.json`

**31 podporovan√Ωch jazyk≈Ø:**
cs, en, de, fr, es, it, pl, ru, pt, nl, ja, ko, zh-CN, zh-TW, ar-SA, sv, da, fi, no, hr, sr, bg, ro, lt, lv, et, hu, el, uk, sk, tr

### GEOLOKACE (country)

**Urƒçen√≠:**
1. IP adresa ‚Üí geolokaƒçn√≠ slu≈æba (ip-api.com, ipapi.co)
2. Fallback: `CZ`

**Kdy se detekuje:**
- P≈ôi naƒçten√≠ str√°nky
- **P≈òED KA≈ΩDOU PLATBOU** (u≈æivatel se m≈Ø≈æe stƒõhovat!)

**Tabulky v DB:**
- `vat_rates` - DPH sazby pro ka≈ædou zemi
- `pricing` - ceny podle locale (cs=CZK, en=EUR/USD)
- `user_locations` - historie lokac√≠ u≈æivatele

**Kde se pou≈æ√≠v√°:**
- Urƒçen√≠ ceny (59 CZK / 2.40 EUR / 2.90 USD)
- Urƒçen√≠ mƒõny
- Urƒçen√≠ DPH sazby (21% EU / 0% mimo EU)
- Krajina kontaktu v iDoklad

### PRAVIDLA PRO iDoklad

**iDoklad v≈ædy v ƒåE≈†TINƒö:**
```typescript
const t = getEmailTranslations('cs') // V≈ΩDY ƒçe≈°tina pro iDoklad
```

**Jazyk z√°kazn√≠ka se pou≈æije pro:**
- Email s fakturou (horn√≠ ƒç√°st)
- Doln√≠ ƒç√°st emailu je v≈ædy anglicky

**Krajina v iDoklad:**
- Urƒçuje se z geolokace (IP), NE z jazyka
- Kontakt se aktualizuje p≈ôi zmƒõnƒõ zemƒõ

---

## üìÑ iDoklad API INTEGRACE

### Autentizace
- OAuth 2.0 Client Credentials flow
- Token URL: `https://identity.idoklad.cz/server/connect/token`
- API URL: `https://api.idoklad.cz/v3`
- Secrets: `IDOKLAD_CLIENT_ID`, `IDOKLAD_CLIENT_SECRET`

### Hlavn√≠ endpointy pou≈æ√≠van√©
| Endpoint | Metoda | √öƒçel |
|----------|--------|------|
| `/Contacts` | GET/POST/PATCH | Spr√°va kontakt≈Ø (z√°kazn√≠k≈Ø) |
| `/IssuedInvoices` | POST | Vytvo≈ôen√≠ faktury |
| `/IssuedInvoices/Default` | GET | V√Ωchoz√≠ nastaven√≠ faktury |
| `/PaymentOptions` | GET/POST | Platebn√≠ metody |
| `/Countries` | GET | Seznam zem√≠ |

### Struktura faktury
```typescript
const invoiceData = {
  PartnerId: contactId,          // ID kontaktu
  DateOfIssue: '2026-01-13',     // Datum vystaven√≠
  DateOfMaturity: '2026-01-27',  // Datum splatnosti
  DateOfPayment: '2026-01-13',   // Datum √∫hrady
  PaymentOptionId: paymentId,     // Platba kartou
  NumericSequenceId: seqId,       // ƒå√≠seln√° ≈ôada
  Items: [{
    Name: 'LiquiMixer Premium...',
    Amount: 1,
    Unit: 'ks',
    UnitPrice: unitPriceWithoutVat, // Cena BEZ DPH!
    VatRateType: 0,                 // 0=Basic, 3=Zero
    VatRate: 21,                    // Explicitn√≠ sazba
    PriceType: 0,                   // 0 = cena bez DPH
  }]
}
```

### ƒåast√© chyby iDoklad API

| Chyba | P≈ô√≠ƒçina | ≈òe≈°en√≠ |
|-------|---------|--------|
| 401 Unauthorized | Neplatn√© credentials | Ovƒõ≈ôit IDOKLAD_CLIENT_ID/SECRET |
| "VatRate X and VatRateType Y not found" | Konflikt VatRate a VatRateType | Pou≈æ√≠t POUZE VatRateType, NE VatRate! |
| ≈†patn√° DPH sazba (12%) | VatRateType: 1 (Reduced1) m√≠sto 0 (Basic) | Zkontrolovat getVatRateForCountry() |
| VatRateType Reduced1 for dates... | Pos√≠l√°me VatRate: 21 + VatRateType: 1 | Odstranit VatRate, pou≈æ√≠t jen VatRateType: 0 |

### KRITICK√â - VatRateType hodnoty

```typescript
// iDoklad VatRateType hodnoty - NEPOU≈Ω√çVAT VatRate souƒçasnƒõ!
// 0 = Basic (z√°kladn√≠ sazba - 21%)  ‚Üê PRO EU ZEMƒö
// 1 = Reduced1 (sn√≠≈æen√° 1 - 12%)    ‚Üê NEPOU≈Ω√çVAT!
// 2 = Reduced2 (sn√≠≈æen√° 2 - 0%)     ‚Üê NEPOU≈Ω√çVAT!
// 3 = Zero (nulov√°/osvobozeno - 0%) ‚Üê PRO MIMO EU

Items: [{
  VatRateType: vatRate.type, // 0 nebo 3, NIKDY 1 nebo 2
  // VatRate: vatRate.rate,  // NEPOS√çLAT! Zp≈Øsobuje konflikt
  PriceType: 0, // 0 = cena BEZ DPH
}]
```

### Logika cen pro iDoklad

**EU zemƒõ (21% DPH):**
- Fin√°ln√≠ cena S DPH: 59 CZK / 2.40 EUR
- iDoklad dostane: `UnitPrice = amount / 1.21` (cena BEZ DPH)
- `VatRateType: 0` (Basic 21%)
- iDoklad dopoƒç√≠t√° DPH a zobraz√≠ spr√°vnou fin√°ln√≠ cenu

**Mimo EU (0% DPH):**
- Fin√°ln√≠ cena BEZ DPH: 2.90 USD / 2.40 EUR
- iDoklad dostane: `UnitPrice = amount` (ji≈æ je bez DPH)
- `VatRateType: 3` (Zero - osvobozeno)
- iDoklad nezobraz√≠ ≈æ√°dn√© DPH

### Aktualizace kontaktu p≈ôi zmƒõnƒõ zemƒõ
Pokud u≈æivatel zmƒõn√≠ zemi (stƒõhov√°n√≠), je nutn√© aktualizovat kontakt v iDoklad:
```typescript
// V getOrCreateContact() - kontrola a update
if (existingContact.CountryId !== targetCountryId) {
  await fetch(`${IDOKLAD_CONFIG.apiUrl}/Contacts/${existingContact.Id}`, {
    method: 'PATCH',
    body: JSON.stringify({ CountryId: targetCountryId })
  })
}
```

---

## üåç GEOLOKACE A DPH

### Princip m√≠sta plnƒõn√≠
- **M√≠sto plnƒõn√≠** = krajina z√°kazn√≠ka detekovan√° z IP adresy
- M√≠sto plnƒõn√≠ urƒçuje:
  - DPH sazbu (21% EU vs. 0% mimo EU)
  - Krajinu kontaktu v iDoklad
  - Mƒõnu (CZK, EUR, USD)
- **Jazyk je nez√°visl√Ω** na m√≠stu plnƒõn√≠ (u≈æivatel si vol√≠ s√°m)

### Kdy se detekuje geolokace
1. P≈ôi naƒçten√≠ str√°nky: `detectUserLocation()` v `app.js`
2. **P≈òED KA≈ΩDOU PLATBOU:** `detectUserLocation()` vol√°no v `processPayment()`
   - D≈Øvod: U≈æivatel se m≈Ø≈æe stƒõhovat, m√≠sto plnƒõn√≠ se mƒõn√≠

### DPH sazby v iDoklad

| Krajina | VatRateType | VatRate | Popis |
|---------|-------------|---------|-------|
| EU zemƒõ | 0 (Basic) | 21 | Z√°kladn√≠ sazba |
| Mimo EU | 3 (Zero) | 0 | Osvobozeno |

**POZOR na hodnoty VatRateType:**
```typescript
// iDoklad VatRateType hodnoty:
// 0 = Basic (z√°kladn√≠ sazba - 21%)
// 1 = Reduced1 (sn√≠≈æen√° 1 - 12%) ‚Üê NEPOU≈Ω√çVAT!
// 2 = Reduced2 (sn√≠≈æen√° 2 - 10%) ‚Üê NEPOU≈Ω√çVAT!
// 3 = Zero (nulov√°/osvobozeno - 0%)
```

### EU zemƒõ (21% DPH)
```typescript
const euCountries = [
  'AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR',
  'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL',
  'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'
]
```

### Ceny pro iDoklad
- **V≈ΩDY pos√≠lat cenu BEZ DPH** s `PriceType: 0`
- iDoklad s√°m dopoƒç√≠t√° DPH
- Pro EU: `unitPriceWithoutVat = amount / 1.21`
- Pro mimo EU: `unitPriceWithoutVat = amount` (0% DPH)

---

## üêõ ZN√ÅM√â PROBL√âMY

### Lok√°ln√≠ v√Ωvoj
- `Error checking subscription: SyntaxError` - NORM√ÅLN√ç na localhost
  - Supabase edge funkce nejsou dostupn√© lok√°lnƒõ
  - Na produkci (Zeabur) funguje spr√°vnƒõ

### PowerShell cesty
- Cesta s ƒçesk√Ωmi znaky nefunguje v PowerShell
- Pou≈æ√≠t kr√°tkou cestu: `C:\Users\TOMLAP~1\Liquimixer`

### Edge Function neloguje nic
**Symptom:** Funkce by mƒõla logovat, ale v Supabase Dashboard nen√≠ ≈æ√°dn√Ω log.

**Mo≈æn√© p≈ô√≠ƒçiny:**
1. **JWT verifikace selhala** - po≈æadavek byl odm√≠tnut je≈°tƒõ p≈ôed spu≈°tƒõn√≠m k√≥du
   - ≈òe≈°en√≠: P≈ôidat `verify_jwt = false` do `config.toml` pro danou funkci
2. **Funkce nebyla nasazena** - star√° verze bez log≈Ø
   - ≈òe≈°en√≠: `npx supabase functions deploy [funkce] --project-ref krwdfxnvhnxtkhtkbadi`
3. **≈†patn√Ω ƒçasov√Ω rozsah** v logu Dashboard
   - ≈òe≈°en√≠: Zvƒõt≈°it ƒçasov√Ω rozsah nebo pou≈æ√≠t "Last 1 hour"

**Debug postup:**
1. P≈ôidat logy na √∫pln√Ω zaƒç√°tek `serve()`:
```typescript
serve(async (req) => {
  console.log('=== Function called ===')
  console.log('Method:', req.method)
  console.log('URL:', req.url)
  // ...
```
2. Nasadit funkci
3. Otestovat a zkontrolovat logy

### 401 Unauthorized z Edge Function
**Mo≈æn√© p≈ô√≠ƒçiny:**
1. **Supabase JWT verifikace** - chyb√≠ `verify_jwt = false` v config.toml
2. **Extern√≠ API credentials** - neplatn√© nebo expirovan√© (iDoklad, GP WebPay)
3. **Clerk token** - vypr≈°el nebo je neplatn√Ω

**Jak rozli≈°it:**
- Pokud funkce NELOGUJE NIC ‚Üí probl√©m je JWT verifikace Supabase
- Pokud funkce loguje ale vrac√≠ 401 ‚Üí probl√©m je v k√≥du funkce (API credentials)

---

## üîó U≈ΩITEƒåN√â ODKAZY

- **Produkce:** https://liquimixer.zeabur.app
- **GitHub:** https://github.com/tomaslapos/liquimixer
- **Supabase:** https://supabase.com/dashboard (projekt Liquimixer)
- **Clerk:** https://dashboard.clerk.com (autentizace)
- **Zeabur:** https://zeabur.com (hosting, auto-deploy z main branch)

---

## Z√°lohy

- `backup_2026-01-10/` - pred subscription flow redesign
- `backup_2026-01-12/` - r√°no
- `backup_2026-01-12-evening/` - veƒçer po oprav√°ch

---

## Kontakty a secrets

### Supabase Secrets (potrebn√© pre Edge Functions)
- `GPWEBPAY_MERCHANT_NUMBER`
- `GPWEBPAY_PRIVATE_KEY` (Base64 PKCS#8)
- `GPWEBPAY_PRIVATE_KEY_PASSWORD`
- `GPWEBPAY_PUBLIC_KEY`
- `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASSWORD`
- `IDOKLAD_CLIENT_ID`, `IDOKLAD_CLIENT_SECRET`
- `CLERK_SECRET_KEY`

---

## üìù HISTORIE ZMƒöN

### 13.1.2026 (odpoledne)
- **Oprava po≈ôad√≠ v√Ωpoƒçtu VAT:** `vatRate` se nyn√≠ poƒç√≠t√° P≈òED vytvo≈ôen√≠m kontaktu
- **Odstranƒõn√≠ `VatRate` z invoice items:** iDoklad mƒõl konflikt mezi `VatRate` a `VatRateType`, pou≈æijeme jen `VatRateType`
- **P≈ôid√°n√≠ cleanup pending subscriptions:** `user-cleanup` funkce nyn√≠ ma≈æe pending subscriptions star≈°√≠ ne≈æ 24 hodin
- **Spr√°vn√© VatRateType hodnoty:** 0 = Basic (21%), 3 = Zero (0%)

### 13.1.2026 (veƒçer) - HLAVN√ç OPRAVA iDoklad DPH
- **Root cause:** iDoklad bere DPH sazbu ze ZEMƒö KONTAKTU, ne z `VatRateType` polo≈æky!
- **≈òe≈°en√≠ pro EU:** Kontakt m√° v≈ædy `CountryId=1` (CZ) ‚Üí ƒçesk√© DPH 21%
- **≈òe≈°en√≠ pro mimo EU:** Kontakt m√° skuteƒçnou zemi (US, GB, JP...) ‚Üí DPH 0%
- **Pozn√°mka faktury:** V≈ædy obsahuje skuteƒçnou zemi z√°kazn√≠ka pro anal√Ωzu
- **DB ukl√°d√°:** Skuteƒçnou geolokaci v `customer_country` pro anal√Ωzu
- **P≈ôid√°n sloupec `total`:** Do DB insertu (NOT NULL constraint)
- **Oprava fallback geolokace:** `app.js` nyn√≠ v≈ædy defaultuje na CZ (m√≠sto plnƒõn√≠)

### iDoklad - ≈ôe≈°en√≠ chyb
- **Chyba "VatRate 21 and VatRateType Reduced1":** Zp≈Øsobeno konflitkem - pos√≠lali jsme oba parametry. ≈òe≈°en√≠: Pos√≠lat POUZE `VatRateType`
- **Chyba 12% DPH:** iDoklad ignoruje `VatRateType` a bere DPH ze zemƒõ kontaktu. ≈òe≈°en√≠: Pro EU zemƒõ nastavit kontakt na CZ
- **Chyba "null value in total":** Sloupec `total` je NOT NULL. ≈òe≈°en√≠: P≈ôidat `total: amount` do DB insertu

### Logika DPH pro iDoklad (OSS re≈æim)

| Zemƒõ z√°kazn√≠ka | VAT Rate | iDoklad kontakt | DB customer_country | Pozn√°mka faktury |
|----------------|----------|-----------------|---------------------|------------------|
| CZ | 21% | CZ | CZ | Zemƒõ: ƒåesk√° republika (CZ) |
| SK (EU) | 21% | CZ | SK | Zemƒõ: Slovensko (SK) |
| DE (EU) | 21% | CZ | DE | Zemƒõ: Nƒõmecko (DE) |
| US (mimo EU) | 0% | US | US | Zemƒõ: USA (US) |
| GB (mimo EU) | 0% | GB | GB | Zemƒõ: Velk√° Brit√°nie (GB) |

### 13.1.2026 (pozdƒõ veƒçer) - Opravy po testov√°n√≠

**Opraven√© probl√©my:**
1. **Invoice Edge Function - chybƒõlo verify_jwt=false** - gpwebpay vol√° invoice pro odes√≠l√°n√≠ email≈Ø, ale invoice mƒõla zapnutou JWT verifikaci ‚Üí email se neodeslal
2. **Notifikace o platbƒõ v anglicky m√≠sto u≈æivatelsk√©ho jazyka** - race condition, notifikace se zobrazovala p≈ôed naƒçten√≠m jazyka z DB. Nyn√≠ se ƒçek√° na Clerk p≈ôihl√°≈°en√≠ ‚Üí naƒçten√≠ jazyka ‚Üí pak notifikace

**P≈ôid√°no do config.toml:**
```toml
[functions.invoice]
verify_jwt = false
```

**Zmƒõna v app.js handlePaymentReturn():**
- ƒåek√° na `window.Clerk?.user` 
- Vol√° `window.i18n.loadUserLocale()` p≈ôed zobrazen√≠m notifikace

### 13.1.2026 (noc) - Dal≈°√≠ opravy

**Opraven√© probl√©my:**
1. **iDoklad kontakt update:** Zmƒõnƒõno z PATCH na PUT - iDoklad API nƒõkdy ignoruje PATCH. P≈ôid√°na validace a fallback
2. **Online faktura (invoice.html):**
   - Jazyk se nyn√≠ bere prim√°rnƒõ z `invoice.locale` (jazyk u≈æivatele v DB)
   - Opraveno NaN: `totalWithVat` se nyn√≠ spr√°vnƒõ ƒçte z `total`, `amount` nebo `total_amount`
3. **Invoice Edge Function:** P≈ôid√°n log pro debugging total hodnot

### 13.1.2026 (pozdƒõ veƒçer) - Kritick√° oprava iDoklad

**Probl√©my kter√© p≈ôetrv√°valy:**
- Kontakt st√°le se Slovenskem (12% DPH)
- PUT/PATCH aktualizace kontaktu nefungovala spolehlivƒõ
- Zp≈Øsob √∫hrady "P≈ôevodem" m√≠sto "Kartou"

**KRITICK√Å ZMƒöNA v `getOrCreateContact()`:**
- **NEAKTUALIZOVAT existuj√≠c√≠ kontakt** - iDoklad API to nedƒõl√° spolehlivƒõ
- Hledat kontakt podle emailu A spr√°vn√© zemƒõ (CountryId)
- Pokud nenajde kontakt s CZ, vytvo≈ôit NOV√ù kontakt
- Kontakt m√° `Note` s datem a zem√≠ pro DPH

```typescript
// Nov√° logika: hledat kontakt se SPR√ÅVNOU zem√≠
const matchingContact = contacts.find((c: any) => c.CountryId === targetCountryId)
if (matchingContact) {
  return matchingContact.Id // Pou≈æ√≠t existuj√≠c√≠ se spr√°vnou zem√≠
}
// Jinak vytvo≈ôit nov√Ω kontakt s CZ
```

**PaymentOptionId:**
- P≈ôid√°n detailn√≠ logging v≈°ech platebn√≠ch mo≈ænost√≠
- Hled√° "kart", "card", "online" v n√°zvech

**Email faktury:**
- Zmƒõnƒõno "English version / Anglick√° verze" ‚Üí "English version"

**Zeabur:**
- Deploye jsou "Removed" kv≈Øli infrastrukturn√≠mu probl√©mu Zeabur ("pod didn't trigger scale-up")
- Star≈°√≠ verze bƒõ≈æ√≠ spr√°vnƒõ
- ≈òe≈°en√≠: Manu√°ln√≠ Redeploy v Zeabur dashboardu nebo kontakt Zeabur support

*Posledn√° aktualiz√°cia: 2026-01-13 19:30*
