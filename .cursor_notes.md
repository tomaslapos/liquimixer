# LiquiMixer - Pozn√°mky pro AI asistenta

## ‚ö†Ô∏è KRITICK√Å PRAVIDLA - P≈òEƒåTI P≈òED KA≈ΩDOU PRAC√ç!

### 1. NIKDY NEPOU≈†TƒöT POWERSHELL PRO EDITACI SOUBOR≈Æ!

**Proƒç:**
- PowerShell na Windows m√° fat√°ln√≠ probl√©my s UTF-8 k√≥dov√°n√≠m
- Cesta `C:\Users\Tom√°≈°Lapos` se rozpadne na `C:\Users\TomÔøΩÔøΩÔøΩLapos`
- ƒåesk√© znaky se zniƒç√≠: `≈Ω√°dn√°` ‚Üí `‚îº≈ª‚îú√≠dn‚îú√≠`, `p≈ô√≠chu≈•` ‚Üí `p‚îº√ñ‚îú≈üchu‚îºƒÖ`
- Emoji se rozpadnou: `üë§` ‚Üí `¬≠ƒçƒπƒÑ`, `‚òÖ` ‚Üí `√î≈õ≈Ø`, `üóëÔ∏è` ‚Üí `√î≈•ƒΩ`

**Co se stalo v minulosti:**
- Dne 7.1.2026 byl cel√Ω `app.js` po≈°kozen PowerShell p≈ô√≠kazy
- Muselo se ruƒçnƒõ opravovat stovky ≈ô√°dk≈Ø s po≈°kozen√Ωmi znaky
- U≈æivatel explicitnƒõ zak√°zal pou≈æ√≠vat PowerShell

**Jak spr√°vnƒõ:**
- Pro editaci soubor≈Ø: V√ùHRADNƒö n√°stroje Cursor (`search_replace`, `write`, `read_file`)
- Pro Git operace: `cmd /c "git add -A && git commit -m 'message' && git push"`
- Pro kop√≠rov√°n√≠ soubor≈Ø: `cmd /c "robocopy source dest /E"` s kr√°tkou cestou `TOMLAP~1`
- Kr√°tk√° cesta u≈æivatele: `C:\Users\TOMLAP~1\Liquimixer`

**ZAK√ÅZAN√â p≈ô√≠kazy:**
```
‚ùå Set-Content, Add-Content, Out-File
‚ùå [System.IO.File]::WriteAllText()
‚ùå (Get-Content file) -replace
‚ùå jak√Ωkoliv PowerShell p≈ô√≠kaz co zapisuje do souboru
```

### 2. P≈òEKLADY NEDƒöLAT SKRIPTEM!

**Proƒç:**
- Automatick√© skripty (generate-locales.js, complete-translations.js) NEFUNGUJ√ç
- Generuj√≠ neplatn√Ω JSON nebo chybn√© p≈ôeklady
- U≈æivatel to explicitnƒõ zak√°zal po opakovan√Ωch selh√°n√≠ch

**Jak spr√°vnƒõ p≈ôid√°vat p≈ôeklady:**

1. **Referenƒçn√≠ soubor:** `locales/cs.json` - V≈ΩDY porovn√°vat s t√≠mto
2. **Postup pro nov√Ω kl√≠ƒç:**
   - Naj√≠t v `cs.json` kde kl√≠ƒç pat≈ô√≠ (nap≈ô. sekce `save_recipe`, `reminder`, `recipe_detail`)
   - Otev≈ô√≠t JEDEN jazykov√Ω soubor (nap≈ô. `de.json`)
   - P≈ôidat kl√≠ƒç s p≈ôelo≈æen√Ωm textem
   - Opakovat pro dal≈°√≠ jazyky POSTUPNƒö
3. **Kontrola JSON syntaxe:** Po ka≈æd√© √∫pravƒõ ovƒõ≈ôit validitu JSON

**Struktura kl√≠ƒç≈Ø:**
```json
{
  "meta": { "code": "cs", "name": "ƒåe≈°tina" },
  "nav": { "home": "Dom≈Ø", "menu": "Menu" },
  "auth": { "login": "P≈ôihl√°sit", "logout": "Odhl√°sit" },
  "form": { "amount": "Mno≈æstv√≠", "ratio": "Pomƒõr" },
  "results": { "title": "V√Ωsledky", "total": "Celkem" },
  "save_recipe": { "title": "Ulo≈æit recept", "save_button": "Ulo≈æit" },
  "reminder": { "add_title": "P≈ôidat p≈ôipom√≠nku", "mixed_on": "Nam√≠ch√°no" },
  "recipe_detail": { "reminders_title": "P≈ôipom√≠nky zr√°n√≠" },
  "common": { "save": "Ulo≈æit", "cancel": "Zru≈°it", "delete": "Smazat" }
}
```

**31 podporovan√Ωch jazyk≈Ø:**
cs, en, de, fr, es, it, pl, ru, pt, nl, ja, ko, zh-CN, zh-TW, ar-SA, 
sv, da, fi, no, hr, sr, bg, ro, lt, lv, et, hu, el, uk, sk, tr

### 3. NAHR√ÅV√ÅN√ç NA GITHUB

**PRAVIDLO:** Nahr√°vat POUZE po testov√°n√≠ a schv√°len√≠ u≈æivatelem!

**Postup:**
1. Udƒõlat zmƒõny pomoc√≠ n√°stroj≈Ø Cursor
2. Informovat u≈æivatele co bylo zmƒõnƒõno
3. POƒåKAT na testov√°n√≠ u≈æivatelem
4. POƒåKAT na schv√°len√≠ ("nahraj na GitHub")
5. Teprve pak: `git add -A`, `git commit`, `git push`

**Git p≈ô√≠kazy (p≈ôes cmd):**
```bash
cmd /c "cd C:\Users\TOMLAP~1\Liquimixer && git status"
cmd /c "cd C:\Users\TOMLAP~1\Liquimixer && git add -A"
cmd /c "cd C:\Users\TOMLAP~1\Liquimixer && git commit -m popis-zmeny"
cmd /c "cd C:\Users\TOMLAP~1\Liquimixer && git push origin main"
```

**POZOR - Escapov√°n√≠ v commit message:**
- PowerShell m√° probl√©my s uvozovkami a speci√°ln√≠mi znaky
- Nejbezpeƒçnƒõj≈°√≠ je commit message BEZ mezer a speci√°ln√≠ch znak≈Ø
- P≈ô√≠klad: `git commit -m fix-idoklad-jwt-verification`
- NEFUNGUJE: `git commit -m "Fix: Add verify_jwt=false"` (rozpadne se na v√≠ce argument≈Ø)

**POZOR:** Branch je `main`, NE `master`!

### 4. P≈òED KA≈ΩDOU ZMƒöNOU

**Pravidla:**
1. **Nastudovat k√≥d** p≈ôed editac√≠ - pochopit jak funguje
2. **Mal√© zmƒõny** - nedƒõlat velk√© refaktoringy bez vy≈æ√°d√°n√≠
3. **Testovat lok√°lnƒõ** - u≈æivatel m√° Live Server na `http://127.0.0.1:5500`
4. **Konzistence** - pou≈æ√≠vat stejn√© vzory jako existuj√≠c√≠ k√≥d

### 5. Z√ÅLOHOV√ÅN√ç

**P≈ôed velk√Ωmi zmƒõnami vytvo≈ôit z√°lohu:**
```bash
cmd /c "robocopy C:\Users\TOMLAP~1\Liquimixer C:\Users\TOMLAP~1\Liquimixer_backup_DATUM /E /XD node_modules .git"
```

**Z√°lohy jsou v:** `C:\Users\Tom√°≈°Lapos\Liquimixer_backup_*`

---

## üìÅ STRUKTURA PROJEKTU

### Hlavn√≠ soubory

| Soubor | Velikost | Popis |
|--------|----------|-------|
| `index.html` | ~123KB | Hlavn√≠ HTML, v≈°echny mod√°ly, struktura UI |
| `app.js` | ~230KB, ~6000 ≈ô√°dk≈Ø | Ve≈°ker√° aplikaƒçn√≠ logika |
| `styles.css` | ~107KB | Ve≈°ker√© CSS styly, animace |
| `i18n.js` | ~19KB | Internacionalizace, spr√°va jazyk≈Ø |
| `database.js` | ~36KB | Supabase operace (CRUD) |
| `subscription.js` | ~21KB | P≈ôedplatn√©, platby, billing |
| `fcm.js` | ~8KB | Firebase Cloud Messaging |

### Jak je app.js organizov√°n (~6000 ≈ô√°dk≈Ø):

```
≈ò√°dky 1-50:      Bezpeƒçnostn√≠ funkce (escapeHtml, sanitizeUrl)
≈ò√°dky 50-200:    flavorDatabase - typy p≈ô√≠chut√≠ a steeping ƒçasy
≈ò√°dky 200-500:   Inicializace, autentizace (Clerk)
≈ò√°dky 500-1000:  UI funkce (showPage, navigace, mod√°ly)
≈ò√°dky 1000-1500: Ukl√°d√°n√≠ recept≈Ø, produkty
≈ò√°dky 1500-2000: Editace recept≈Ø, zobrazen√≠ detailu
≈ò√°dky 2000-3000: V√Ωpoƒçetn√≠ funkce (calculateMix, calculateProMix)
≈ò√°dky 3000-4000: Liquid PRO multi-flavor logika
≈ò√°dky 4000-5000: V√Ωsledky, tabulky, zobrazen√≠
≈ò√°dky 5000-5500: P≈ôipom√≠nky zr√°n√≠ (reminders)
≈ò√°dky 5500-6000: Kontakt, menu, pomocn√© funkce
≈ò√°dky 6000+:     window.* exporty pro glob√°ln√≠ p≈ô√≠stup
```

### P≈ôeklady - D≈ÆLE≈ΩIT√â

**Um√≠stƒõn√≠:** `locales/` slo≈æka

**Referenƒçn√≠ soubor:** `locales/cs.json` - V≈ΩDY porovn√°vat s t√≠mto!

**Pou≈æit√≠ v HTML:**
```html
<span data-i18n="section.key">Fallback text</span>
<input data-i18n-placeholder="section.key" placeholder="Fallback">
<button data-i18n-title="section.key" title="Fallback">
```

**Pou≈æit√≠ v JS:**
```javascript
const text = t('section.key', 'Fallback text');
// Po dynamick√©m renderov√°n√≠:
window.i18n.applyTranslations();
```

**Hlavn√≠ sekce v JSON:**
- `meta` - k√≥d jazyka, n√°zev
- `nav` - navigace (home, menu, account)
- `auth` - p≈ôihl√°≈°en√≠, profil
- `form` - formul√°≈ôov√© popisky
- `results` - v√Ωsledky v√Ωpoƒçtu
- `save_recipe` - ukl√°d√°n√≠ receptu
- `reminder` - p≈ôipom√≠nky zr√°n√≠
- `recipe_detail` - detail receptu
- `common` - obecn√© (save, cancel, delete, day/days)

### Grafika a ikony
```
icons/
‚îú‚îÄ‚îÄ icon-192.png      # PWA ikona mal√°
‚îú‚îÄ‚îÄ icon-512.png      # PWA ikona velk√°  
‚îú‚îÄ‚îÄ icon.svg          # Zdrojov√© SVG
‚îú‚îÄ‚îÄ og-image.png      # Open Graph (1200x630px) - POVINN√ù FORM√ÅT!
‚îî‚îÄ‚îÄ og-image.svg      # Zdrojov√© SVG pro OG
```

### Supabase Backend

**Edge funkce:** `supabase/functions/`

| Funkce | √öƒçel | Vol√° se z | verify_jwt |
|--------|------|-----------|------------|
| `billing/` | Fakturace | Frontend | true |
| `contact/` | Kontaktn√≠ formul√°≈ô | Frontend | true |
| `geolocation/` | Geolokace u≈æivatele | Frontend | true |
| `gpwebpay/` | Platebn√≠ br√°na callback | GP WebPay (extern√≠) | **false** |
| `idoklad/` | iDoklad integrace | gpwebpay (intern√≠) | **false** |
| `invoice/` | Generov√°n√≠ faktur | Frontend + gpwebpay | true |
| `refund/` | Refundace | Frontend | true |
| `reminder-notify/` | Notifikace (CRON) | pg_cron | true |
| `subscription/` | P≈ôedplatn√© | Frontend | true |
| `user-cleanup/` | Maz√°n√≠ √∫ƒçt≈Ø (CRON) | pg_cron | true |

**D≈ÆLE≈ΩIT√â - verify_jwt konfigurace v `supabase/config.toml`:**
```toml
[functions.gpwebpay]
verify_jwt = false  # GP WebPay pos√≠l√° callback bez Authorization headeru

[functions.idoklad]
verify_jwt = false  # Vol√°no z gpwebpay pomoc√≠ service_role_key
```

**Architektura vol√°n√≠ p≈ôi platbƒõ:**
```
U≈æivatel ‚Üí Frontend ‚Üí subscription (vytvo≈ô√≠ subscription)
         ‚Üí Frontend ‚Üí gpwebpay (z√≠sk√° payment URL)
         ‚Üí U≈æivatel p≈ôesmƒõrov√°n na GP WebPay
         ‚Üí GP WebPay callback ‚Üí gpwebpay funkce
                              ‚Üí gpwebpay vol√° idoklad (intern√≠ HTTP fetch)
                              ‚Üí idoklad vytvo≈ô√≠ fakturu v iDoklad API
                              ‚Üí idoklad ulo≈æ√≠ do DB
                              ‚Üí gpwebpay vol√° invoice (email)
```

**Datab√°zov√© tabulky:**
| Tabulka | √öƒçel | Kl√≠ƒçov√© sloupce |
|---------|------|-----------------|
| `recipes` | Ulo≈æen√© recepty | id, clerk_id, name, recipe_data |
| `products` | Obl√≠ben√© produkty | id, clerk_id, name, url |
| `reminders` | P≈ôipom√≠nky zr√°n√≠ | id, recipe_id, remind_at, mixed_at |
| `subscriptions` | P≈ôedplatn√© | id, clerk_id, status, expires_at, user_country |
| `invoices` | Faktury | id, clerk_id, idoklad_id, amount, currency |
| `payments` | Platby | id, clerk_id, order_number, status |
| `users` | U≈æivatel√© | clerk_id, email, locale, subscription_status |
| `user_settings` | Nastaven√≠ | clerk_id, language, theme |

---

## üé® GRAFIKA A STYLING

### Barevn√© sch√©ma (CSS promƒõnn√© v styles.css)
```css
--neon-cyan: #00ffff;      /* Prim√°rn√≠ - tlaƒç√≠tka, odkazy */
--neon-pink: #ff00ff;      /* Sekund√°rn√≠ - akcenty, login */
--neon-green: #00ff00;     /* Sekce "P≈ôed m√≠ch√°n√≠m" */
--neon-purple: #bb86fc;    /* √övodn√≠ text, info boxy */
--bg-dark: #0a0a0a;        /* Tmav√© pozad√≠ */
--bg-card: #1a1a2e;        /* Karty, mod√°ly */
```

### Tlaƒç√≠tka - typy a pou≈æit√≠

| T≈ô√≠da | Pou≈æit√≠ | Barva |
|-------|---------|-------|
| `.neon-button` | Hlavn√≠ akce (Vypoƒç√≠tat, Ulo≈æit) | Cyan |
| `.neon-button.secondary` | Sekund√°rn√≠ akce | Pink |
| `.neon-button.btn-green` | Potvrzen√≠ | Zelen√° |
| `.neon-button.btn-red` | Smazat, Zru≈°it | ƒåerven√° |
| `.mode-button.cyan` | eLiquid kalkul√°tor | Cyan s pulzuj√≠c√≠m textem |
| `.mode-button.pink` | ≈òedƒõn√≠ nikotinu | Pink s pulzuj√≠c√≠m textem |
| `.nav-btn` | Navigace (Dom≈Ø, Menu) | Cyan border |
| `.nav-btn.login-btn` | M≈Øj √∫ƒçet | Pink border a pulz |

### Animace

**Pulzuj√≠c√≠ text (mode-button):**
```css
@keyframes textGlowWave { /* v styles.css */ }
/* Aplikuje se na .mode-button .mode-title .char */
/* Ka≈æd√Ω znak m√° animation-delay pro vlnov√Ω efekt */
```

**Pulzuj√≠c√≠ border (ostatn√≠ tlaƒç√≠tka):**
```css
@keyframes border-pulse-sweep { /* v styles.css */ }
/* Aplikuje se p≈ôes ::after pseudo-element */
/* Gradient bƒõ≈æ√≠ zleva doprava */
```

**D≈ÆLE≈ΩIT√â:** Po zmƒõnƒõ jazyka se mus√≠ znovu inicializovat animace textu:
```javascript
// V index.html je window.animateModeButtons()
// Vol√° se p≈ôi DOMContentLoaded a localeChanged
```

### Sekce s or√°mov√°n√≠m

| T≈ô√≠da | Obsah | Barva or√°mov√°n√≠ |
|-------|-------|-----------------|
| `.app-description-box` | √övodn√≠ popis aplikace | Fialov√° (#bb86fc) |
| `.prep-box` | "P≈ôed m√≠ch√°n√≠m si p≈ôipravte" | Neon zelen√° |
| `.disclaimer-box` | Upozornƒõn√≠ | ≈Ωlut√°/oran≈æov√° |
| `.results-container` | V√Ωsledky v√Ωpoƒçtu | Cyan gradient |

### Mod√°ly (v index.html)

| ID | √öƒçel | Otev√≠r√° funkce |
|----|------|----------------|
| `#saveRecipeModal` | Nov√Ω recept | `showSaveRecipeModal()` |
| `#editRecipeModal` | √öprava receptu | `showEditRecipeForm()` |
| `#addReminderModal` | Nov√° p≈ôipom√≠nka | `showAddReminderModal(recipeId)` |
| `#editReminderModal` | √öprava p≈ôipom√≠nky | `showEditReminderModal(id, recipeId)` |
| `#userProfileModal` | U≈æivatelsk√Ω profil | `showUserProfileModal()` |
| `#menuModal` | Hlavn√≠ menu | `showMenuModal()` |
| `#loginRequiredModal` | V√Ωzva k p≈ôihl√°≈°en√≠ | `showLoginRequiredModal()` |

### Tabulka v√Ωsledk≈Ø (konzistentn√≠ styling)

**D≈ÆLE≈ΩIT√â:** P≈ôi zobrazen√≠ receptu pou≈æ√≠t stejn√© t≈ô√≠dy jako p≈ôi v√Ωpoƒçtu!

```html
<div class="results-table-container">
  <table class="results-table">
    <tr>
      <td class="ingredient-name">N√°zev</td>
      <td class="ingredient-value">10.5 ml</td>
      <td class="ingredient-percent">21%</td>
      <td class="ingredient-drops">105</td>
    </tr>
  </table>
</div>
```

T≈ô√≠dy definov√°ny v `styles.css` sekce `/* Results table */`

---

## üîß KL√çƒåOV√â FUNKCE

### Kalkulace e-liquidu

```javascript
// Z√°kladn√≠ kalkul√°tor (jedna p≈ô√≠chu≈•)
calculateMix() 
// - ƒåte hodnoty z formul√°≈ôe #mixerForm
// - Vol√° displayResults(data, {formType: 'eliquid', flavorType: selectedFlavor})

// Shake & Vape (bez nikotinu, rychl√©)
calculateShakeVape()
// - Formul√°≈ô #shakevapeForm
// - Vol√° displayResults(data, {formType: 'shakevape', flavorType: 'fruit'})

// Liquid PRO (v√≠ce p≈ô√≠chut√≠)
calculateProMix()
// - Formul√°≈ô #proMixerForm
// - Podporuje a≈æ 5 p≈ô√≠chut√≠ s vlastn√≠mi %
// - Vol√° displayResults(data, {formType: 'liquidpro', flavors: flavorsData})
```

**D≈ÆLE≈ΩIT√â pro p≈ôipom√≠nky:** `displayResults` ukl√°d√° `flavorType` do `currentRecipeData` pro v√Ωpoƒçet steeping ƒçasu!

### Zobrazen√≠ v√Ωsledk≈Ø

```javascript
displayResults(data, extraData)
// - data: { vg, pg, nic, flavor, total, drops, ... }
// - extraData: { formType, flavorType, flavors }
// - Ukl√°d√° do window.currentRecipeData pro pozdƒõj≈°√≠ ulo≈æen√≠
// - Renderuje HTML do #resultsContent

refreshResultsTable()
// - Vol√° se p≈ôi zmƒõnƒõ jazyka (event localeChanged)
// - P≈ôerenderuje v√Ωsledky se spr√°vn√Ωmi p≈ôeklady
```

### Recepty - ukl√°d√°n√≠ a zobrazen√≠

```javascript
// Otev≈ô√≠t modal pro NOV√ù recept
showSaveRecipeModal()
// - Resetuje formul√°≈ô
// - Nastav√≠ tlaƒç√≠tko na t('save_recipe.save_button')
// - Inicializuje p≈ôipom√≠nku (za≈°krtnutou)

// Otev≈ô√≠t modal pro √öPRAVU
showEditRecipeForm()
// - Vypln√≠ formul√°≈ô daty z currentViewingRecipe
// - Zmƒõn√≠ tlaƒç√≠tko na t('save_recipe.save_changes')
// - Zmƒõn√≠ nadpis na t('save_recipe.edit_title')

// Ulo≈æit recept do Supabase
saveRecipe()
// - Validuje formul√°≈ô
// - Ukl√°d√° recipe_data vƒçetnƒõ flavorType!
// - Volitelnƒõ vytvo≈ô√≠ p≈ôipom√≠nku

// Zobrazit detail receptu
viewRecipeDetail(recipeId)
// - Naƒçte recept z DB
// - Nastav√≠ window.currentViewingRecipe (D≈ÆLE≈ΩIT√â!)
// - Vol√° displayRecipeDetail()
// - Po renderov√°n√≠ vol√° loadRecipeReminders()

// Renderovat HTML detailu
displayRecipeDetail(recipe, contentId)
// - contentId: 'recipeDetailContent' nebo 'favoriteRecipeDetailContent'
// - MUS√ç pou≈æ√≠t stejn√© CSS t≈ô√≠dy jako displayResults()!
```

### P≈ôipom√≠nky zr√°n√≠ (reminders)

```javascript
// Otev≈ô√≠t modal pro novou p≈ôipom√≠nku
showAddReminderModal(recipeId)
// - Hled√° flavorType v recipe.recipe_data.flavorType
// - Fallback: hled√° v recipe.recipe_data.ingredients
// - Nastav√≠ currentReminderSteepingDays podle flavorDatabase

// Automaticky vypoƒç√≠tat datum p≈ôipom√≠nky
updateReminderDate()
// - Bere datum m√≠ch√°n√≠ z #reminderMixDate
// - P≈ôiƒçte currentReminderSteepingDays
// - Nastav√≠ #reminderRemindDate

// Naƒç√≠st p≈ôipom√≠nky pro recept
loadRecipeReminders(recipeId, showAll = false)
// - ≈òad√≠ od NEJNOVƒöJ≈†√çCH (nejvy≈°≈°√≠ remind_at naho≈ôe)
// - Zobrazuje max 3, pak "Zobrazit v≈°echny"

// Renderovat jednu p≈ôipom√≠nku
renderReminderItem(reminder, recipeId)
// - Pou≈æ√≠v√° t() pro p≈ôeklady
// - Form√°tuje datum podle aktu√°ln√≠ho locale
```

### P≈ôeklady - i18n syst√©m

```javascript
// Z√≠skat p≈ôeklad
t(key, fallback)
// P≈ô√≠klad: t('save_recipe.title', 'Ulo≈æit recept')

// Aplikovat p≈ôeklady na DOM elementy
window.i18n.applyTranslations()
// - Hled√° [data-i18n], [data-i18n-placeholder], [data-i18n-title]
// - VOLAT PO KA≈ΩD√âM DYNAMICK√âM RENDEROV√ÅN√ç!

// Zmƒõnit jazyk
window.i18n.setLocale(localeCode)
// - Naƒçte JSON soubor
// - Ulo≈æ√≠ preference do DB (pokud p≈ôihl√°≈°en)
// - Dispatchne event 'localeChanged'

// Event p≈ôi zmƒõnƒõ jazyka
window.addEventListener('localeChanged', () => {
    refreshResultsTable();      // P≈ôerenderovat v√Ωsledky
    refreshRecipeDetail();      // P≈ôerenderovat detail receptu
    window.animateModeButtons(); // Znovu animovat tlaƒç√≠tka
});
```

### Datab√°ze p≈ô√≠chut√≠ (flavorDatabase)

```javascript
// Definov√°no na zaƒç√°tku app.js (~≈ô√°dky 50-170)
const flavorDatabase = [
    { value: 'none', name: '≈Ω√°dn√°', steepingDays: 0 },
    { value: 'fruit', name: 'Ovocn√°', steepingDays: 3 },
    { value: 'citrus', name: 'Citrusov√°', steepingDays: 3 },
    { value: 'menthol', name: 'Mentolov√°', steepingDays: 1 },
    { value: 'mint', name: 'M√°tov√°', steepingDays: 2 },
    { value: 'cream', name: 'Kr√©mov√°', steepingDays: 7 },
    { value: 'custard', name: 'Pudink', steepingDays: 14 },
    { value: 'dessert', name: 'Dezertn√≠', steepingDays: 7 },
    { value: 'bakery', name: 'Peƒçivo', steepingDays: 10 },
    { value: 'tobacco', name: 'Tab√°kov√°', steepingDays: 21 },
    { value: 'beverage', name: 'N√°pojov√°', steepingDays: 5 },
    { value: 'candy', name: 'Bonb√≥nov√°', steepingDays: 4 },
    { value: 'nut', name: 'O≈ô√≠≈°kov√°', steepingDays: 10 },
    { value: 'spice', name: 'Ko≈ôenƒõn√°', steepingDays: 14 },
    { value: 'floral', name: 'Kvƒõtinov√°', steepingDays: 7 }
];

// P≈ôi v√≠ce p≈ô√≠chut√≠ch (Liquid PRO): pou≈æ√≠t NEJDEL≈†√ç steeping ƒças!
```

### Glob√°ln√≠ promƒõnn√© (window.*)

```javascript
window.currentRecipeData     // Aktu√°ln√≠ vypoƒç√≠tan√Ω recept
window.currentViewingRecipe  // Aktu√°lnƒõ zobrazen√Ω ulo≈æen√Ω recept
window.i18n                  // i18n objekt
window.LiquiMixerDB          // Datab√°zov√© operace
window.Clerk                 // Autentizace

// Exportovan√© funkce (na konci app.js)
window.calculateMixture = calculateMix;
window.showSaveRecipeModal = showSaveRecipeModal;
window.viewRecipeDetail = viewRecipeDetail;
window.showAddReminderModal = showAddReminderModal;
// ... a dal≈°√≠
```

---

## üì± PWA & NOTIFIKACE

- `manifest.json` - PWA manifest
- `sw.js` - Service Worker pro offline
- `firebase-messaging-sw.js` - Firebase Cloud Messaging
- `fcm.js` - FCM client-side logika

---

## üöÄ DEPLOYMENT

### Frontend (Zeabur)
- Hosting: Zeabur (automatick√Ω deploy z GitHub)
- Branch: `main`
- Konfigurace: `zeabur.json`
- URL: https://liquimixer.zeabur.app a https://www.liquimixer.com

### Supabase Edge Functions

**Nasazen√≠ jedn√© funkce:**
```bash
npx supabase functions deploy idoklad --project-ref krwdfxnvhnxtkhtkbadi
```

**Nasazen√≠ v≈°ech funkc√≠:**
```bash
npx supabase functions deploy --project-ref krwdfxnvhnxtkhtkbadi
```

**D≈ÆLE≈ΩIT√â:**
- `config.toml` se aplikuje p≈ôi nasazen√≠ funkc√≠
- Po zmƒõnƒõ `verify_jwt` v config.toml je nutn√© znovu nasadit dotƒçen√© funkce
- Project ref: `krwdfxnvhnxtkhtkbadi`

**Logy funkc√≠:**
- Dashboard: https://supabase.com/dashboard/project/krwdfxnvhnxtkhtkbadi/functions
- Kliknout na funkci ‚Üí Logs

**Testov√°n√≠ lok√°lnƒõ (nedoporuƒçeno pro tento projekt):**
- Edge funkce nelze plnƒõ testovat lok√°lnƒõ kv≈Øli secrets a extern√≠m API
- Pro testov√°n√≠ pou≈æ√≠t produkƒçn√≠ deploy a sledovat logy

### SQL Migrace

**Spu≈°tƒõn√≠ migrace:**
```bash
npx supabase db push --project-ref krwdfxnvhnxtkhtkbadi
```

**Nebo manu√°lnƒõ v SQL Editoru:**
- Dashboard ‚Üí SQL Editor ‚Üí New Query ‚Üí vlo≈æit SQL ‚Üí Run

---

## üìù ƒåAST√â PROBL√âMY A ≈òE≈†EN√ç

### P≈ôeklady se nenaƒç√≠taj√≠
1. Zkontrolovat JSON syntax v jazykov√©m souboru
2. Zkontrolovat zda kl√≠ƒç existuje v dan√©m souboru
3. Zkontrolovat zda se vol√° `applyTranslations()` po zmƒõnƒõ obsahu

### Tlaƒç√≠tka/texty se nep≈ôekl√°daj√≠
1. Hardcoded text v JS ‚Üí zmƒõnit na `t('key', 'fallback')`
2. Chybƒõj√≠c√≠ `data-i18n` atribut v HTML
3. Dynamicky generovan√Ω obsah ‚Üí volat `applyTranslations()` po renderov√°n√≠

### Grafika receptu se nezobrazuje
1. Zkontrolovat CSS t≈ô√≠dy (`results-table-container`, `ingredient-name`, atd.)
2. Zkontrolovat zda se pou≈æ√≠v√° stejn√° struktura jako v `displayResults()`

### P≈ôipom√≠nky nefunguj√≠
1. `window.currentViewingRecipe` mus√≠ b√Ωt nastaveno
2. `flavorType` mus√≠ b√Ωt ulo≈æeno v `recipe_data`
3. Pro star≈°√≠ recepty fallback hled√° `flavorType` v `ingredients`

---

## üìÖ HISTORIE ZMƒöN A PROBL√âM≈Æ

### 13.1.2026 (odpoledne v2) - iDoklad VatRateType chyba

**Symptom:**
- `iDoklad create invoice error: {"ErrorCode":127,"Message":"VatRate 21 and VatRateType Reduced1 for dates 1/13/2026 has not been found."}`

**P≈ô√≠ƒçina:**
- Pos√≠lali jsme SOUƒåASNƒö `VatRate: 21` i `VatRateType: 0`
- iDoklad to interpretoval jako konflikt a pou≈æil v√Ωchoz√≠ VatRateType z nastaven√≠ (1 = Reduced1 = 12%)
- Kombinace VatRate: 21 + VatRateType: 1 (Reduced1 = 12%) je neplatn√°

**≈òe≈°en√≠:**
- Odstranit `VatRate` z polo≈æky faktury
- Pou≈æ√≠t POUZE `VatRateType` - iDoklad s√°m pou≈æije spr√°vnou sazbu

```typescript
Items: [{
  VatRateType: vatRate.type, // 0 = Basic (21%), 3 = Zero (0%)
  // VatRate: vatRate.rate,  // ODSTRANIT! Zp≈Øsobuje konflikt
  PriceType: 0,
}]
```

**Pouƒçen√≠:**
- V iDoklad API pou≈æ√≠vat VatRateType NEBO VatRate, NIKDY oboje souƒçasnƒõ
- VatRateType: 0 = Basic (21%), 1 = Reduced1 (12%), 3 = Zero (0%)

---

### 13.1.2026 (odpoledne) - iDoklad Edge Function nefungovala

**Symptom:**
- Po platbƒõ se v logu gpwebpay zobrazovalo: `iDoklad invoice creation failed: undefined`
- iDoklad result: `{"code":401,"message":"Inva..."}` (401 Unauthorized)
- V logu idoklad funkce NEBYLY ≈Ω√ÅDN√â z√°znamy - funkce nebyla v≈Øbec vol√°na

**P≈ô√≠ƒçina:**
- Supabase Edge Functions vy≈æaduj√≠ buƒè validn√≠ JWT token NEBO `verify_jwt = false` v `config.toml`
- V `config.toml` bylo `verify_jwt = false` nastaveno pouze pro `gpwebpay`, ale NE pro `idoklad`
- Kdy≈æ `gpwebpay` volala `idoklad` internƒõ p≈ôes HTTP fetch, Supabase odm√≠tal po≈æadavek s 401 **je≈°tƒõ p≈ôed t√≠m, ne≈æ se k√≥d funkce spustil**

**≈òe≈°en√≠ v `supabase/config.toml`:**
```toml
[functions.gpwebpay]
# Disable JWT verification for GP WebPay callback
# GP WebPay sends callbacks without Authorization header
verify_jwt = false

[functions.idoklad]
# Disable JWT verification for internal calls from gpwebpay
# gpwebpay calls idoklad using service_role_key
verify_jwt = false
```

**Debug logy p≈ôid√°ny v `supabase/functions/idoklad/index.ts`:**
```typescript
serve(async (req) => {
  console.log('=== iDoklad function called ===')
  console.log('Method:', req.method)
  console.log('URL:', req.url)
  // ...
```

**Nasazen√≠:**
1. Git push: `cmd /c "git add -A && git commit -m fix-idoklad-jwt-verification && git push origin main"`
2. Supabase deploy: `npx supabase functions deploy --project-ref krwdfxnvhnxtkhtkbadi`

**Pouƒçen√≠:**
- Kdy≈æ Edge funkce A vol√° Edge funkci B p≈ôes HTTP, funkce B tak√© pot≈ôebuje `verify_jwt = false` pokud A pou≈æ√≠v√° service_role_key
- Pokud funkce neloguje V≈ÆBEC NIC, probl√©m je na √∫rovni Supabase routingu (JWT verifikace), ne v k√≥du funkce
- V≈ædy p≈ôidat debug logy na √∫pln√Ω zaƒç√°tek `serve()` handleru pro diagnostiku

---

### 13.1.2026 (pozdƒõ veƒçer) - Opravy VAT, krajiny a jazyka v3

**Principy implementace:**
- **M√≠sto plnƒõn√≠** = krajina z√°kazn√≠ka z IP geolokace ‚Üí urƒçuje DPH a krajinu v iDoklad
- **Jazyk** = nez√°visl√Ω na m√≠stu plnƒõn√≠, vol√≠ u≈æivatel nebo se detekuje z prohl√≠≈æeƒçe

**DPH logika:**
- EU krajiny: fin√°ln√≠ cena (59 CZK/2.40 EUR/2.90 USD) JE S DPH 21%
- Mimo EU: fin√°ln√≠ cena JE BEZ DPH (0%)

**Vy≈ôe≈°en√© probl√©my:**

#### 1. Apple Pay ikona - nov√° SVG
**Probl√©m:** P≈Øvodn√≠ ikona byla neƒçiteln√°, zobrazovala "ired".

**≈òe≈°en√≠ v `index.html`:**
- Nahrazena jednoduch√° b√≠l√° Apple Pay SVG ikona s ƒçiteln√Ωm logem

#### 2. IP geolokace ‚Üí krajina fallback
**Probl√©m:** P≈ôi selh√°n√≠ geolokace se pou≈æ√≠val jazyk jako krajina (nap≈ô. 'ar-SA' ‚Üí 'AR').

**≈òe≈°en√≠ v `app.js`:**
```javascript
const localeToCountry = {
  'cs': 'CZ', 'sk': 'SK', 'de': 'DE', 'ar-SA': 'SA', ...
}
userLocation.countryCode = localeToCountry[currentLocale] || 'CZ'
```

#### 3. iDoklad VatRateType logika
**Probl√©m:** Pou≈æ√≠val se statick√Ω seznam non-EU zem√≠, kter√Ω nebyl kompletn√≠.

**≈òe≈°en√≠ v `supabase/functions/idoklad/index.ts`:**
- Zmƒõnƒõna logika: m√≠sto seznamu non-EU zem√≠ ‚Üí seznam EU zem√≠
- Pokud krajina je v EU seznamu ‚Üí 21% (type: 0 = Basic)
- Pokud krajina NEN√ç v EU ‚Üí 0% (type: 3 = Zero/osvobozeno)

#### 4. iDoklad getCountryId roz≈°√≠≈ôen
**Probl√©m:** Mapov√°n√≠ krajin na iDoklad ID bylo ne√∫pln√©.

**≈òe≈°en√≠ v `supabase/functions/idoklad/index.ts`:**
- P≈ôid√°no 30+ krajin vƒçetnƒõ v≈°ech EU + mimo EU
- Bl√≠zk√Ω v√Ωchod: SA, AE, IL, QA, KW
- Asie: JP, KR, CN, TW, SG, HK

#### 5. Invoice ID lookup vylep≈°en
**Probl√©m:** P≈ôi neplatn√©m UUID form√°tu Supabase vracel chybu.

**≈òe≈°en√≠ v `supabase/functions/invoice/index.ts`:**
- Detekce form√°tu ID (UUID vs. ƒç√≠slo vs. ostatn√≠)
- UUID: hled√°n√≠ pouze v `id` sloupci
- ƒå√≠slo: hled√°n√≠ pouze v `idoklad_id` sloupci
- Nezn√°m√Ω form√°t: zkusit oboje s `maybeSingle()`

#### 6. Jazyk pro email p≈ôeklady
**Probl√©m:** `getEmailTranslations('ar-SA')` normalizovalo na 'ar-sa' (lowercase), ale kl√≠ƒç byl 'ar-SA'.

**≈òe≈°en√≠ v `supabase/functions/_shared/email-translations.ts`:**
```typescript
// Zachovat case pro region k√≥dy (ar-SA, zh-CN)
const normalizedLocale = locale.replace('_', '-') // bez toLowerCase
// Speci√°ln√≠ mapov√°n√≠
const specialMappings = { 'ar': 'ar-SA', 'zh': 'zh-CN' }
```

#### 7. Subscription pricing lookup
**Probl√©m:** Pricing se hledal podle jazyka (`locale`), ale pro nƒõkter√© jazyky neexistoval cenn√≠k.

**≈òe≈°en√≠ v `supabase/functions/subscription/index.ts`:**
- Mapov√°n√≠ krajiny na pricing locale
- Fallback na 'en' (EUR) pokud cenn√≠k pro danou krajinu neexistuje

**Nasazeno:**
- Edge funkce: idoklad, invoice, subscription, gpwebpay
- Frontend: index.html, app.js
- Git commit: "Fix: Apple Pay icon, VAT calculation, country handling, invoice lookup, and language fallback"

---

### 13.1.2026 (veƒçer) - Opravy faktur v2

**Vy≈ôe≈°en√© probl√©my:**

#### 1. Chybƒõj√≠c√≠ p≈ôeklady invoice_email_* (22 jazyk≈Ø)
**Probl√©m:** Pouze 9 jazyk≈Ø mƒõlo p≈ôeklady pro fakturn√≠ email, ostatn√≠ zobrazovaly "undefined".

**≈òe≈°en√≠ v `supabase/functions/_shared/email-translations.ts`:**
- Doplnƒõny v≈°echny `invoice_email_*` kl√≠ƒçe pro 22 chybƒõj√≠c√≠ch jazyk≈Ø
- Jazyky: pt, nl, da, sv, no, fi, et, lv, lt, hu, ro, bg, hr, sr, el, tr, ru, uk, ar-SA, ja, ko, zh-CN, zh-TW

#### 2. iDoklad p≈ôeklady v ƒçe≈°tinƒõ
**Probl√©m:** Polo≈æky na faktu≈ôe v iDoklad byly v jazyce z√°kazn√≠ka m√≠sto ƒçe≈°tiny.

**≈òe≈°en√≠ v `supabase/functions/idoklad/index.ts`:**
```typescript
// D≈ÆLE≈ΩIT√â: P≈ôeklady pro iDoklad V≈ΩDY v ƒçe≈°tinƒõ (po≈æadavek √∫ƒçetnictv√≠)
const t = getEmailTranslations('cs') // V≈ædy ƒçe≈°tina pro iDoklad
```

#### 3. iDoklad VatRateType chyba
**Probl√©m:** Chyba "VatRate 21 and VatRateType Reduced1 for dates 1/13/2026 has not been found."

**P≈ô√≠ƒçina:** `VatRateType: 1` znamen√° `Reduced1` (sn√≠≈æen√° sazba 12%), ne `Basic` (21%).

**≈òe≈°en√≠ v `supabase/functions/idoklad/index.ts`:**
```typescript
// iDoklad VatRateType hodnoty:
// 0 = Basic (z√°kladn√≠ sazba - 21%)
// 1 = Reduced1 (sn√≠≈æen√° 1 - 12%)
// 3 = Zero (nulov√°/osvobozeno - 0%)
return { rate: 21, type: 0 } // type: 0 = Basic (21%)
```

#### 4. Debug odkazu na fakturu
**Probl√©m:** URL `invoice.html?id=59851040` zobrazoval "Faktura nenalezena".

**≈òe≈°en√≠ v `supabase/functions/invoice/index.ts`:**
- P≈ôid√°ny debug logy pro sledov√°n√≠ lookup procesu
- Fallback lookup podle `idoklad_id` konvertuje na string

#### 5. Apple Pay ikona
**Probl√©m:** Ikona nebyla rozpoznateln√° na tmav√©m pozad√≠.

**≈òe≈°en√≠ v `index.html`:**
- Nahrazena SVG ikonou ve stylu FontAwesome s b√≠lou v√Ωpln√≠ a or√°mov√°n√≠m

**Nasazen√© edge funkce:**
- `idoklad` - opraven√Ω VatRateType a ƒçesk√© p≈ôeklady
- `invoice` - debug logy pro lookup

---

### 13.1.2026 - Opravy faktur a UX

**Vy≈ôe≈°en√© probl√©my:**

#### 1. iDoklad DPH sazba 12% ‚Üí 21%
**Probl√©m:** iDoklad pou≈æ√≠val DPH sazbu zemƒõ kontaktu (SK = 12%) m√≠sto explicitn√≠ sazby.

**≈òe≈°en√≠ v `supabase/functions/idoklad/index.ts`:**
```typescript
Items: [{
  VatRateType: vatRate.type,
  VatRate: vatRate.rate, // EXPLICITNƒö 21 nebo 0 - iDoklad jinak pou≈æije sazbu zemƒõ kontaktu
}]
```

#### 2. Nefunkƒçn√≠ odkaz na fakturu z emailu
**Probl√©m:** URL `invoice.html?id=59847319` zobrazoval "Faktura nenalezena" - ƒç√≠slo bylo iDoklad ID, ale lookup hledal na≈°e DB ID.

**≈òe≈°en√≠ v `supabase/functions/invoice/index.ts`:**
```typescript
// Zkusit naj√≠t podle na≈°eho ID, pak fallback na iDoklad ID
const { data: invoiceById } = await supabaseAdmin.from('invoices').select('*').eq('id', invoiceId).single()
if (!invoiceById) {
  const { data: invoiceByIdoklad } = await supabaseAdmin.from('invoices').select('*').eq('idoklad_id', invoiceId).single()
}
```

#### 3. Dvojjazyƒçn√° faktura (jazyk u≈æivatele + angliƒçtina)
**Po≈æadavek:** Faktura v emailu i na webu mus√≠ obsahovat dvƒõ verze - naho≈ôe v jazyku u≈æivatele, dole v angliƒçtinƒõ.

**≈òe≈°en√≠:**
- `supabase/functions/invoice/index.ts`: Nov√© funkce `generateSingleInvoiceHtml()` a `generateSingleIdokladInvoiceHtml()` pro generov√°n√≠ jedn√© verze
- `getEmailBody()` a `getEmailBodyFromIdoklad()` upraveny pro dvojjazyƒçnou verzi
- `invoice.html`: P≈ôid√°n druh√Ω kontejner pro anglickou verzi s oddƒõlovaƒçem

#### 4. Zobrazen√≠ DPH na faktu≈ôe
**Po≈æadavek:** Faktura mus√≠ zobrazovat: cena bez DPH, DPH ƒç√°stka a sazba, celkem s DPH.

**≈òe≈°en√≠:** Ji≈æ implementov√°no v p≈ôedchoz√≠ch √∫prav√°ch, ovƒõ≈ôeno ≈æe funguje spr√°vnƒõ.

#### 5. Odhl√°≈°en√≠ po platbƒõ
**Probl√©m:** U≈æivatel byl po redirectu z GP WebPay odhl√°≈°en (Clerk session vypr≈°ela).

**≈òe≈°en√≠ v `app.js`:**
- P≈ôed redirectem: `localStorage.setItem('liquimixer_pending_payment_clerk_id', window.Clerk.user.id)`
- Po n√°vratu: Pokud nen√≠ p≈ôihl√°≈°en po 10s, zobraz√≠ se info notifikace a login modal
- Nov√Ω p≈ôeklad `subscription.payment_success_login_required`

#### 6. Apple Pay ikona
**Probl√©m:** Komplexn√≠ SVG nebyla rozpoznateln√° na tmav√©m pozad√≠.

**≈òe≈°en√≠ v `index.html`:**
```html
<svg viewBox="0 0 50 21" style="background: #000; border-radius: 3px; padding: 2px 6px;">
  <!-- Apple logo + "Pay" text -->
</svg>
```

**Soubory upraven√©:**
| Soubor | Zmƒõna |
|--------|-------|
| `supabase/functions/idoklad/index.ts` | VatRate explicitnƒõ |
| `supabase/functions/invoice/index.ts` | Fallback lookup + dvojjazyƒçn√° faktura |
| `invoice.html` | Dvojjazyƒçn√© zobrazen√≠ |
| `app.js` | Ulo≈æit clerk_id p≈ôed platbou, login modal po n√°vratu |
| `index.html` | Apple Pay SVG s ƒçern√Ωm pozad√≠m |
| `styles.css` | Apple Pay filtry odebr√°ny |
| `locales/cs.json`, `locales/en.json` | Nov√Ω p≈ôeklad `payment_success_login_required` |

---

### 12.1.2026 - iDoklad integrace + Invoice Language Priority

**Vyrie≈°en√© probl√©my:**

#### 1. iDoklad Invoice Pricing
**Probl√©m:** Fakt√∫ra zobrazovala 59 Kƒç bez DPH + 12% DPH = 66,08 Kƒç namiesto 59 Kƒç S DPH.

**Rie≈°enie v `supabase/functions/idoklad/index.ts`:**
```typescript
Items: [{
  UnitPrice: unitPriceWithoutVat, // Cena BEZ DPH
  PriceType: 0, // 0 = cena BEZ DPH (iDoklad prid√° DPH)
  VatRateType: vatRate.type,
}]
```

**Nefunguj√∫ce rie≈°enie:** `PriceType: 1` s cenou S DPH - iDoklad to interpretoval ako cenu bez DPH.

#### 2. iDoklad Payment Method
**Probl√©m:** Fakt√∫ra zobrazovala "P≈ôevodem" namiesto "Kartou".

**Rie≈°enie:** Funkcia `getCardPaymentOptionId()` hƒæad√° alebo vytv√°ra platbu kartou.

#### 3. Invoice Language Priority
**Probl√©m:** Fakt√∫ra pri≈°la v CZ jazyku aj keƒè mal pou≈æ√≠vateƒæ nastaven√Ω SK jazyk.

**Rie≈°enie v `supabase/functions/gpwebpay/index.ts`:**
```typescript
// Priorita jazyka:
// 1. users.locale - jazyk pou≈æ√≠vateƒæa z profilu
// 2. subscription.user_locale - jazyk z GP WebPay lokaliz√°cie (fallback)
const invoiceLocale = user?.locale || subscription?.user_locale || 'cs'
```

**D√¥le≈æit√©:** Da≈àov√° lokaliz√°cia (`country`) zost√°va nezmenen√°!

#### 4. Subscription Modal Translations
**Probl√©m:** Modal sa zobrazoval v arabƒçine/angliƒçtine.

**Rie≈°enie:** Doplnen√© kƒæ√∫ƒçe do v≈°etk√Ωch 31 jazykov:
- `register_first`, `error_not_logged_in`, `register_and_pay`
- `already_have_account`, `logged_in_as`, `pay_button_simple`
- `redirect_info`, `payment_success`, `payment_failed`, `payment_declined`

#### 5. Invoice.html Display
**Probl√©m:** Str√°nka nezobrazovala fakt√∫ru.

**Rie≈°enie:** 
- Pridan√© `apikey` header do fetch
- Pridan√© zobrazenie DPH (z√°klad, %, celkom)

#### 6. Apple Pay Logo
**Probl√©m:** Logo nebolo viditeƒæn√© na tmavom pozad√≠.

**Rie≈°enie:** Inline SVG s `fill="#ffffff"`.

**S√∫bory upraven√©:**
| S√∫bor | Zmena |
|-------|-------|
| `supabase/functions/idoklad/index.ts` | PriceType=0, PaymentOptionId |
| `supabase/functions/gpwebpay/index.ts` | Invoice language priority |
| `invoice.html` | VAT display |
| `index.html` | Apple Pay SVG |
| `locales/*.json` (25 s√∫borov) | Subscription modal preklady |

**SQL Script pre reset testovac√≠ch √∫ƒçtov:**
```sql
DELETE FROM payments WHERE clerk_id IN (SELECT clerk_id FROM users WHERE email ILIKE '%lapos%');
DELETE FROM invoices WHERE clerk_id IN (SELECT clerk_id FROM users WHERE email ILIKE '%lapos%');
DELETE FROM subscriptions WHERE clerk_id IN (SELECT clerk_id FROM users WHERE email ILIKE '%lapos%');
UPDATE users SET subscription_status = NULL, subscription_tier = NULL, subscription_id = NULL, subscription_expires_at = NULL WHERE email ILIKE '%lapos%';
```

---

### 9.1.2026 (veƒçer) - Autentizaƒçn√≠ flow - VY≈òE≈†ENO ‚úì
**PROBL√âM BYL VY≈òE≈†EN:** Po dokonƒçen√≠ Clerk registrace nedoch√°zelo k p≈ôesmƒõrov√°n√≠ na platebn√≠ br√°nu.

**P≈Øvodn√≠ symptom:**
- U≈æivatel pro≈°el registrac√≠ (vyplnil email, heslo, ovƒõ≈ôil k√≥d)
- Clerk session se vytvo≈ôila, u≈æivatel byl p≈ôihl√°≈°en
- Ale API vol√°n√≠ `/functions/v1/subscription` selh√°valo s 401 "Invalid JWT"

**≈òe≈°en√≠ (verze D autentizaƒçn√≠ho flow):**
- Kompletn√≠ redesign flow s pou≈æit√≠m `fromSubscription` flagu v localStorage
- U≈æivatel se nejprve registruje/p≈ôihl√°s√≠, pak teprve prob√≠h√° platba
- Oddƒõlen√≠ registrace od platby eliminovalo timing probl√©my s JWT tokenem

**Kl√≠ƒçov√© soubory:**
- `app.js` ≈ô√°dky 445-485: Clerk listener s pending payment logikou
- `app.js` ≈ô√°dky 5531-5560: `getClerkToken()` funkce
- `app.js` ≈ô√°dky 5740-5860: `processPayment()` funkce
- `app.js` ≈ô√°dky 5870-5900: `checkPendingPayment()` funkce

**Autentizaƒçn√≠ flow (jak m√° fungovat):**
1. U≈æivatel klikne "P≈ôihl√°≈°en√≠" ‚Üí zobraz√≠ se `loginModal` s Clerk SignIn
2. V Clerk klikne "Sign up" ‚Üí `MutationObserver` to zachyt√≠ ‚Üí zobraz√≠ `subscriptionModal`
3. V subscription modalu za≈°krtne OP, klikne "Zaplatit a aktivovat":
   - Nastav√≠ `localStorage.liquimixer_pending_payment = 'true'`
   - Skryje subscription modal
   - Zobraz√≠ `loginModal` v re≈æimu `signUp` (Clerk registrace)
4. U≈æivatel vypln√≠ registraci v Clerk (jm√©no, email, heslo, k√≥d)
5. Clerk listener detekuje p≈ôihl√°≈°en√≠:
   - Zkontroluje `pending_payment` flag v localStorage
   - Pokud `true`: ƒçek√° 2s ‚Üí vol√° `checkPendingPayment()`
6. `checkPendingPayment()`:
   - Vyma≈æe flags z localStorage
   - Vol√° `processPayment()`
7. `processPayment()`:
   - ƒåek√° 1s na stabilizaci
   - Z√≠sk√° Clerk token (retry a≈æ 20√ó)
   - Vol√° `/functions/v1/subscription` (action: create)
   - Vol√° `/functions/v1/gpwebpay` (action: create)
   - P≈ôesmƒõruje na platebn√≠ br√°nu

**AKTU√ÅLNƒö SELH√ÅV√Å V KROKU 7:** Token je "Invalid JWT"

**Konzolov√© chyby (lok√°ln√≠ i produkce):**
```
Subscription creation failed: 401 {"code":401,"message":"Invalid JWT"}
Payment processing error: Error: Failed to create subscription
```

**Chyba se vyskytuje i na produkci (https://liquimixer.com):**
- Stejn√° chyba 401 "Invalid JWT" p≈ôi vol√°n√≠ subscription API
- Probl√©m nen√≠ specifick√Ω pro localhost - je to Clerk‚ÜîSupabase JWT integrace

**Z√°loha:** `C:\Users\Tom√°≈°Lapos\Documents\Liquimixer_backup_2026-01-09_21-43`

**Zmƒõny implementovan√© dnes (p≈ôed probl√©mem):**
- ‚úÖ Odstranƒõn `authChoiceModal` - zjednodu≈°en√≠ flow
- ‚úÖ `showLoginModal(mode)` - dynamicky mountuje Clerk SignIn/SignUp
- ‚úÖ MutationObserver pro zachycen√≠ "Sign up" linku v Clerk ‚Üí p≈ôesmƒõrov√°n√≠ na subscription modal
- ‚úÖ MutationObserver pro zachycen√≠ "Sign in" linku v Clerk SignUp ‚Üí p≈ôesmƒõrov√°n√≠ zpƒõt na SignIn
- ‚úÖ `routing: 'virtual'` v Clerk options - zamezen√≠ p≈ôesmƒõrov√°n√≠ na Clerk dom√©nu
- ‚úÖ Cleanup incomplete Clerk sessions v `showLoginModal()`
- ‚úÖ P≈ôid√°n close button (‚úï) na subscription modal
- ‚úÖ `handleLoginModalClose()` a `handleSubscriptionModalClose()` - spr√°vn√© ƒçi≈°tƒõn√≠ flags
- ‚úÖ `canCloseLoginModal()` - prevence zav≈ôen√≠ modalu bƒõhem registrace
- ‚úÖ CSS opravy - odstranƒõn√≠ blur z modal content, `align-items: flex-start`
- ‚úÖ P≈ôeklady email≈Ø do v≈°ech 31 jazyk≈Ø (`supabase/functions/_shared/email-translations.ts`)
- ‚úÖ P≈ôeklady nov√Ωch auth text≈Ø do v≈°ech locale soubor≈Ø
- ‚úÖ CORS - p≈ôid√°ny localhost origins pro lok√°ln√≠ v√Ωvoj

**Service Worker verze:** `liquimixer-v97`

---

### 9.1.2026 - GP WebPay integrace + User Cleanup CRON
**Kompletn√≠ implementace platebn√≠ br√°ny GP WebPay + automatick√© maz√°n√≠ neaktivn√≠ch √∫ƒçt≈Ø**

**INCIDENT (opraveno):**
- P≈ôid√°n√≠ slo≈æky GPWebpay/ zp≈Øsobilo deployment failure na Zeabur
- ≈òe≈°en√≠: `git revert`, aktualizace `.gitignore`, nov√° implementace bez bin√°rn√≠ch soubor≈Ø

**Implementov√°no:**
- ‚úÖ RSA-SHA1 podepisov√°n√≠ pomoc√≠ node-forge
- ‚úÖ Testovac√≠ konfigurace (merchant: 123456, test gateway)
- ‚úÖ Ovƒõ≈ôen√≠ podpisu odpovƒõdi od GP WebPay
- ‚úÖ Callback endpoint s p≈ôesmƒõrov√°n√≠m u≈æivatele
- ‚úÖ Automatick√° fakturace a export do iDoklad po platbƒõ
- ‚úÖ Oprava typo `handleCorsPreflght` ‚Üí `handleCorsPreflight`
- ‚úÖ Dokumentace GPWEBPAY_SETUP.md
- ‚úÖ Oprava Clerk UI (ƒçitelnost "Continue" tlaƒç√≠tka, ƒçesk√© p≈ôeklady)

**User Cleanup CRON Job (`user-cleanup/`):**
- ‚úÖ Automatick√© maz√°n√≠ neaktivn√≠ch √∫ƒçt≈Ø
- **Pravidla maz√°n√≠:**
  - U≈æivatel BEZ historie p≈ôedplatn√©ho ‚Üí smaz√°n po **48 hodin√°ch** od registrace
  - U≈æivatel S histori√≠ p≈ôedplatn√©ho ‚Üí smaz√°n **3 mƒõs√≠ce** po vypr≈°en√≠
- **Email upozornƒõn√≠ (pro u≈æivatele s histori√≠):**
  - 1 mƒõs√≠c p≈ôed smaz√°n√≠m
  - 1 t√Ωden p≈ôed smaz√°n√≠m
  - 1 den p≈ôed smaz√°n√≠m
- **Datab√°zov√© sloupce:** `deletion_warning_sent`, `deletion_scheduled_at`, `locale`
- **CRON nastaven√≠:** Dennƒõ ve 3:00 p≈ôes pg_cron

**Testovac√≠ karty:**
| Karta | V√Ωsledek |
|-------|----------|
| `4056070000000008` | ‚úÖ √öspƒõ≈°n√° |
| `4056070000000016` | ‚ùå Zam√≠tnut√° |

**Supabase secrets (nastaveny):**
- `GPWEBPAY_TEST_MODE=true`
- `GPWEBPAY_PRIVATE_KEY` (Base64 testovac√≠ kl√≠ƒç)
- `GPWEBPAY_PRIVATE_KEY_PASSWORD=111111`
- `GPWEBPAY_GPE_PUBLIC_KEY` (Base64 ve≈ôejn√Ω kl√≠ƒç GPE)
- `APP_BASE_URL=https://www.liquimixer.com`
- SMTP konfigurace pro faktury
- `CRON_SECRET` - tajn√Ω kl√≠ƒç pro CRON job autorizaci
- `RESEND_API_KEY` - pro odes√≠l√°n√≠ email≈Ø (volitelnƒõ)

**Pro p≈ôechod do produkce:**
1. Nastavit `GPWEBPAY_TEST_MODE=false`
2. Vymƒõnit testovac√≠ kl√≠ƒçe za produkƒçn√≠ od banky
3. Aktualizovat `GPWEBPAY_MERCHANT_NUMBER`
4. Deploy: `supabase functions deploy gpwebpay`
5. Deploy: `supabase functions deploy user-cleanup`
6. Povolit pg_cron v Supabase Dashboard a nastavit CRON job

### 8.1.2026 - P≈ôeklady a tlaƒç√≠tka
- ‚úÖ Opraveny p≈ôeklady tlaƒç√≠tek "Ulo≈æit zmƒõny" a "Ulo≈æit recept" (hardcoded ‚Üí t())
- ‚úÖ P≈ôid√°ny chybƒõj√≠c√≠ kl√≠ƒçe do v≈°ech 31 jazyk≈Ø (reminder, recipe_detail, save_recipe)
- ‚úÖ Opraveno ≈ôazen√≠ p≈ôipom√≠nek (nejnovƒõj≈°√≠ naho≈ôe)
- ‚úÖ Opravena grafika slo≈æek v ulo≈æen√Ωch receptech (results-table-container)

### 7.1.2026 - KRITICK√ù INCIDENT: Korupce app.js
**Co se stalo:**
- PowerShell p≈ô√≠kazy po≈°kodily UTF-8 k√≥dov√°n√≠ v app.js
- V≈°echny ƒçesk√© znaky se zmƒõnily na neƒçiteln√© symboly
- Emoji ikony se rozpadly

**Jak se opravilo:**
- Ruƒçn√≠ oprava stovek ≈ô√°dk≈Ø pomoc√≠ search_replace
- Porovn√°v√°n√≠ s cs.json pro spr√°vn√© ƒçesk√© texty

**Pouƒçen√≠:**
- NIKDY nepou≈°tƒõt PowerShell pro editaci soubor≈Ø!
- V≈ædy dƒõlat z√°lohu p≈ôed velk√Ωmi zmƒõnami

### 6-7.1.2026 - P≈ôipom√≠nky zr√°n√≠
- ‚úÖ Implementace syst√©mu p≈ôipom√≠nek (reminders)
- ‚úÖ Automatick√Ω v√Ωpoƒçet steeping ƒçasu podle typu p≈ô√≠chutƒõ
- ‚úÖ Edge funkce reminder-notify pro notifikace
- ‚úÖ Oprava v√Ωpoƒçtu pro star≈°√≠ recepty (fallback hled√°n√≠ flavorType)

### 5.1.2026 - Pulzuj√≠c√≠ animace
- ‚úÖ Pulzuj√≠c√≠ text pro mode-button (eLiquid, ≈òedƒõn√≠ nikotinu)
- ‚úÖ Pulzuj√≠c√≠ border pro ostatn√≠ tlaƒç√≠tka
- ‚úÖ Oprava barvy pulzov√°n√≠ pro r≈Ø≈æov√© tlaƒç√≠tko "M≈Øj √∫ƒçet"

---

## üåê JAZYK vs. GEOLOKACE - DVƒö NEZ√ÅVISL√â FUNKCE!

### KRITICK√â POCHOPEN√ç

| Funkce | √öƒçel | Jak se urƒçuje | Kde se pou≈æ√≠v√° |
|--------|------|---------------|----------------|
| **Jazyk (locale)** | Komunikace s u≈æivatelem | Prohl√≠≈æeƒç nebo volba u≈æivatele | UI, emaily, horn√≠ ƒç√°st faktury |
| **Geolokace (country)** | M√≠sto plnƒõn√≠ pro DPH | IP adresa u≈æivatele | Cena, mƒõna, DPH, iDoklad |

### JAZYK (locale)

**Urƒçen√≠:**
1. Preference u≈æivatele (ulo≈æeno v `user_settings.language`)
2. Jazyk prohl√≠≈æeƒçe (`navigator.language`)
3. Fallback: `cs`

**Kde se pou≈æ√≠v√°:**
- Cel√© UI aplikace
- Emaily (vƒçetnƒõ horn√≠ ƒç√°sti faktury v emailu)
- P≈ôeklady v `locales/*.json`

**31 podporovan√Ωch jazyk≈Ø:**
cs, en, de, fr, es, it, pl, ru, pt, nl, ja, ko, zh-CN, zh-TW, ar-SA, sv, da, fi, no, hr, sr, bg, ro, lt, lv, et, hu, el, uk, sk, tr

### GEOLOKACE (country)

**Urƒçen√≠:**
1. IP adresa ‚Üí geolokaƒçn√≠ slu≈æba (ip-api.com, ipapi.co)
2. Fallback: `CZ`

**Kdy se detekuje:**
- P≈ôi naƒçten√≠ str√°nky
- **P≈òED KA≈ΩDOU PLATBOU** (u≈æivatel se m≈Ø≈æe stƒõhovat!)

**Tabulky v DB:**
- `vat_rates` - DPH sazby pro ka≈ædou zemi
- `pricing` - ceny podle locale (cs=CZK, en=EUR/USD)
- `user_locations` - historie lokac√≠ u≈æivatele

**Kde se pou≈æ√≠v√°:**
- Urƒçen√≠ ceny (59 CZK / 2.40 EUR / 2.90 USD)
- Urƒçen√≠ mƒõny
- Urƒçen√≠ DPH sazby (21% EU / 0% mimo EU)
- Krajina kontaktu v iDoklad

### PRAVIDLA PRO iDoklad

**iDoklad v≈ædy v ƒåE≈†TINƒö:**
```typescript
const t = getEmailTranslations('cs') // V≈ΩDY ƒçe≈°tina pro iDoklad
```

**Jazyk z√°kazn√≠ka se pou≈æije pro:**
- Email s fakturou (horn√≠ ƒç√°st)
- Doln√≠ ƒç√°st emailu je v≈ædy anglicky

**Krajina v iDoklad:**
- Urƒçuje se z geolokace (IP), NE z jazyka
- Kontakt se aktualizuje p≈ôi zmƒõnƒõ zemƒõ

---

## üìÑ iDoklad API INTEGRACE

### Autentizace
- OAuth 2.0 Client Credentials flow
- Token URL: `https://identity.idoklad.cz/server/connect/token`
- API URL: `https://api.idoklad.cz/v3`
- Secrets: `IDOKLAD_CLIENT_ID`, `IDOKLAD_CLIENT_SECRET`

### Hlavn√≠ endpointy pou≈æ√≠van√©
| Endpoint | Metoda | √öƒçel |
|----------|--------|------|
| `/Contacts` | GET/POST/PATCH | Spr√°va kontakt≈Ø (z√°kazn√≠k≈Ø) |
| `/IssuedInvoices` | POST | Vytvo≈ôen√≠ faktury |
| `/IssuedInvoices/Default` | GET | V√Ωchoz√≠ nastaven√≠ faktury |
| `/PaymentOptions` | GET/POST | Platebn√≠ metody |
| `/Countries` | GET | Seznam zem√≠ |

### Struktura faktury
```typescript
const invoiceData = {
  PartnerId: contactId,          // ID kontaktu
  DateOfIssue: '2026-01-13',     // Datum vystaven√≠
  DateOfMaturity: '2026-01-27',  // Datum splatnosti
  DateOfPayment: '2026-01-13',   // Datum √∫hrady
  PaymentOptionId: paymentId,     // Platba kartou
  NumericSequenceId: seqId,       // ƒå√≠seln√° ≈ôada
  Items: [{
    Name: 'LiquiMixer Premium...',
    Amount: 1,
    Unit: 'ks',
    UnitPrice: unitPriceWithoutVat, // Cena BEZ DPH!
    VatRateType: 0,                 // 0=Basic, 3=Zero
    VatRate: 21,                    // Explicitn√≠ sazba
    PriceType: 0,                   // 0 = cena bez DPH
  }]
}
```

### ƒåast√© chyby iDoklad API

| Chyba | P≈ô√≠ƒçina | ≈òe≈°en√≠ |
|-------|---------|--------|
| 401 Unauthorized | Neplatn√© credentials | Ovƒõ≈ôit IDOKLAD_CLIENT_ID/SECRET |
| "VatRate X and VatRateType Y not found" | Konflikt VatRate a VatRateType | Pou≈æ√≠t POUZE VatRateType, NE VatRate! |
| ≈†patn√° DPH sazba (12%) | VatRateType: 1 (Reduced1) m√≠sto 0 (Basic) | Zkontrolovat getVatRateForCountry() |
| VatRateType Reduced1 for dates... | Pos√≠l√°me VatRate: 21 + VatRateType: 1 | Odstranit VatRate, pou≈æ√≠t jen VatRateType: 0 |

### KRITICK√â - VatRateType hodnoty

```typescript
// iDoklad VatRateType hodnoty - NEPOU≈Ω√çVAT VatRate souƒçasnƒõ!
// 0 = Basic (z√°kladn√≠ sazba - 21%)  ‚Üê PRO EU ZEMƒö
// 1 = Reduced1 (sn√≠≈æen√° 1 - 12%)    ‚Üê NEPOU≈Ω√çVAT!
// 2 = Reduced2 (sn√≠≈æen√° 2 - 0%)     ‚Üê NEPOU≈Ω√çVAT!
// 3 = Zero (nulov√°/osvobozeno - 0%) ‚Üê PRO MIMO EU

Items: [{
  VatRateType: vatRate.type, // 0 nebo 3, NIKDY 1 nebo 2
  // VatRate: vatRate.rate,  // NEPOS√çLAT! Zp≈Øsobuje konflikt
  PriceType: 0, // 0 = cena BEZ DPH
}]
```

### Logika cen pro iDoklad

**EU zemƒõ (21% DPH):**
- Fin√°ln√≠ cena S DPH: 59 CZK / 2.40 EUR
- iDoklad dostane: `UnitPrice = amount / 1.21` (cena BEZ DPH)
- `VatRateType: 0` (Basic 21%)
- iDoklad dopoƒç√≠t√° DPH a zobraz√≠ spr√°vnou fin√°ln√≠ cenu

**Mimo EU (0% DPH):**
- Fin√°ln√≠ cena BEZ DPH: 2.90 USD / 2.40 EUR
- iDoklad dostane: `UnitPrice = amount` (ji≈æ je bez DPH)
- `VatRateType: 3` (Zero - osvobozeno)
- iDoklad nezobraz√≠ ≈æ√°dn√© DPH

### Aktualizace kontaktu p≈ôi zmƒõnƒõ zemƒõ
Pokud u≈æivatel zmƒõn√≠ zemi (stƒõhov√°n√≠), je nutn√© aktualizovat kontakt v iDoklad:
```typescript
// V getOrCreateContact() - kontrola a update
if (existingContact.CountryId !== targetCountryId) {
  await fetch(`${IDOKLAD_CONFIG.apiUrl}/Contacts/${existingContact.Id}`, {
    method: 'PATCH',
    body: JSON.stringify({ CountryId: targetCountryId })
  })
}
```

---

## üåç GEOLOKACE A DPH

### Princip m√≠sta plnƒõn√≠
- **M√≠sto plnƒõn√≠** = krajina z√°kazn√≠ka detekovan√° z IP adresy
- M√≠sto plnƒõn√≠ urƒçuje:
  - DPH sazbu (21% EU vs. 0% mimo EU)
  - Krajinu kontaktu v iDoklad
  - Mƒõnu (CZK, EUR, USD)
- **Jazyk je nez√°visl√Ω** na m√≠stu plnƒõn√≠ (u≈æivatel si vol√≠ s√°m)

### Kdy se detekuje geolokace
1. P≈ôi naƒçten√≠ str√°nky: `detectUserLocation()` v `app.js`
2. **P≈òED KA≈ΩDOU PLATBOU:** `detectUserLocation()` vol√°no v `processPayment()`
   - D≈Øvod: U≈æivatel se m≈Ø≈æe stƒõhovat, m√≠sto plnƒõn√≠ se mƒõn√≠

### DPH sazby v iDoklad

| Krajina | VatRateType | VatRate | Popis |
|---------|-------------|---------|-------|
| EU zemƒõ | 0 (Basic) | 21 | Z√°kladn√≠ sazba |
| Mimo EU | 3 (Zero) | 0 | Osvobozeno |

**POZOR na hodnoty VatRateType:**
```typescript
// iDoklad VatRateType hodnoty:
// 0 = Basic (z√°kladn√≠ sazba - 21%)
// 1 = Reduced1 (sn√≠≈æen√° 1 - 12%) ‚Üê NEPOU≈Ω√çVAT!
// 2 = Reduced2 (sn√≠≈æen√° 2 - 10%) ‚Üê NEPOU≈Ω√çVAT!
// 3 = Zero (nulov√°/osvobozeno - 0%)
```

### EU zemƒõ (21% DPH)
```typescript
const euCountries = [
  'AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR',
  'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL',
  'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'
]
```

### Ceny pro iDoklad
- **V≈ΩDY pos√≠lat cenu BEZ DPH** s `PriceType: 0`
- iDoklad s√°m dopoƒç√≠t√° DPH
- Pro EU: `unitPriceWithoutVat = amount / 1.21`
- Pro mimo EU: `unitPriceWithoutVat = amount` (0% DPH)

---

## üêõ ZN√ÅM√â PROBL√âMY

### Lok√°ln√≠ v√Ωvoj
- `Error checking subscription: SyntaxError` - NORM√ÅLN√ç na localhost
  - Supabase edge funkce nejsou dostupn√© lok√°lnƒõ
  - Na produkci (Zeabur) funguje spr√°vnƒõ

### PowerShell cesty
- Cesta s ƒçesk√Ωmi znaky nefunguje v PowerShell
- Pou≈æ√≠t kr√°tkou cestu: `C:\Users\TOMLAP~1\Liquimixer`

### Edge Function neloguje nic
**Symptom:** Funkce by mƒõla logovat, ale v Supabase Dashboard nen√≠ ≈æ√°dn√Ω log.

**Mo≈æn√© p≈ô√≠ƒçiny:**
1. **JWT verifikace selhala** - po≈æadavek byl odm√≠tnut je≈°tƒõ p≈ôed spu≈°tƒõn√≠m k√≥du
   - ≈òe≈°en√≠: P≈ôidat `verify_jwt = false` do `config.toml` pro danou funkci
2. **Funkce nebyla nasazena** - star√° verze bez log≈Ø
   - ≈òe≈°en√≠: `npx supabase functions deploy [funkce] --project-ref krwdfxnvhnxtkhtkbadi`
3. **≈†patn√Ω ƒçasov√Ω rozsah** v logu Dashboard
   - ≈òe≈°en√≠: Zvƒõt≈°it ƒçasov√Ω rozsah nebo pou≈æ√≠t "Last 1 hour"

**Debug postup:**
1. P≈ôidat logy na √∫pln√Ω zaƒç√°tek `serve()`:
```typescript
serve(async (req) => {
  console.log('=== Function called ===')
  console.log('Method:', req.method)
  console.log('URL:', req.url)
  // ...
```
2. Nasadit funkci
3. Otestovat a zkontrolovat logy

### 401 Unauthorized z Edge Function
**Mo≈æn√© p≈ô√≠ƒçiny:**
1. **Supabase JWT verifikace** - chyb√≠ `verify_jwt = false` v config.toml
2. **Extern√≠ API credentials** - neplatn√© nebo expirovan√© (iDoklad, GP WebPay)
3. **Clerk token** - vypr≈°el nebo je neplatn√Ω

**Jak rozli≈°it:**
- Pokud funkce NELOGUJE NIC ‚Üí probl√©m je JWT verifikace Supabase
- Pokud funkce loguje ale vrac√≠ 401 ‚Üí probl√©m je v k√≥du funkce (API credentials)

---

## üîó U≈ΩITEƒåN√â ODKAZY

- **Produkce:** https://liquimixer.zeabur.app
- **GitHub:** https://github.com/tomaslapos/liquimixer
- **Supabase:** https://supabase.com/dashboard (projekt Liquimixer)
- **Clerk:** https://dashboard.clerk.com (autentizace)
- **Zeabur:** https://zeabur.com (hosting, auto-deploy z main branch)

---

## Z√°lohy

- `backup_2026-01-10/` - pred subscription flow redesign
- `backup_2026-01-12/` - r√°no
- `backup_2026-01-12-evening/` - veƒçer po oprav√°ch

---

## Kontakty a secrets

### Supabase Secrets (potrebn√© pre Edge Functions)
- `GPWEBPAY_MERCHANT_NUMBER`
- `GPWEBPAY_PRIVATE_KEY` (Base64 PKCS#8)
- `GPWEBPAY_PRIVATE_KEY_PASSWORD`
- `GPWEBPAY_PUBLIC_KEY`
- `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASSWORD`
- `IDOKLAD_CLIENT_ID`, `IDOKLAD_CLIENT_SECRET`
- `CLERK_SECRET_KEY`

---

## üìù HISTORIE ZMƒöN

### 13.1.2026 (odpoledne)
- **Oprava po≈ôad√≠ v√Ωpoƒçtu VAT:** `vatRate` se nyn√≠ poƒç√≠t√° P≈òED vytvo≈ôen√≠m kontaktu
- **Odstranƒõn√≠ `VatRate` z invoice items:** iDoklad mƒõl konflikt mezi `VatRate` a `VatRateType`, pou≈æijeme jen `VatRateType`
- **P≈ôid√°n√≠ cleanup pending subscriptions:** `user-cleanup` funkce nyn√≠ ma≈æe pending subscriptions star≈°√≠ ne≈æ 24 hodin
- **Spr√°vn√© VatRateType hodnoty:** 0 = Basic (21%), 3 = Zero (0%)

### 13.1.2026 (veƒçer) - HLAVN√ç OPRAVA iDoklad DPH
- **Root cause:** iDoklad bere DPH sazbu ze ZEMƒö KONTAKTU, ne z `VatRateType` polo≈æky!
- **≈òe≈°en√≠ pro EU:** Kontakt m√° v≈ædy `CountryId=1` (CZ) ‚Üí ƒçesk√© DPH 21%
- **≈òe≈°en√≠ pro mimo EU:** Kontakt m√° skuteƒçnou zemi (US, GB, JP...) ‚Üí DPH 0%
- **Pozn√°mka faktury:** V≈ædy obsahuje skuteƒçnou zemi z√°kazn√≠ka pro anal√Ωzu
- **DB ukl√°d√°:** Skuteƒçnou geolokaci v `customer_country` pro anal√Ωzu
- **P≈ôid√°n sloupec `total`:** Do DB insertu (NOT NULL constraint)
- **Oprava fallback geolokace:** `app.js` nyn√≠ v≈ædy defaultuje na CZ (m√≠sto plnƒõn√≠)

### iDoklad - ≈ôe≈°en√≠ chyb
- **Chyba "VatRate 21 and VatRateType Reduced1":** Zp≈Øsobeno konflitkem - pos√≠lali jsme oba parametry. ≈òe≈°en√≠: Pos√≠lat POUZE `VatRateType`
- **Chyba 12% DPH:** iDoklad ignoruje `VatRateType` a bere DPH ze zemƒõ kontaktu. ≈òe≈°en√≠: Pro EU zemƒõ nastavit kontakt na CZ
- **Chyba "null value in total":** Sloupec `total` je NOT NULL. ≈òe≈°en√≠: P≈ôidat `total: amount` do DB insertu

### Logika DPH pro iDoklad (OSS re≈æim)

| Zemƒõ z√°kazn√≠ka | VAT Rate | iDoklad kontakt | DB customer_country | Pozn√°mka faktury |
|----------------|----------|-----------------|---------------------|------------------|
| CZ | 21% | CZ | CZ | Zemƒõ: ƒåesk√° republika (CZ) |
| SK (EU) | 21% | CZ | SK | Zemƒõ: Slovensko (SK) |
| DE (EU) | 21% | CZ | DE | Zemƒõ: Nƒõmecko (DE) |
| US (mimo EU) | 0% | US | US | Zemƒõ: USA (US) |
| GB (mimo EU) | 0% | GB | GB | Zemƒõ: Velk√° Brit√°nie (GB) |

### 13.1.2026 (pozdƒõ veƒçer) - Opravy po testov√°n√≠

**Opraven√© probl√©my:**
1. **Invoice Edge Function - chybƒõlo verify_jwt=false** - gpwebpay vol√° invoice pro odes√≠l√°n√≠ email≈Ø, ale invoice mƒõla zapnutou JWT verifikaci ‚Üí email se neodeslal
2. **Notifikace o platbƒõ v anglicky m√≠sto u≈æivatelsk√©ho jazyka** - race condition, notifikace se zobrazovala p≈ôed naƒçten√≠m jazyka z DB. Nyn√≠ se ƒçek√° na Clerk p≈ôihl√°≈°en√≠ ‚Üí naƒçten√≠ jazyka ‚Üí pak notifikace

**P≈ôid√°no do config.toml:**
```toml
[functions.invoice]
verify_jwt = false
```

**Zmƒõna v app.js handlePaymentReturn():**
- ƒåek√° na `window.Clerk?.user` 
- Vol√° `window.i18n.loadUserLocale()` p≈ôed zobrazen√≠m notifikace

### 13.1.2026 (noc) - Dal≈°√≠ opravy

**Opraven√© probl√©my:**
1. **iDoklad kontakt update:** Zmƒõnƒõno z PATCH na PUT - iDoklad API nƒõkdy ignoruje PATCH. P≈ôid√°na validace a fallback
2. **Online faktura (invoice.html):**
   - Jazyk se nyn√≠ bere prim√°rnƒõ z `invoice.locale` (jazyk u≈æivatele v DB)
   - Opraveno NaN: `totalWithVat` se nyn√≠ spr√°vnƒõ ƒçte z `total`, `amount` nebo `total_amount`
3. **Invoice Edge Function:** P≈ôid√°n log pro debugging total hodnot

### 13.1.2026 (pozdƒõ veƒçer) - Kritick√° oprava iDoklad

**Probl√©my kter√© p≈ôetrv√°valy:**
- Kontakt st√°le se Slovenskem (12% DPH)
- PUT/PATCH aktualizace kontaktu nefungovala spolehlivƒõ
- Zp≈Øsob √∫hrady "P≈ôevodem" m√≠sto "Kartou"

**KRITICK√Å ZMƒöNA v `getOrCreateContact()`:**
- **NEAKTUALIZOVAT existuj√≠c√≠ kontakt** - iDoklad API to nedƒõl√° spolehlivƒõ
- Hledat kontakt podle emailu A spr√°vn√© zemƒõ (CountryId)
- Pokud nenajde kontakt s CZ, vytvo≈ôit NOV√ù kontakt
- Kontakt m√° `Note` s datem a zem√≠ pro DPH

```typescript
// Nov√° logika: hledat kontakt se SPR√ÅVNOU zem√≠
const matchingContact = contacts.find((c: any) => c.CountryId === targetCountryId)
if (matchingContact) {
  return matchingContact.Id // Pou≈æ√≠t existuj√≠c√≠ se spr√°vnou zem√≠
}
// Jinak vytvo≈ôit nov√Ω kontakt s CZ
```

**PaymentOptionId:**
- P≈ôid√°n detailn√≠ logging v≈°ech platebn√≠ch mo≈ænost√≠
- Hled√° "kart", "card", "online" v n√°zvech

**Email faktury:**
- Zmƒõnƒõno "English version / Anglick√° verze" ‚Üí "English version"

**Zeabur:**
- Deploye jsou "Removed" kv≈Øli infrastrukturn√≠mu probl√©mu Zeabur ("pod didn't trigger scale-up")
- Star≈°√≠ verze bƒõ≈æ√≠ spr√°vnƒõ
- ≈òe≈°en√≠: Manu√°ln√≠ Redeploy v Zeabur dashboardu nebo kontakt Zeabur support

### 13.1.2026 (noc v2) - VatRateId oprava

**Novƒõ zji≈°tƒõn√© informace z iDoklad API:**

1. **CountryId mapov√°n√≠ (z /Countries API):**
   - `CountryId=1` = Slovensko (SK)
   - `CountryId=2` = ƒåesk√° republika (CZ)
   - POZOR: P≈Øvodnƒõ jsme p≈ôedpokl√°dali 1=CZ!

2. **VatRateId pro CZ (z /VatRates API):**
   - `VatRateId=747` = Z√°kladn√≠ sazba 21% (pro CZ, CountryId=2)
   - `VatRateId=748` = Sn√≠≈æen√° sazba 12% (pro CZ)
   - `VatRateId=749` = Nulov√° sazba 0%

**Opraveno:**
- Zmƒõnƒõno z `VatRateType: 0` na `VatRateId: 747` (explicitn√≠ ID pro 21%)
- Cena se pos√≠l√° jako 48.76 (bez DPH) s `PriceType: 0`

**Email opravy:**
- Odstranƒõn `content` field z email send (zp≈Øsoboval p≈ô√≠lohu)
- P≈ôid√°n RTL support pro arab≈°tinu (`dir="rtl"`, `lang="ar-SA"`)

**invoice.html:**
- Tlaƒç√≠tka nyn√≠ pou≈æ√≠vaj√≠ `getElementById` m√≠sto `querySelector`
- P≈ôeklady "Print Invoice" a "Back to App" funguj√≠ spr√°vnƒõ

---

## üìä iDoklad DPH MATICE

### VatRateType vs VatRateId

| Parametr | Kdy pou≈æ√≠t | V√Ωhody | Nev√Ωhody |
|----------|------------|--------|----------|
| `VatRateType` | Obecn√° sazba | Jednoduch√Ω (0,1,2,3) | Z√°vis√≠ na zemi kontaktu |
| `VatRateId` | Konkr√©tn√≠ sazba | P≈ôesn√©, nez√°visl√© | Nutno zn√°t ID |

### iDoklad VatRateType hodnoty

| Typ | N√°zev | Sazba (CZ) | Pou≈æit√≠ |
|-----|-------|------------|---------|
| 0 | Basic | 21% | EU zemƒõ - NEPOU≈Ω√çV√ÅME! |
| 1 | Reduced1 | 12% | Sn√≠≈æen√° - NEPOU≈Ω√çV√ÅME! |
| 2 | Reduced2 | 10% | Sn√≠≈æen√° 2 - NEPOU≈Ω√çV√ÅME! |
| 3 | Zero | 0% | Mimo EU - osvobozeno |

### iDoklad VatRateId hodnoty (CZ)

| ID | N√°zev | Sazba | Pou≈æit√≠ |
|----|-------|-------|---------|
| 747 | Z√°kladn√≠ sazba | 21% | **EU zemƒõ** |
| 748 | Sn√≠≈æen√° sazba | 12% | Nepou≈æ√≠v√°me |
| 749 | Nulov√° sazba | 0% | Mimo EU |

### Spr√°vn√Ω zp≈Øsob pos√≠l√°n√≠ ceny do iDoklad

```typescript
Items: [{
  Name: itemName,
  Amount: 1,
  Unit: 'ks',
  UnitPrice: unitPriceWithoutVat, // 48.76 (59/1.21 pro EU)
  VatRateId: 747, // Explicitn√≠ ID pro 21%
  PriceType: 0, // 0 = cena BEZ DPH
  DiscountPercentage: 0,
  IsTaxMovement: false,
}]
```

### CountryId mapov√°n√≠ (iDoklad)

| ID | K√≥d | N√°zev |
|----|-----|-------|
| 1 | SK | Slovensko |
| 2 | CZ | ƒåesk√° republika |
| 3 | AF | Afgh√°nist√°n |
| 4 | AL | Alb√°nie |
| ... | ... | ... |

**KRITICK√â:** Pro OSS re≈æim EU mus√≠me kontakt m√≠t s `CountryId=2` (CZ)!

---

## ‚úÖ 14.1.2026 - KOMPLETN√ç OPRAVA iDoklad + DPH + MƒöNA

### Shrnut√≠ oprav

**V≈°echny probl√©my s iDoklad vy≈ôe≈°eny:**
- ‚úÖ DPH sazba: 21% pro EU, 0% pro mimo EU
- ‚úÖ Mƒõny: CZK, EUR, USD spr√°vnƒõ zobrazeny
- ‚úÖ Kurzy mƒõn: Automaticky z ƒåNB API
- ‚úÖ VatCodeId: Spr√°vn√© da≈àov√© ƒçlenƒõn√≠
- ‚úÖ Emaily: Spr√°vn√© k√≥dov√°n√≠ pro v≈°echny jazyky (31)

### Kl√≠ƒçov√© poznatky - iDoklad API

#### 1. VatCodeId (K√≥d DPH / Da≈àov√© ƒçlenƒõn√≠)
**KRITICK√â:** Toto je ƒåLENƒöN√ç DPH pro √∫ƒçetnictv√≠, NE sazba!

| VatCodeId | K√≥d | Popis | Pou≈æit√≠ |
|-----------|-----|-------|---------|
| (nutno zjistit z API) | 01-02 | Tuzemsk√© plnƒõn√≠ | CZ z√°kazn√≠ci |
| 25 | OSS EU < 10.000 | Pod limit 10.000 EUR | EU z√°kazn√≠ci (OSS re≈æim) |
| 20 nebo 21 | V√Ωvoz | Export mimo EU | Mimo EU z√°kazn√≠ci |

**Jak zjistit VatCodeId:**
```typescript
// GET /VatCodes?countryId=2
// Vrac√≠ seznam k√≥d≈Ø DPH pro CZ
```

#### 2. VatRateId vs VatRateType
| Parametr | Hodnoty | Popis |
|----------|---------|-------|
| `VatRateType` | 0=Basic(21%), 3=Zero(0%) | Relativn√≠ sazba |
| `VatRateId` | 747=21%, 749=0% (pro CZ) | Absolutn√≠ ID |

**Doporuƒçen√≠:** Pou≈æ√≠t `VatRateType` - je jednodu≈°≈°√≠ a nez√°visl√Ω na konkr√©tn√≠ch ID.

#### 3. CurrencyId (Mƒõny)
| CurrencyId | K√≥d | N√°zev |
|------------|-----|-------|
| 1 | CZK | Czech koruna |
| 2 | EUR | Euro |
| 11 | USD | American dollar |

**POZOR:** USD m√° ID 11, NE 3!

#### 4. ExchangeRate (Kurz mƒõny)
Pro faktury v ciz√≠ mƒõnƒõ je nutn√© pos√≠lat kurz:
```typescript
ExchangeRate: 25.0, // Kurz za 1 jednotku mƒõny
ExchangeRateAmount: 1, // Mno≈æstv√≠ jednotek (v≈ædy 1)
```

**Zdroj kurz≈Ø:** ƒåNB API
```
https://www.cnb.cz/cs/financni_trhy/devizovy_trh/kurzy_devizoveho_trhu/denni_kurz.txt
```

Form√°t odpovƒõdi:
```
14.01.2026 #10
zemƒõ|mƒõna|mno≈æstv√≠|k√≥d|kurz
...
EMU|euro|1|EUR|25,120
USA|dolar|1|USD|24,341
...
```

#### 5. PriceType
| Hodnota | Popis |
|---------|-------|
| 0 | Cena BEZ DPH (UnitPrice bez DPH) |
| 1 | Cena S DPH (UnitPrice s DPH) |

**Doporuƒçen√≠:** Pou≈æ√≠t `PriceType: 0` a pos√≠lat cenu bez DPH.

### Logika cen a DPH

#### EU zemƒõ (21% DPH)
```typescript
// Fin√°ln√≠ cena (s DPH): 59 CZK / 2.40 EUR
const unitPriceWithoutVat = amount / 1.21
// Pos√≠lat:
UnitPrice: unitPriceWithoutVat,
PriceType: 0,
VatRateType: 0, // Basic = 21%
VatCodeId: 25, // OSS EU < 10.000
```

#### Mimo EU (0% DPH)
```typescript
// Fin√°ln√≠ cena (bez DPH): 2.90 USD
const unitPriceWithoutVat = amount // Ji≈æ bez DPH
// Pos√≠lat:
UnitPrice: unitPriceWithoutVat,
PriceType: 0,
VatRateType: 3, // Zero = 0%
VatCodeId: 20, // nebo 21 - V√Ωvoz
```

### Email k√≥dov√°n√≠

#### Problem s non-ASCII znaky
- Nƒõkter√© SMTP servery a klienty (Outlook) mƒõly probl√©my s UTF-8 v subjectu
- RFC 2047 Base64 encoding zp≈Øsoboval double-encoding

#### ≈òe≈°en√≠
1. **Subject:** V≈ædy anglicky (ASCII)
   ```typescript
   return `Invoice number ${invoiceNumber} - LiquiMixer`
   ```

2. **Body:** Base64 encoded UTF-8 HTML
   ```typescript
   mimeContent: [{
     mimeType: 'text/html; charset="utf-8"',
     content: btoa(htmlContent), // Base64
     transferEncoding: 'base64'
   }]
   ```

### Struktura invoice objektu

```typescript
const invoiceData = {
  // Z√°kladn√≠ info
  PartnerId: contactId,
  DateOfIssue: '2026-01-14',
  DateOfMaturity: '2026-01-28',
  DateOfPayment: '2026-01-14',
  
  // Mƒõna a kurz
  CurrencyId: getCurrencyId(currency), // 1=CZK, 2=EUR, 11=USD
  ExchangeRate: currency !== 'CZK' ? cnbRate : undefined,
  ExchangeRateAmount: currency !== 'CZK' ? 1 : undefined,
  
  // Platba
  PaymentOptionId: paymentId,
  
  // Polo≈æky
  Items: [{
    Name: 'Roƒçn√≠ p≈ôedplatn√© LiquiMixer PRO (365 dn√≠)',
    Amount: 1,
    Unit: 'ks',
    UnitPrice: unitPriceWithoutVat,
    PriceType: 0, // Cena bez DPH
    VatRateType: vatRate.type, // 0=21%, 3=0%
    VatCodeId: vatCodeId, // 25 pro EU, 20 pro mimo EU
  }]
}
```

### DB struktura - vat_rates tabulka

```sql
ALTER TABLE vat_rates
ADD COLUMN idoklad_vat_code_id INTEGER,
ADD COLUMN idoklad_vat_rate_id INTEGER;

-- P≈ô√≠klad hodnot:
-- CZ: idoklad_vat_code_id = <domestic>, idoklad_vat_rate_id = 747
-- EU: idoklad_vat_code_id = 25, idoklad_vat_rate_id = 747
-- Non-EU: idoklad_vat_code_id = 20, idoklad_vat_rate_id = 749
```

### Testov√°no a ovƒõ≈ôeno

| Jazyk | Zemƒõ | Mƒõna | DPH | V√Ωsledek |
|-------|------|------|-----|----------|
| Czech | CZ | CZK | 21% | ‚úÖ 48.76 + 10.24 = 59.00 Kƒç |
| Slovak | SK | EUR | 21% | ‚úÖ 1.98 + 0.42 = 2.40 ‚Ç¨ |
| German | DE | EUR | 21% | ‚úÖ 1.98 + 0.42 = 2.40 ‚Ç¨ |
| English | US | USD | 0% | ‚úÖ 2.90 + 0.00 = 2.90 $ |
| Arabic | SA | USD | 0% | ‚úÖ 2.90 + 0.00 = 2.90 $ |
| Japanese | JP | USD | 0% | ‚úÖ 2.90 + 0.00 = 2.90 $ |
| ... | ... | ... | ... | ‚úÖ V≈°ech 31 jazyk≈Ø |

### Nasazen√© edge funkce

```bash
npx supabase functions deploy idoklad --project-ref krwdfxnvhnxtkhtkbadi
npx supabase functions deploy invoice --project-ref krwdfxnvhnxtkhtkbadi
npx supabase functions deploy geolocation --project-ref krwdfxnvhnxtkhtkbadi
```

---

## 14.1.2026 (odpoledne) - Sd√≠len√© recepty a editace

### Vy≈ôe≈°en√© probl√©my

#### 1. Logika zobrazen√≠ sd√≠len√Ωch recept≈Ø
**Probl√©m:** V≈°echny sd√≠len√© recepty vy≈æadovaly p≈ôihl√°≈°en√≠.

**≈òe≈°en√≠ v `app.js` - `loadSharedRecipe()`:**
- Liquid a Shake & Vape recepty: zobrazit bez p≈ôihl√°≈°en√≠ (po disclaimeru)
- Liquid PRO recepty: vy≈æaduj√≠ p≈ôihl√°≈°en√≠ (po disclaimeru)
- Disclaimer se zobrazuje v≈ædy pro v≈°echny typy

```javascript
const formType = recipe.recipe_data?.formType || 'liquid';
if (formType === 'liquidpro' && !isLoggedIn) {
    showSharedRecipeLoginPrompt(); // Zobraz√≠ login prompt
} else {
    showSharedRecipeDisclaimer(shareId); // Zobraz√≠ disclaimer
}
```

#### 2. Login prompt pro Liquid PRO p≈ôelo≈æen
**Probl√©m:** Hardcoded ƒçesk√© texty v `showSharedRecipeLoginPrompt()`.

**≈òe≈°en√≠:**
- P≈ôid√°ny p≈ôeklady do v≈°ech 31 jazyk≈Ø:
  - `shared_recipe.pro_login_title`
  - `shared_recipe.pro_login_text` = "Recepty vytv√°≈ôen√© v re≈æimu Liquid PRO jsou dostupn√© jenom pro p≈ôihl√°≈°en√© u≈æivatele."
  - `shared_recipe.login_button`

#### 3. Disclaimer bypass po p≈ôihl√°≈°en√≠
**Probl√©m:** `checkPendingSharedRecipe()` naƒç√≠tala recept p≈ô√≠mo bez disclaimeru.

**≈òe≈°en√≠:** Zmƒõnƒõno na `showSharedRecipeDisclaimer(shareId)` m√≠sto `loadSharedRecipeContent(shareId)`.

#### 4. Sd√≠len√© produkty se neukl√°daly
**Probl√©m:** `saveRecipe()` pou≈æ√≠vala `pendingSharedRecipeId` (share_id string) m√≠sto UUID.

**≈òe≈°en√≠:**
- P≈ôid√°na nov√° promƒõnn√° `window.pendingSharedRecipeUUID`
- `saveSharedRecipe()` nastavuje UUID: `window.pendingSharedRecipeUUID = recipe.id`
- `saveRecipe()` pou≈æ√≠v√° UUID pro `getLinkedProductsByRecipeId()`

#### 5. Zv√Ωraznƒõn√≠ celkov√©ho objemu - oran≈æov√° barva
**≈òe≈°en√≠ v `styles.css`:**
```css
.total-volume-highlight {
    border: 2px solid var(--neon-orange);
    box-shadow: 0 0 15px rgba(255, 136, 0, 0.3);
}
.total-volume-highlight .volume-value {
    color: var(--neon-orange);
    text-shadow: 0 0 10px rgba(255, 136, 0, 0.5);
}
```

#### 6. PWA cache invalidace
- `sw.js` verze zv√Ω≈°ena na `liquimixer-v105`

### Nefunkƒçn√≠ postupy - D≈ÆLE≈ΩIT√â!

**Chybn√© n√°zvy funkc√≠ v `prefillLiquidForm()`:**
```javascript
// ≈†PATNƒö - tyto funkce NEEXISTUJ√ç:
updateNicotineFields();  // ‚ùå
updateFlavorFields();    // ‚ùå

// SPR√ÅVNƒö - pou≈æ√≠t tyto:
updateNicotineType();    // ‚úÖ
updateFlavorType();      // ‚úÖ
```

### Glob√°ln√≠ promƒõnn√© pro sd√≠len√© recepty

```javascript
window.pendingSharedRecipeId    // share_id (12-znakov√Ω string)
window.pendingSharedRecipeUUID  // UUID receptu (pro DB operace)
window.pendingSharedRecipe      // Cel√Ω objekt receptu
window.currentSharedRecipe      // Aktu√°lnƒõ zobrazen√Ω sd√≠len√Ω recept
```

---

## 15.1.2026 - Opravy p≈ôihla≈°ovac√≠ho modalu a p≈ôeklad≈Ø

### Vy≈ôe≈°en√© probl√©my

#### 1. Tlaƒç√≠tko "P≈ôihl√°sit se" na sd√≠len√©m PRO receptu nefungovalo
**Symptom:** Po kliknut√≠ na tlaƒç√≠tko "P≈ôihl√°sit se" se nic nestalo, ale v konzoli se zobrazoval log:
```
handleSharedRecipeLogin called
showLoginModal: clerkLoaded= true Clerk= true
```

**P≈ô√≠ƒçina nalezena postupnƒõ:**
1. **Prvn√≠ pokus:** `showLoginModal()` je async funkce, ale `handleSharedRecipeLogin()` ji nevolala s await ‚Üí chyby se ztr√°cely
2. **Spr√°vn√° p≈ô√≠ƒçina:** CSS pravidlo `body.subscription-required #loginModal { display: none !important; }` skr√Ωvalo modal

**Chybn√° ≈ôe≈°en√≠:**
- Pouh√© p≈ôid√°n√≠ `async/await` nepomohlo
- P≈ôid√°n√≠ diagnostiky (`console.log`) nepomohlo

**Spr√°vn√© ≈ôe≈°en√≠ v `app.js` - `handleSharedRecipeLogin()`:**
```javascript
async function handleSharedRecipeLogin() {
    console.log('handleSharedRecipeLogin called');
    try {
        console.log('showLoginModal: clerkLoaded=', clerkLoaded, 'Clerk=', !!window.Clerk);
        
        // Odstranit subscription-required t≈ô√≠du, aby loginModal nebyl CSS skryt√Ω
        document.body.classList.remove('subscription-required');
        
        // Reset inline styl≈Ø pro jistotu
        const loginModal = document.getElementById('loginModal');
        if (loginModal) {
            loginModal.style.display = '';
            loginModal.style.visibility = '';
            loginModal.style.opacity = '';
        }
        
        await showLoginModal();
    } catch (e) {
        console.error('Error in handleSharedRecipeLogin:', e);
        // Fallback - p≈ô√≠mo zobrazit modal
        const loginModal = document.getElementById('loginModal');
        if (loginModal) {
            document.body.classList.remove('subscription-required');
            loginModal.style.display = '';
            loginModal.classList.remove('hidden');
        }
    }
}
```

**Pouƒçen√≠:**
- CSS `display: none !important` p≈ôebije jak√©koliv JS zmƒõny t≈ô√≠dy `hidden`
- T≈ô√≠da `subscription-required` na `<body>` se mus√≠ explicitnƒõ odstranit
- Inline styly (`element.style.display = ''`) mohou b√Ωt pot≈ôeba pro reset

#### 2. VG/PG popisy se zobrazovaly ƒçesky p≈ôi prvn√≠m naƒçten√≠ v korej≈°tinƒõ
**Symptom:** P≈ôi p≈ô√≠stupu na str√°nku s korejsk√Ωm prohl√≠≈æeƒçem se VG/PG popisy (nap≈ô. "Vyv√°≈æen√Ω pomƒõr p√°ry a chuti...") zobrazovaly ƒçesky. Po posunu slideru se spr√°vnƒõ p≈ôelo≈æily.

**P≈ô√≠ƒçina:** Po≈ôad√≠ inicializace:
1. `DOMContentLoaded` ‚Üí `updateAllDisplays()` ‚Üí `updateRatioDisplay()` (p≈ôeklady je≈°tƒõ nenaƒçteny!)
2. `load` ‚Üí `initI18n()` ‚Üí `applyTranslations()` (p≈ôeklady naƒçteny)

**≈òe≈°en√≠ v `i18n.js` - `initI18n()`:**
```javascript
// Na konci funkce initI18n():
console.log('i18n initialized with locale:', currentLocale);

// Vyvolat localeChanged event pro aktualizaci dynamick√Ωch text≈Ø (nap≈ô. VG/PG popisy)
window.dispatchEvent(new Event('localeChanged'));
```

T√≠m se po naƒçten√≠ p≈ôeklad≈Ø vyvol√° `localeChanged` event, kter√Ω spust√≠ `updateAllDisplays()` ve spr√°vn√Ω okam≈æik.

### SW Cache verze
- Zv√Ω≈°ena z `v110` na `v112`

### Nasazeno na GitHub
- Commit 1: `fix-login-and-i18n-ratio` (async/await + i18n event)
- Commit 2: `fix-login-modal-css-visibility` (subscription-required class removal)

---

## üìã DAL≈†√ç KROKY

### ‚úÖ HOTOVO (20.1.2026)

1. ~~**P≈ôej√≠t na ostrou platebn√≠ br√°nu GP WebPay**~~ - ‚úÖ HOTOVO
2. ~~**Produkƒçn√≠ Clerk**~~ - ‚úÖ HOTOVO (DNS, API kl√≠ƒçe)
3. ~~**Google OAuth**~~ - ‚úÖ HOTOVO a funguje
4. ~~**Vyƒçi≈°tƒõn√≠ gpwebpay Edge Function**~~ - ‚úÖ HOTOVO
5. ~~**Zdvojn√°soben√≠ tlou≈°≈•ky tlaƒç√≠tek**~~ - ‚úÖ HOTOVO

### ‚è≥ ƒåEK√Å NA DOKONƒåEN√ç (22.1.2026+)

1. **Facebook OAuth** ‚úÖ **HOTOVO - PRODUKƒåN√ç VERZE**
   - Business Verification schv√°lena
   - Aplikace v produkƒçn√≠m re≈æimu
   - Facebook p≈ôihl√°≈°en√≠ funguje
   - **App ID:** `1504788803953001`

2. **TikTok OAuth** ‚è≥ **ƒåEK√Å NA OPAKOVAN√â SCHV√ÅLEN√ç**
   - Review odesl√°no 22.1.2026
   - P≈ôid√°ny Privacy Policy a Terms of Service do footeru
   - ƒåek√° se na schv√°len√≠ od TikTok

3. **Apple Sign In** ‚è≥ **ƒåEK√Å NA REGISTRACI**
   - ƒåek√° na registraci do Apple Developer Program ($99/rok)
   - Po registraci: Nastavit v Apple Developer Console
   - Integrovat s Clerk

### St≈ôedn√≠ priorita

4. **Bezpeƒçnostn√≠ audit**
   - Zkontrolovat v≈°echny API endpoints
   - Ovƒõ≈ôit rate limiting
   - Zkontrolovat CORS nastaven√≠
   - Audit secrets a p≈ô√≠stup≈Ø

### N√≠zk√° priorita

5. **Dokumentace**
   - Aktualizovat README
   - Zkontrolovat inline koment√°≈ôe
   - Dokumentovat API endpointy

---

## üìÅ Z√ÅLOHY

| Datum | Slo≈æka | Obsah |
|-------|--------|-------|
| 2026-01-10 | `backup_2026-01-10/` | P≈ôed subscription flow redesign |
| 2026-01-12 | `backup_2026-01-12/` | R√°no |
| 2026-01-12 | `backup_2026-01-12-evening/` | Veƒçer po oprav√°ch |
| 2026-01-13 | `backup_2026-01-13/` | Veƒçer - VatRateId oprava |
| 2026-01-14 | `backup_2026-01-14/` | iDoklad + DPH + mƒõny kompletn√≠ oprava |
| 2026-01-14 | `backup_2026-01-14-evening/` | Sd√≠len√© recepty, editace, p≈ôeklady |
| 2026-01-15 | `backup_2026-01-15/` | Login modal fix |
| 2026-01-16 | `backup_2026-01-16/` | Login modal fix, product deduplication, iDoklad VariableSymbol, SEO update |
| 2026-01-20 | - | GP WebPay produkce, Clerk produkce, Google OAuth |
| 2026-01-21 | - | Facebook OAuth produkce |
| 2026-01-22 | `backup_2026-01-22/` | Privacy Policy & Terms v footeru (31 jazyk≈Ø), oprava p≈ôipom√≠nek zr√°n√≠, TikTok review odesl√°no |
| 2026-01-26 | `backup_2026-01-26/` | Country-based pricing, Browser History API navigace, PWA jazyk detekce, privacy.html oprava |
| 2026-01-27 | `backup_2026-01-27/` | TikTok OAuth schv√°len, rozhodovac√≠ modal pro registraci, terms_accepted_at v DB, oprava cache lokalizac√≠ |

---

*Posledn√≠ aktualizace: 2026-01-30*

---

## ‚úÖ VY≈òE≈†ENO - 20.1.2026

### GP WebPay - PRODUKƒåN√ç PROST≈òED√ç ‚úÖ

**Dokonƒçeno:**
- P≈ôepnuto z testovac√≠ho na produkƒçn√≠ re≈æim
- Produkƒçn√≠ kl√≠ƒçe nahr√°ny do Supabase Secrets
- Merchant number: `20263539`
- Gateway URL: `https://3dsecure.gpwebpay.com/pgw/order.do`
- Platba √∫spƒõ≈°nƒõ otestov√°na

**Supabase Secrets (produkƒçn√≠):**
- `GPWEBPAY_TEST_MODE=false`
- `GPWEBPAY_PRIVATE_KEY` - produkƒçn√≠ kl√≠ƒç (ne≈°ifrovan√Ω PKCS#8, Base64)
- `GPWEBPAY_PRIVATE_KEY_PASSWORD` - heslo k p≈Øvodn√≠mu kl√≠ƒçi (u≈æ nen√≠ pot≈ôeba pro ne≈°ifrovan√Ω)
- `GPWEBPAY_GPE_PUBLIC_KEY` - produkƒçn√≠ ve≈ôejn√Ω kl√≠ƒç banky

**Postup de≈°ifrov√°n√≠ kl√≠ƒçe:**
1. Produkƒçn√≠ kl√≠ƒç byl v ≈°ifrovan√©m PKCS#8 form√°tu (`-----BEGIN ENCRYPTED PRIVATE KEY-----`)
2. Deno runtime nedok√°≈æe de≈°ifrovat ≈°ifrovan√© kl√≠ƒçe
3. Vytvo≈ôen Node.js skript `GPWebpay/produkcni/decrypt_key.js` pro de≈°ifrov√°n√≠
4. Ne≈°ifrovan√Ω kl√≠ƒç (`-----BEGIN PRIVATE KEY-----`) nahr√°n do Supabase Secrets

### Clerk - PRODUKƒåN√ç PROST≈òED√ç ‚úÖ

**Dokonƒçeno:**
- DNS z√°znamy pro `liquimixer.com` - 5/5 Verified:
  - `clerk.liquimixer.com`
  - `accounts.liquimixer.com`
  - `clkmail.liquimixer.com`
  - `clk._domainkey.liquimixer.com`
  - `clk2._domainkey.liquimixer.com`
- Produkƒçn√≠ API kl√≠ƒçe nastaveny:
  - Publishable key (`pk_live_...`) v `index.html`
  - Secret key (`sk_live_...`) v Supabase Secrets
- CSP hlaviƒçky aktualizov√°ny pro produkƒçn√≠ Clerk dom√©ny

### Google OAuth ‚úÖ

**Dokonƒçeno:**
- Google Cloud Console projekt "Liquimixer" vytvo≈ôen
- OAuth consent screen nakonfigurov√°n (External, In production)
- OAuth 2.0 Client ID vytvo≈ôen:
  - Client ID: `729409229192-bv7pgf4dh47587n11hr7nkcfpv2cfar7.apps.googleusercontent.com`
  - Authorized redirect URI: `https://clerk.liquimixer.com/v1/oauth_callback`
- Clerk integrace nastavena a otestov√°na
- Google p≈ôihl√°≈°en√≠ funguje ‚úÖ

### Facebook OAuth ‚úÖ HOTOVO - PRODUKƒåN√ç VERZE

**Dokonƒçeno:**
- Meta for Developers aplikace "LiquiMixer" vytvo≈ôena
- App ID: `1504788803953001`
- App Secret: `095643ebf168e1d6c09f2f6a8adf7a60`
- Facebook Login use case nakonfigurov√°n
- Valid OAuth Redirect URI: `https://clerk.liquimixer.com/v1/oauth_callback`
- Clerk integrace nastavena
- Privacy Policy a Terms of Service str√°nky vytvo≈ôeny:
  - `https://www.liquimixer.com/privacy.html`
  - `https://www.liquimixer.com/terms.html`
- Business Manager √∫ƒçet vytvo≈ôen (WOOs s r o)
- Business Verification **SCHV√ÅLENA** ‚úÖ
- Aplikace v **PRODUKƒåN√çM RE≈ΩIMU** ‚úÖ
- Facebook p≈ôihl√°≈°en√≠ funguje ‚úÖ

### Vyƒçi≈°tƒõn√≠ gpwebpay Edge Function ‚úÖ

- Odstranƒõno ~100 ≈ô√°dk≈Ø debug logov√°n√≠
- Ponech√°ny pouze chybov√© stavy (`console.error`)
- Nasazeno na Supabase

### Zdvojn√°soben√≠ tlou≈°≈•ky or√°mov√°n√≠ tlaƒç√≠tek ‚úÖ

| T≈ô√≠da | P≈Øvodn√≠ | Nov√Ω |
|-------|---------|------|
| `.nav-btn` | `1px` | `2px` |
| `.neon-button` | `3px` | `6px` |
| `.mode-button` | `3px` | `6px` |
| `.profile-action-btn` | `1px` | `2px` |
| `.profile-language-section .language-select` | `3px` | `6px` |
| `.auth-choice-btn.login-existing-btn` | `2px` | `4px` |

---

## ‚úÖ VY≈òE≈†ENO - 16.1.2026

### Tlaƒç√≠tko "P≈ôihl√°sit se" na sd√≠len√©m PRO receptu - OPRAVENO

**Probl√©m:** Funkce `handleSharedRecipeLogin()` volala `showLoginModal()`, ale tlaƒç√≠tko "Ulo≈æit k sobƒõ" pou≈æ√≠valo `showLoginRequiredModal()` - jin√Ω modal!

**≈òe≈°en√≠:** Zmƒõnƒõno `handleSharedRecipeLogin()` aby volala `showLoginRequiredModal()` m√≠sto `showLoginModal()`.

```javascript
function handleSharedRecipeLogin() {
    console.log('handleSharedRecipeLogin called');
    showLoginRequiredModal(); // Stejn√Ω modal jako "Ulo≈æit k sobƒõ"
}
```

### Deduplikace produkt≈Ø p≈ôi ukl√°d√°n√≠ sd√≠len√©ho receptu - IMPLEMENTOV√ÅNO

**Probl√©m:** P≈ôi ukl√°d√°n√≠ sd√≠len√©ho receptu se produkty v≈ædy duplikovaly.

**≈òe≈°en√≠:**
1. SQL migrace `20260116_add_product_code.sql` - p≈ôid√°n sloupec `product_code`
2. Funkce `getProductByCode()` kontroluje existuj√≠c√≠ produkty
3. Funkce `copyProductToUser()` pou≈æije existuj√≠c√≠ produkt se stejn√Ωm k√≥dem

### iDoklad VariableSymbol p≈ô√≠li≈° dlouh√Ω - OPRAVENO

**Probl√©m:** `orderNumber` z GP WebPay m√° 15 ƒç√≠slic, ale iDoklad povoluje max 10.

**≈òe≈°en√≠:** `VariableSymbol = orderNumber.slice(-10)` - posledn√≠ch 10 ƒç√≠slic pro p√°rov√°n√≠.

### Padding-top pro obsah pod navigac√≠ - OPRAVENO

**Probl√©m:** Nadpisy str√°nek se zobrazovaly za navigaƒçn√≠mi tlaƒç√≠tky.

**≈òe≈°en√≠:** P≈ôid√°no `padding-top: 68px` k `.page` v `styles.css`.

---

## ‚úÖ VY≈òE≈†ENO - 22.1.2026

### TikTok Login - Privacy Policy & Terms of Service

**Probl√©m:** TikTok zam√≠tl p≈ôihl√°≈°en√≠ p≈ôes jejich str√°nky, proto≈æe Terms a Privacy Policy nebyly snadno dostupn√©.

**≈òe≈°en√≠:**
1. P≈ôid√°n glob√°ln√≠ footer do `index.html` s odkazy na Privacy Policy a Terms of Service
2. Vytvo≈ôeny dynamick√© i18n str√°nky `privacy.html` a `terms.html`
3. P≈ôid√°ny p≈ôeklady do v≈°ech 31 jazyk≈Ø (`locales/*.json`):
   - `footer.privacy_policy`
   - `footer.terms_of_service`
   - Kompletn√≠ sekce `privacy` s 11 sekcemi textu
4. Footer styly v `styles.css` s FOUC prevenc√≠
5. Opraveny probl√©my s p≈ôekr√Ωv√°n√≠m footeru a tlaƒç√≠tek (z-index, padding)

**Str√°nky:**
- `https://www.liquimixer.com/privacy.html`
- `https://www.liquimixer.com/terms.html`

### P≈ôipom√≠nky zr√°n√≠ - Opravy

**Vy≈ôe≈°en√© probl√©my:**
1. **Pozn√°mka se neukl√°dala** - opraveno ƒçten√≠ `reminderNote` v `saveReminderFromModal()` a `saveNewReminder()`
2. **Pozn√°mka se p≈ôepisovala** - opraveno ƒçi≈°tƒõn√≠ pozn√°mky p≈ôi otev≈ôen√≠ nov√© p≈ôipom√≠nky
3. **Detail p≈ôipom√≠nky** - p≈ôid√°n nov√Ω `viewReminderModal` pro zobrazen√≠ detailu bez editace

### Service Worker Update Prompt

**Probl√©m:** Prompt o nov√© verzi aplikace se zobrazoval p≈ô√≠li≈° ƒçasto.

**≈òe≈°en√≠:** Implementov√°n cooldown 5 minut pomoc√≠ localStorage.

### Facebook OAuth - PRODUKƒåN√ç VERZE ‚úÖ

**Stav:** Business Verification schv√°lena, aplikace v produkƒçn√≠m re≈æimu, Facebook p≈ôihl√°≈°en√≠ funguje.

---

## ‚úÖ VY≈òE≈†ENO - 26.1.2026

### Pricing podle zemƒõ (country_code) - IMPLEMENTOV√ÅNO

**Probl√©m:** Slovensko (SK) dost√°valo ≈°patnou cenu - 59 CZK m√≠sto 2.40 EUR, proto≈æe pricing se hledal podle locale ('sk'), kter√© neexistovalo.

**≈òe≈°en√≠:**
1. **Nov√Ω sloupec `country_code`** v tabulce `pricing`
2. **Kompletn√≠ pricing pro v≈°echny zemƒõ svƒõta** (~90 zem√≠):
   - CZ: 48.76 CZK + 21% DPH = 59 CZK
   - EU zemƒõ (26): 1.98 EUR + 21% DPH = 2.40 EUR (OSS re≈æim)
   - USD zemƒõ (US, CA, JP, KR, atd.): 2.90 USD + 0% DPH
   - Ostatn√≠: 2.40 EUR + 0% DPH
3. **Fallback v subscription/index.ts:** EUR 2.40, 0% DPH pro nezn√°m√© zemƒõ
4. **SQL migrace:** `20260126_add_country_pricing.sql`

**Nasazeno:**
- ‚úÖ Edge function `subscription` deployed
- ‚úÖ SQL migrace spu≈°tƒõna v Supabase Dashboard
- ‚úÖ GitHub push

### Browser History API navigace - IMPLEMENTOV√ÅNO

**Probl√©m:** Tlaƒç√≠tka "Zpƒõt" vracely na hardcoded str√°nku m√≠sto p≈ôedchoz√≠ str√°nky v historii.

**≈òe≈°en√≠ v `app.js`:**
```javascript
let currentPageId = 'intro';

function showPage(pageId, pushToHistory = true) {
    if (pageId === currentPageId && pushToHistory) return;
    // ... zobrazen√≠ str√°nky ...
    if (pushToHistory) {
        history.pushState({ pageId: pageId }, '', '');
    }
    currentPageId = pageId;
}

function initHistoryNavigation() {
    history.replaceState({ pageId: 'intro' }, '', '');
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.pageId) {
            showPage(event.state.pageId, false);
        } else {
            showPage('intro', false);
        }
    });
}

function goBack() {
    if (history.length > 1) {
        history.back();
    } else {
        showPage('intro');
    }
}
```

**Zmƒõny v `index.html`:**
- V≈°echna tlaƒç√≠tka "Zpƒõt" zmƒõnƒõna na `onclick="goBack()"`
- Celkem 8 tlaƒç√≠tek opraveno

### Privacy.html text - OPRAVEN

**Probl√©m:** Text obsahoval "V aplikaci: Menu ‚Üí M≈Øj √∫ƒçet ‚Üí Smazat √∫ƒçet" - tato funkce neexistuje.

**≈òe≈°en√≠:** Zmƒõnƒõno na spr√°vnou navigaci: "Menu ‚Üí Kontakt ‚Üí GDPR / Smaz√°n√≠ √∫daj≈Ø"

### PWA jazyk detekce - IMPLEMENTOV√ÅNO

**≈òe≈°en√≠ v `index.html`:**
```html
<head>
    <meta charset="UTF-8">
    <script>
    (function() {
        var SUPPORTED = ['cs','en','de','fr','es',...];
        var saved = localStorage.getItem('liquimixer_locale');
        var lang = saved || navigator.language || 'cs';
        if (SUPPORTED.indexOf(lang) !== -1) {
            document.documentElement.lang = lang.split('-')[0];
        } else {
            var base = lang.split('-')[0].toLowerCase();
            if (SUPPORTED.indexOf(base) !== -1) {
                document.documentElement.lang = base;
            }
        }
    })();
    </script>
    <!-- ... -->
</head>
```

### ƒåekaj√≠c√≠ na schv√°len√≠

| Slu≈æba | Stav | Pozn√°mka |
|--------|------|----------|
| Apple Sign In | ‚è≥ ƒåek√° na registraci | Developer Program $99/rok |
| TikTok OAuth | ‚úÖ SCHV√ÅLENO | Live od 27.1.2026, credentials nastaveny v Clerk |

### SK platba - K TESTOV√ÅN√ç

- Pricing pro SK je p≈ôipraven: 1.98 EUR + 21% DPH = 2.40 EUR
- ƒåek√° na testov√°n√≠ u≈æivatelem

---

## ‚úÖ VY≈òE≈†ENO - 27.1.2026

### TikTok OAuth - SCHV√ÅLENO A AKTIVN√ç

- TikTok aplikace schv√°lena a v re≈æimu "Live" od 27.1.2026
- Credentials nastaveny v Clerk Dashboard (Configure ‚Üí SSO Connections ‚Üí TikTok)
- Client Key a Client Secret z TikTok Developer Portal

### Rozhodovac√≠ modal pro p≈ôihl√°≈°en√≠ - IMPLEMENTOV√ÅNO

**Probl√©m:** OAuth registrace (Continue with Google/TikTok/Facebook) obch√°zela souhlas s obchodn√≠mi podm√≠nkami. U≈æivatel byl nejprve zaregistrov√°n a a≈æ pot√© vidƒõl modal s platbou - co≈æ je v rozporu se z√°kony.

**≈òe≈°en√≠ - Rozhodovac√≠ modal + ulo≈æen√≠ souhlasu do DB:**

1. **Nov√Ω rozhodovac√≠ modal (`authChoiceModal`):**
   - Zobraz√≠ se p≈ôi kliknut√≠ na tlaƒç√≠tko "P≈ôihl√°≈°en√≠"
   - Nab√≠z√≠ dvƒõ mo≈ænosti: "M√°m √∫ƒçet, p≈ôihl√°sit se" / "Chci se registrovat"
   - Existuj√≠c√≠ u≈æivatel ‚Üí Clerk SignIn (OAuth funguje norm√°lnƒõ)
   - Nov√Ω u≈æivatel ‚Üí subscriptionModal (vid√≠ cenu, souhlas√≠ s OP, pak registrace)

2. **Nov√Ω sloupec `terms_accepted_at` v tabulce `users`:**
   - SQL migrace: `20260127_add_terms_accepted.sql`
   - Ukl√°d√° timestamp souhlasu s obchodn√≠mi podm√≠nkami

3. **Logika kontroly souhlasu:**
   - V `showSubscriptionModal()` se kontroluje `terms_accepted_at` z DB
   - P≈ôihl√°≈°en√Ω u≈æivatel BEZ souhlasu ‚Üí zobraz√≠ se Stav A (guestState s checkboxem)
   - P≈ôihl√°≈°en√Ω u≈æivatel SE souhlasem ‚Üí zobraz√≠ se Stav B (loggedInState, jen platba)

4. **Ulo≈æen√≠ souhlasu:**
   - P≈ôi registraci p≈ôes subscriptionModal se souhlas ukl√°d√° do localStorage
   - Po √∫spƒõ≈°n√© registraci v Clerk se souhlas p≈ôenese do DB
   - Funkce `saveTermsAcceptance()` v database.js

**Soubory upraven√©:**
- `index.html` - p≈ôid√°n authChoiceModal
- `app.js` - funkce pro authChoiceModal, √∫prava showSubscriptionModal(), startRegistrationAndPayment()
- `database.js` - nov√° funkce saveTermsAcceptance()
- `sw.js` - verze zv√Ω≈°ena na v122
- `locales/*.json` - p≈ôeklady auth_choice do 31 jazyk≈Ø
- `supabase/migrations/20260127_add_terms_accepted.sql` - nov√Ω sloupec

**Nov√© p≈ôeklady (auth_choice):**
- `auth_choice.title` - "P≈ôihl√°≈°en√≠"
- `auth_choice.question` - "M√°te ji≈æ √∫ƒçet v LiquiMixer?"
- `auth_choice.have_account` - "M√°m √∫ƒçet, p≈ôihl√°sit se"
- `auth_choice.want_register` - "Chci se registrovat"

### P≈ôeklady auth_choice modalu - PROBL√âM S CACHE

**Probl√©m:** Po nasazen√≠ nov√©ho rozhodovac√≠ho modalu se p≈ôeklady nezobrazovaly spr√°vnƒõ - modal byl anglicky, zat√≠mco zbytek str√°nky ƒçesky.

**P≈ô√≠ƒçina:** 
- Lokalizaƒçn√≠ soubory (`cs.json`) byly naƒç√≠t√°ny z HTTP cache prohl√≠≈æeƒçe
- Star√° verze `cs.json` neobsahovala sekci `auth_choice`
- Funkce `t('auth_choice.title')` nena≈°la kl√≠ƒç v `translations`, pou≈æila fallback z `englishTranslations`
- V anonymn√≠m oknƒõ fungovalo spr√°vnƒõ (ƒçist√° cache)

**≈òe≈°en√≠:**
- Service Worker verze zv√Ω≈°ena na `v123`
- `networkFirstFiles` v `sw.js` roz≈°√≠≈ôeno o `/locales/` prefix pro v≈°echny jazykov√© soubory
- U≈æivatel musel manu√°lnƒõ vymazat HTTP cache prohl√≠≈æeƒçe (Ctrl+Shift+Delete ‚Üí "Obr√°zky a soubory v mezipamƒõti")

**Pouƒçen√≠:**
- P≈ôi p≈ôid√°v√°n√≠ nov√Ωch p≈ôekladov√Ωch kl√≠ƒç≈Ø v≈ædy zv√Ω≈°it verzi SW cache
- Lokalizaƒçn√≠ soubory by mƒõly b√Ωt v≈ædy naƒç√≠t√°ny network-first strategi√≠
- Po nasazen√≠ informovat u≈æivatele o pot≈ôebƒõ vymazat cache, pokud p≈ôeklady nefunguj√≠

---

## ‚è≥ ƒåEKAJ√çC√ç √öKOLY (27.1.2026)

| √ökol | Stav | Pozn√°mka |
|------|------|----------|
| SK platba testov√°n√≠ | ‚è≥ P≈ôes v√≠kend | 2.40 EUR pro SK z√°kazn√≠ky |
| Apple Developer Program | ‚è≥ Zpracov√°v√° se | Enrollment ID: 2D2P4U5VJU, od ~20.1.2026 |

---

## üîç SEO & REGISTRACE DO VYHLED√ÅVAƒå≈Æ

### Co je p≈ôipraveno ‚úÖ

| Soubor | Popis | Stav |
|--------|-------|------|
| `robots.txt` | Povolen√≠ pro v≈°echny vyhled√°vaƒçe + AI crawlery | ‚úÖ Hotovo |
| `sitemap.xml` | V≈°ech 31 jazykov√Ωch verz√≠ s prioritami | ‚úÖ Hotovo |
| `llms.txt` | Informace pro AI syst√©my (ChatGPT, Claude, Perplexity) | ‚úÖ Hotovo |
| Schema.org JSON-LD | Strukturovan√° data pro rich snippets | ‚úÖ V index.html |
| Open Graph meta tagy | Pro sd√≠len√≠ na soci√°ln√≠ch s√≠t√≠ch | ‚úÖ V index.html |

### √ökoly p≈ôed spu≈°tƒõn√≠m

| √ökol | Stav | Pozn√°mka |
|------|------|----------|
| Export OG obr√°zku do PNG | ‚è≥ TODO | `icons/og-image.svg` ‚Üí `icons/og-image.png` (1200√ó630px) |
| Nasadit web na produkƒçn√≠ URL | ‚è≥ TODO | https://www.liquimixer.com |

### Registrace do vyhled√°vaƒç≈Ø (po nasazen√≠)

| Platforma | URL | Priorita | Stav |
|-----------|-----|----------|------|
| Google Search Console | https://search.google.com/search-console | ‚≠ê‚≠ê‚≠ê Nejvy≈°≈°√≠ | ‚è≥ TODO |
| Bing Webmaster Tools | https://www.bing.com/webmasters | ‚≠ê‚≠ê‚≠ê Vysok√° | ‚è≥ TODO |
| Yandex Webmaster | https://webmaster.yandex.com | ‚≠ê‚≠ê St≈ôedn√≠ | ‚è≥ TODO |

### AI syst√©my (automaticky - bez registrace)

| Syst√©m | User-Agent | Stav |
|--------|------------|------|
| ChatGPT/OpenAI | GPTBot, ChatGPT-User | ‚úÖ Povoleno v robots.txt |
| Claude/Anthropic | Claude-Web, anthropic-ai | ‚úÖ Povoleno v robots.txt |
| Perplexity AI | PerplexityBot | ‚úÖ Povoleno v robots.txt |
| Google Gemini | Google-Extended | ‚úÖ Povoleno v robots.txt |
| Microsoft Copilot | Copilot | ‚úÖ Povoleno v robots.txt |

**Pozn√°mka:** AI syst√©my nevy≈æaduj√≠ speci√°ln√≠ registraci. Soubor `llms.txt` poskytuje kontext pro citace.

### Apple Developer Program - ƒçek√° na schv√°len√≠

| Detail | Hodnota |
|--------|---------|
| Enrollment ID | 2D2P4U5VJU |
| Typ √∫ƒçtu | Organization (WOOs s.r.o.) |
| Datum odesl√°n√≠ | ~20.1.2026 |
| Oƒçek√°van√° doba schv√°len√≠ | 1-3 t√Ωdny (firemn√≠ √∫ƒçty mimo USA/UK) |
| Stav | ‚è≥ "Your enrollment is being processed" |

**Po schv√°len√≠ Apple Developer:**
1. Nastavit Apple Sign In v Apple Developer Console
2. Integrovat s Clerk (SSO Connections ‚Üí Apple)
3. Volitelnƒõ: Publikovat PWA do App Store

### Dokumentace

Kompletn√≠ n√°vod pro registraci do vyhled√°vaƒç≈Ø: `SEO-REGISTRATION-GUIDE.md`

---

## üîî P≈òIPOM√çNKY ZR√ÅN√ç (STEEPING REMINDERS)

### Implementace (28.1.2026)

**Probl√©m:** Notifikace p≈ôipom√≠nek zr√°n√≠ nefungovaly.

**Root cause anal√Ωza:**
1. FCM tokeny se neukl√°daly do datab√°ze (chybƒõly funkce `saveFcmToken`, `deleteFcmToken`)
2. CRON job pro vol√°n√≠ `reminder-notify` nebyl nakonfigurov√°n
3. Chybƒõla in-app notifikace p≈ôi otev≈ôen√≠ aplikace
4. Chybƒõlo vizu√°ln√≠ oznaƒçen√≠ vyzr√°l√Ωch liquid≈Ø

**Implementovan√© zmƒõny:**

| Soubor | Zmƒõna |
|--------|-------|
| `database.js` | P≈ôid√°ny `saveFcmToken()`, `deleteFcmToken()`, `getFcmTokens()` + export `window.database` |
| `app.js` | P≈ôid√°na `checkMaturedReminders()` - kontrola p≈ôi p≈ôihl√°≈°en√≠ |
| `app.js` | P≈ôid√°na `showMaturedLiquidsNotification()` - in-app toast |
| `app.js` | Upravena `renderReminderItem()` - zelen√© podbarven√≠ vyzr√°l√Ωch |
| `styles.css` | P≈ôid√°ny styly `.reminder-item.matured`, `.matured-notification` |
| `locales/*.json` | P≈ôid√°ny p≈ôeklady: `reminder.matured*`, `common.dismiss` (31 jazyk≈Ø) |

**CRON job pro notifikace:**
- Soubor: `supabase/migrations/20260128_add_reminder_cron.sql`
- Job name: `send-maturity-reminders`
- Schedule: `0 9 * * *` (ka≈æd√Ω den v 09:00 UTC)
- Vol√°: `reminder-notify` edge function

**Stav CRON jobu:**
- ‚úÖ Vytvo≈ôen a aktivn√≠ (job ID: 6)
- Viz Supabase Dashboard ‚Üí Integrations ‚Üí Cron ‚Üí Jobs

### Tok notifikac√≠

```
1. PUSH NOTIFIKACE (backend):
   CRON 09:00 UTC ‚Üí reminder-notify ‚Üí naƒçte pending reminders ‚Üí 
   ‚Üí naƒçte FCM tokeny z fcm_tokens ‚Üí ode≈°le push p≈ôes FCM API

2. IN-APP NOTIFIKACE (frontend):
   U≈æivatel se p≈ôihl√°s√≠ ‚Üí checkMaturedReminders() ‚Üí 
   ‚Üí najde vyzr√°l√© (remind_at <= dnes && status=pending) ‚Üí
   ‚Üí zobraz√≠ toast s tlaƒç√≠tky "Zobrazit recepty" / "Zav≈ô√≠t"

3. VIZU√ÅLN√ç OZNAƒåEN√ç:
   renderReminderItem() ‚Üí isMatured check ‚Üí 
   ‚Üí CSS t≈ô√≠da .matured ‚Üí zelen√© podbarven√≠ + badge "Vyzr√°lo"
```

### FCM tokeny

**Tabulka:** `public.fcm_tokens`
```sql
clerk_id    VARCHAR PRIMARY KEY
token       TEXT
device_info JSONB
updated_at  TIMESTAMP
last_used_at TIMESTAMP
```

**Ulo≈æen√≠ tokenu:**
- `fcm.js` ‚Üí `getFcmToken()` ‚Üí `window.database.saveFcmToken()`
- Vol√°no p≈ôi p≈ôihl√°≈°en√≠ a povolen√≠ notifikac√≠

### Testov√°n√≠ p≈ôipom√≠nek

1. Vytvo≈ôit p≈ôipom√≠nku s datem v minulosti
2. P≈ôipom√≠nka by mƒõla m√≠t zelen√© podbarven√≠ a badge "Vyzr√°lo"
3. Po p≈ôihl√°≈°en√≠ by se mƒõla zobrazit toast notifikace

---

## üîß SUPABASE CLI

### P≈ô√≠stup

Supabase CLI je dostupn√© p≈ôes `npx supabase`:

```bash
# Verze
npx supabase --version

# Seznam projekt≈Ø (ovƒõ≈ôen√≠ p≈ôihl√°≈°en√≠)
npx supabase projects list

# Push migrac√≠
npx supabase db push

# Nasazen√≠ edge funkc√≠
npx supabase functions deploy --project-ref krwdfxnvhnxtkhtkbadi
```

### Projekt Liquimixer

| Atribut | Hodnota |
|---------|---------|
| Reference ID | krwdfxnvhnxtkhtkbadi |
| N√°zev | Liquimixer |
| Region | West EU (Ireland) |
| Linked | ‚úÖ Ano |

### Migrace

**Pozn√°mka:** Nƒõkter√© star≈°√≠ migrace byly aplikov√°ny ruƒçnƒõ v SQL Editoru a nejsou v migraƒçn√≠ historii Supabase. P≈ôi `db push` je nutn√© pou≈æ√≠t `--include-all` flag, nebo aplikovat migrace jednotlivƒõ v SQL Editoru.

**Migrace nesledovan√© v historii:**
- `20250107_fix_reminders_rls.sql`
- `20260109_user_cleanup_columns.sql`
- `20260112_add_user_locale_to_subscriptions.sql`
- `20260114_add_idoklad_vat_code_id.sql`

---

## üìÖ DENN√ç Z√ÅZNAMY

### 29.01.2026 - Liquid PRO formul√°≈ô, p≈ôeklady, VG/PG logika

**Implementovan√© funkce:**

1. **Automatick√Ω v√Ωpoƒçet VG/PG slideru z kombinace slo≈æek (premixed mode)**
   - Nov√° funkce `calculateActualVgPgRatio()` poƒç√≠t√° skuteƒçn√Ω VG/PG pomƒõr ze v≈°ech slo≈æek
   - Nov√° funkce `autoRecalculateProVgPgRatio()` se vol√° p≈ôi ka≈æd√© zmƒõnƒõ ve formul√°≈ôi
   - Slider se automaticky nastav√≠ na vypoƒçten√Ω pomƒõr bez pot≈ôeby doladƒõn√≠

2. **Oprava rozbalen√≠ panelu "Slo≈æen√≠ p≈ô√≠chutƒõ"**
   - Zmƒõnƒõno z `hidden` t≈ô√≠dy na `open` t≈ô√≠du pro spr√°vnou CSS animaci
   - Panel se nyn√≠ plynule otev√≠r√°/zav√≠r√°

3. **Oprava rozbalen√≠ panelu "Vlastn√≠ slo≈æen√≠" u aditiv**
   - Stejn√° oprava jako u p≈ô√≠chut√≠ - pou≈æit√≠ `open` t≈ô√≠dy

4. **Zvƒõt≈°en√≠ input pol√≠ pro % slo≈æek**
   - `.composition-item .neon-input.tiny`: 65px ‚Üí 70px
   - Vƒõt≈°√≠ padding a font-size

5. **Zobrazen√≠ hodnot limit≈Ø VG/PG**
   - P≈ôid√°ny elementy `proLimitValueLeft` a `proLimitValueRight`
   - Zobrazuj√≠ procentu√°ln√≠ hodnoty limit≈Ø nad sliderem (nap≈ô. "15%" a "75%")

6. **Automatick√Ω p≈ôepoƒçet slo≈æen√≠ aditiv na 100%**
   - Funkce `updateAdditiveCompositionOther()` proporcion√°lnƒõ sni≈æuje hodnoty pokud p≈ôes√°hnou 100%

7. **Eliminace zbyteƒçn√©ho doladƒõn√≠ VG/PG**
   - Pokud slider odpov√≠d√° skuteƒçn√©mu pomƒõru (¬±1.5%), nep≈ôid√°v√° se doladƒõn√≠
   - Doladƒõn√≠ pouze kdy≈æ u≈æivatel ruƒçnƒõ zmƒõn√≠ slider

8. **P≈ôeklady pro nicotine salt type**
   - P≈ôid√°no vol√°n√≠ `applyTranslations()` p≈ôi zobrazen√≠ kontejneru s typem soli
   - V≈°ech 31 jazyk≈Ø m√° p≈ôeklady pro salt_type kl√≠ƒçe

9. **P≈ôeklady mixing notes**
   - Doplnƒõny kl√≠ƒçe `notes_flavors_first`, `notes_nicotine`, `notes_premixed`, `notes_adjustment`, `notes_pg_vg`, `notes_shake`, `notes_steep` do v≈°ech 31 jazyk≈Ø

**Supabase CLI:**

```bash
# Nasazen√≠ edge funkc√≠ (SPR√ÅVN√ù project-ref!)
npx supabase functions deploy --project-ref krwdfxnvhnxtkhtkbadi

# POZOR: Star√Ω project-ref yulxjnhonlgqzwnrchpn je NEPLATN√ù!
# Spr√°vn√Ω project-ref: krwdfxnvhnxtkhtkbadi
```

**Git commity:**
- `fix: VG/PG slider auto-calc, flavor composition panel, additive input width, rounding, translations for all 31 languages`
- `fix: larger composition inputs, additive panel open animation, VG/PG limit values display`
- `feat: auto-recalculate VG/PG ratio on every form change, fix additive composition to always sum 100%`
- `fix: eliminate VG/PG adjustment when slider matches actual ratio, apply translations on salt type container show`

---

### 30.01.2026 - Ve≈ôejn√° datab√°ze recept≈Ø, skladov√° z√°soba, UI opravy

**Implementovan√© funkce:**

1. **Ve≈ôejn√° datab√°ze recept≈Ø (Public Recipe Database)**
   - Nov√° sekce "Datab√°ze recept≈Ø" v menu (pouze pro p≈ôihl√°≈°en√©)
   - Toggle switch "Sd√≠let do ve≈ôejn√© datab√°ze" p≈ôi ukl√°d√°n√≠ receptu
   - Roz≈°√≠≈ôen√© filtry: metoda p≈ô√≠pravy, typ p≈ô√≠chutƒõ, VG/PG, nikotin, aditiva
   - Hvƒõzdiƒçkov√© hodnocen√≠ recept≈Ø (1-5)
   - ≈òazen√≠ a paginace (50 recept≈Ø/str√°nka)
   - Detail receptu s mo≈ænost√≠ "Ulo≈æit k sobƒõ"
   - Blokov√°n√≠ sd√≠len√≠ p≈ôi ukl√°d√°n√≠ ze sd√≠len√© datab√°ze (prevence duplik√°t≈Ø)

2. **Skladov√° z√°soba na p≈ôipom√≠nk√°ch zr√°n√≠ (Stock Tracking)**
   - Bateriov√Ω indik√°tor z√°soby (0-100%)
   - Tlaƒç√≠tka +/- pro √∫pravu (¬±10%)
   - Dynamick√© barvy: zelen√° >50%, ≈ælut√° 20-50%, ƒçerven√° <20%
   - Okam≈æit√° UI aktualizace (stockCache + non-blocking DB update)
   - Potvrzovac√≠ dialog p≈ôi 0%
   - Spot≈ôebovan√© p≈ôipom√≠nky automaticky zmiz√≠

3. **Mobiln√≠ layout p≈ôipom√≠nek**
   - Nov√Ω wrapper `.reminder-controls` pro stock bar + akƒçn√≠ tlaƒç√≠tka
   - Responzivn√≠ 2-≈ô√°dkov√Ω layout na mobilech (<600px):
     - 1. ≈ô√°dek: datumy
     - 2. ≈ô√°dek: stock bar + tlaƒç√≠tka edit/delete
   - Men≈°√≠ baterie a tlaƒç√≠tka na velmi mal√Ωch obrazovk√°ch (<400px)

4. **CSS filtry - flex wrap layout**
   - Zmƒõnƒõno z grid na flex-wrap pro lep≈°√≠ responsivitu
   - Ka≈æd√Ω filtr m√° `min-width: 140px`
   - Tlaƒç√≠tko reset vpravo d√≠ky `margin-left: auto`

5. **P≈ôeklady filtr≈Ø - dynamick√° regenerace**
   - `initFlavorFilterOptions()` p≈ôegeneruje options p≈ôi ka≈æd√©m otev≈ôen√≠
   - P≈ôeklady se spr√°vnƒõ aplikuj√≠ p≈ôi zmƒõnƒõ jazyka
   - `applyTranslations()` vol√°no v `showRecipeDatabase()` a `toggleDatabaseFilters()`

6. **Service Worker verze**
   - Zv√Ω≈°ena z `v135` na `v138`

**DB migrace (manu√°lnƒõ v SQL Editoru):**
- `20260131_add_public_recipes.sql` - is_public, rating_avg, rating_count, form_type v recipes + tabulka recipe_ratings
- `20260131_add_reminder_stock.sql` - stock_percent, consumed_at v recipe_reminders

**Git commity:**
- `Fix-filters-layout-flex-wrap-and-public-checkbox-logic`
- `Fix-flavor-filter-translations-regenerate-on-language-change`
- `Fix-mobile-reminder-layout-two-rows`

**Zmƒõnƒõn√© soubory:**

| Soubor | Zmƒõna |
|--------|-------|
| `app.js` | Ve≈ôejn√© recepty, stock tracking, mobiln√≠ layout, p≈ôeklady filtr≈Ø, appendBackToDatabaseButton() |
| `styles.css` | Flex wrap filtry, stock bar baterie, mobiln√≠ responsive, reminder-controls |
| `database.js` | getPublicRecipes, getPublicRecipeById, addRecipeRating, updateReminderStock, markReminderConsumed |
| `index.html` | Str√°nka recipe-database, toggle switches, data-i18n na option elements |
| `locales/*.json` | ~35 nov√Ωch kl√≠ƒç≈Ø: recipe_database.*, rating.*, save_recipe.make_public, reminder.stock_* |
| `sw.js` | Verze v135 ‚Üí v138 |

---

### 30.01.2026 (r√°no) - Service Worker notifikace, sjednocen√≠ tlaƒç√≠tek

**Implementovan√© funkce:**

1. **Notifikace o nov√© verzi aplikace (Service Worker)**
   - P≈ôid√°n listener pro zpr√°vy od Service Workeru v `setupServiceWorkerListener()`
   - Nov√° funkce `showUpdateNotification()` zobraz√≠ notifikaci s tlaƒç√≠tky "Aktualizovat" a "Pozdƒõji"
   - Funkce `refreshApp()` vyma≈æe cache a obnov√≠ str√°nku
   - CSS styly pro `.update-notification` - animovan√Ω toast naho≈ôe na str√°nce
   - P≈ôeklady sekce `update` ve v≈°ech 31 jazyc√≠ch:
     - `new_version_title`, `new_version_text`, `refresh`, `dismiss`

2. **Sjednocen√≠ tlaƒç√≠tek v aplikaci**
   - Odstranƒõn p≈ôepisuj√≠c√≠ styl pro Shortfill tlaƒç√≠tko:
     ```css
     /* Odstranƒõno: */
     .form-purple .neon-button:not(.secondary) {
         background: linear-gradient(135deg, var(--neon-purple), #8800cc);
     }
     ```
   - Nyn√≠ v≈°echna tlaƒç√≠tka maj√≠ jemn√© pozad√≠ `rgba(..., 0.08)`:
     - R≈Ø≈æov√© (v√Ωchoz√≠): `rgba(255, 0, 255, 0.08)`
     - Cyan (secondary): `rgba(0, 255, 255, 0.06)`
     - Zelen√© (btn-green): `rgba(0, 255, 0, 0.08)`
     - ƒåerven√© (btn-red): jemn√Ω gradient
     - Fialov√© (btn-purple): `rgba(136, 0, 255, 0.08)`

3. **Service Worker verze**
   - Zv√Ω≈°ena z `v130` na `v131`

**Git commit:**
- `feat: Add update notification, fix Shortfill button style, SW version bump to v131`

**Zmƒõnƒõn√© soubory:**

| Soubor | Zmƒõna |
|--------|-------|
| `app.js` | P≈ôid√°ny funkce `setupServiceWorkerListener()`, `showUpdateNotification()`, `dismissUpdateNotification()`, `refreshApp()` |
| `styles.css` | P≈ôid√°ny styly `.update-notification`, odstranƒõn `.form-purple .neon-button:not(.secondary)` gradient |
| `sw.js` | Verze `v130` ‚Üí `v131` |
| `locales/*.json` | P≈ôid√°na sekce `update` se 4 kl√≠ƒçi do v≈°ech 31 jazyk≈Ø |

---

## üìã √öKOLY K ≈òE≈†EN√ç

### ‚úÖ HOTOVO (30.01.2026)

1. **Ve≈ôejn√© recepty a komunita** - ‚úÖ IMPLEMENTOV√ÅNO
   - Mo≈ænost ulo≈æit recept jako "ve≈ôejn√Ω" (toggle switch p≈ôi ukl√°d√°n√≠)
   - Nov√° sekce v menu "Datab√°ze recept≈Ø" (pouze pro p≈ôihl√°≈°en√©)
   - Vyhled√°v√°n√≠ a filtrov√°n√≠ ve≈ôejn√Ωch recept≈Ø:
     - Podle n√°zvu (fulltext search)
     - Metody p≈ô√≠pravy (liquid, shakevape, shortfill, liquidpro)
     - Typu p≈ô√≠chutƒõ (z flavorDatabase)
     - VG/PG pomƒõru (min/max)
     - S√≠ly nikotinu (min/max)
     - Obsahuje aditiva (toggle)
   - Hodnocen√≠ recept≈Ø: hvƒõzdiƒçky (1-5), pr≈Ømƒõrn√© hodnocen√≠
   - ≈òazen√≠: hodnocen√≠ (nejlep≈°√≠/nejhor≈°√≠), n√°zev (A-Z/Z-A), datum (nejnovƒõj≈°√≠/nejstar≈°√≠)
   - Paginace: 50 recept≈Ø na str√°nku
   - Mo≈ænost "ulo≈æit k sobƒõ" ve≈ôejn√Ω recept
   - DB: `recipes` roz≈°√≠≈ôeno o `is_public`, `public_rating_avg`, `public_rating_count`, `form_type`
   - DB: nov√° tabulka `recipe_ratings` (recipe_id, clerk_id, rating, created_at)

2. **Skladov√° z√°soba na p≈ôipom√≠nk√°ch zr√°n√≠** - ‚úÖ IMPLEMENTOV√ÅNO
   - Vizu√°ln√≠ ukazatel z√°soby (0-100%) ve stylu baterie mobilu
   - Tlaƒç√≠tka + a - pro √∫pravu (¬±10% p≈ôi ka≈æd√©m stisku)
   - Barvy podle stavu: zelen√° >50%, ≈ælut√° 20-50%, ƒçerven√° <20%
   - Okam≈æit√° aktualizace UI (stockCache + non-blocking DB update)
   - Potvrzovac√≠ dialog p≈ôi dosa≈æen√≠ 0%
   - P≈ôi 0% se p≈ôipom√≠nka oznaƒç√≠ jako "spot≈ôebov√°no" a zmiz√≠ ze seznamu
   - Stock bar zobrazen v p≈ôehledu i v detailu p≈ôipom√≠nky
   - DB: `recipe_reminders` roz≈°√≠≈ôeno o `stock_percent`, `consumed_at`

### Priorita VYSOK√Å

3. **Hookah/Shisha formul√°≈ô** - ‚è≥ NAPL√ÅNOV√ÅNO
   - Samostatn√° z√°lo≈æka "Shisha" vedle Liquid, Shake & Vape, Shortfill
   - Kalkulace: VG/PG (80/20 v√Ωchoz√≠), p≈ô√≠chutƒõ (15-30%), sladidlo, voliteln√Ω nikotin
   - Vƒõt≈°√≠ objemy (100-500ml)
   - Shisha-specifick√© p≈ô√≠chutƒõ (Double Apple, Mint, Grape, Watermelon, Lemon Mint...)
   - Krat≈°√≠ steeping ƒçasy (1-7 dn√≠)
   - P≈ôeklady do 31 jazyk≈Ø (priorita: AR, TR, DE, RU, FR)
   - SEO pro hookah kl√≠ƒçov√° slova
   - Odhadovan√Ω ƒças: 24-40 hodin
   - Potenci√°l: 40-50 mil hookah u≈æivatel≈Ø glob√°lnƒõ, NULOV√Å konkurence

### Priorita ST≈òEDN√ç

3. **Manu√°l/N√°povƒõda pro PRO u≈æivatele**
   - Vysvƒõtlen√≠ vzorc≈Ø v√Ωpoƒçt≈Ø
   - Steeping ƒçasy podle typu p≈ô√≠chutƒõ
   - Slo≈æen√≠ p≈ô√≠chut√≠ (PG/VG/Alkohol)
   - Nikotinov√© soli vs. freebase
   - Aditiva a jejich pou≈æit√≠

4. **Batch scaling (≈°k√°lov√°n√≠ recept≈Ø)**
   - Mo≈ænost n√°sobit recept (2√ó, 3√ó, 5√ó, vlastn√≠)

5. **Export recept≈Ø**
   - Export do Reddit markdown, BBCode, HTML

### Priorita N√çZK√Å

6. **V√≠ce grafick√Ωch motiv≈Ø**
   - Light mode, OLED Black mode
   - Volba v u≈æivatelsk√©m profilu

7. **Datab√°ze p≈ô√≠chut√≠ od v√Ωrobc≈Ø**
   - Import datab√°ze p≈ô√≠chut√≠ (Capella, TPA, FlavourArt...)
   - Doporuƒçen√© % pro ka≈ædou p≈ô√≠chu≈•

---

## üí∞ CENOV√Å ANAL√ùZA KONKURENCE (30.01.2026)

### P≈ôehled monetizace e-liquid kalkulaƒçek

| Aplikace | Model | Cena | Pozn√°mka |
|----------|-------|------|----------|
| **LiquiMixer** | Freemium | 59 CZK / 2.40 EUR / 2.90 USD roƒçnƒõ | PRO funkce: Liquid PRO, ukl√°d√°n√≠, p≈ôipom√≠nky |
| **eJuice Calc** | Freemium | Nezn√°m√° (placen√© pl√°ny) | 4800+ z√°kazn√≠k≈Ø |
| **AllTheFlavors** | Freemium | Nezn√°m√° (m√° pr√©miov√© funkce) | Komunita recept≈Ø |
| **e-liquid-recipes.com** | Patreon | 10.50 EUR/mƒõs√≠c | Pouze odstranƒõn√≠ reklam, 82 patron≈Ø |
| **Vapable Calculator** | Free | Zdarma | Souƒç√°st e-shopu Vapable |
| **Steam-Engine** | Free | Zdarma | Donace p≈ôes reklamy |
| **Vapeshaker** | Free | Zdarma | Invent√°≈ô + steeping |
| **dot1ml** | Free | Zdarma (nav≈ædy) | Registrace pro ulo≈æen√≠ recept≈Ø |
| **Vaper.ninja** | Free | Zdarma | D≈Øraz na p≈ôesnost |
| **Liquix** | Free | Zdarma (Android) | 4000+ komunitn√≠ch recept≈Ø |

### Srovn√°n√≠ cen s LiquiMixer

| Slu≈æba | Mƒõs√≠ƒçn√≠ ekvivalent | Roƒçn√≠ |
|--------|-------------------|-------|
| **LiquiMixer PRO** | ~5 CZK/mƒõs√≠c (~0.20 EUR) | 59 CZK / 2.40 EUR |
| **e-liquid-recipes.com Patreon** | 10.50 EUR/mƒõs√≠c | ~126 EUR/rok |

### Z√°vƒõr cenov√© anal√Ωzy

**LiquiMixer je v√Ωraznƒõ levnƒõj≈°√≠** ne≈æ jedin√° placen√° konkurence (ELR Patreon):
- LiquiMixer: **2.40 EUR/rok**
- ELR: **126 EUR/rok** (pouze za odstranƒõn√≠ reklam!)

Vƒõt≈°ina konkurence je **zcela zdarma**, ale:
- Nenab√≠z√≠ steeping reminders
- Nem√° PWA/mobiln√≠ podporu
- Nepodporuje 31 jazyk≈Ø
- Nepoƒç√≠t√° se slo≈æen√≠m p≈ô√≠chut√≠

**Doporuƒçen√≠:**
- St√°vaj√≠c√≠ cena 59 CZK/rok je velmi konkurenceschopn√°
- S p≈ôid√°n√≠m komunity recept≈Ø a hodnocen√≠ bude hodnota je≈°tƒõ vy≈°≈°√≠
- P≈ô√≠padn√© nav√Ω≈°en√≠ ceny (nap≈ô. 99 CZK/rok) by bylo st√°le v√Ωraznƒõ pod ELR
